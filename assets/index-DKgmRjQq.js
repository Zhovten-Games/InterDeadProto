(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class Yt{constructor(){this.registry=new Map}register(e,t,s={}){const i=Number.isInteger(s.priority)?s.priority:0,r=Array.isArray(s.deps)?s.deps.slice():[];this.registry.set(e,{factory:t,instance:void 0,priority:i,deps:r})}resolve(e){const t=this.registry.get(e);if(!t)throw new Error(`Dependency ${e} not registered`);return t.instance===void 0&&(t.instance=t.factory()),t.instance}getRegistrations(){return Array.from(this.registry.entries()).map(([e,t])=>({name:e,...t}))}}class Ae{boot(){throw new Error("Method boot must be implemented by logging adapters.")}dispose(){throw new Error("Method dispose must be implemented by logging adapters.")}debug(e){throw new Error("Method debug must be implemented by logging adapters.")}info(e){throw new Error("Method info must be implemented by logging adapters.")}warn(e){throw new Error("Method warn must be implemented by logging adapters.")}error(e){throw new Error("Method error must be implemented by logging adapters.")}}class L extends Ae{boot(){}dispose(){}debug(){}info(){}warn(){}error(){}}const Kt={subscribe:()=>{},unsubscribe:()=>{},emit:()=>{}};class Qt{constructor(e,t=Kt,s=null){this.container=e,this.bus=t,this.logger=s??new L,this.booted=[]}async bootAll(){const e=this.container.getRegistrations();e.sort((i,r)=>i.priority-r.priority);const t=new Map(e.map(i=>[i.name,i])),s=new Set;for(;t.size>0;){let i=!1;for(const[r,a]of Array.from(t.entries()))if((a.deps||[]).every(l=>s.has(l))){const l=this.container.resolve(r);l&&typeof l.boot=="function"&&(this.logger?.info?.(`Booting ${r}`),await l.boot(),typeof l.dispose=="function"&&this.booted.push(l),this.bus.emit({type:"BOOT_STEP",name:r})),t.delete(r),s.add(r),i=!0}if(!i){const r=Array.from(t.values()).map(a=>a.name).join(", ");throw new Error(`Unresolved dependencies: ${r}`)}}this.bus.emit({type:"BOOT_COMPLETE"})}async disposeAll(){for(const e of this.booted.reverse())try{await e.dispose()}catch(t){this.logger?.error(t?.message||t)}this.booted=[]}}const z=Object.freeze({ALL:"all",BATCH:"batch"}),Ne=Object.freeze({mode:z.ALL,batchSize:3}),Xt=100,Ze={LOG_LEVEL:"debug",chatDisplay:{...Ne},chatMessageBatchSize:Ne.batchSize,chatScrollStep:Xt,defaultGhost:"guide",controlPanel:{showEmojiDrum:!1},launcher:{visibility:"auth-gated"},reset:{initialScreen:"welcome",clearDatabase:!0,clearStorage:!0},ai:{cocoSsdFallbackUrl:"https://storage.googleapis.com/tfjs-models/savedmodel/ssdlite_mobilenet_v2/model.json",warmupAfterAuth:!0,warmupEnabled:!0,warmupWithDummyFrame:!0}};class et{constructor({documentRef:e=typeof document<"u"?document:null,moduleUrl:t=import.meta.url,locationUrl:s=typeof window<"u"?window.location.href:null}={}){this.documentRef=e,this.moduleUrl=t,this.locationUrl=s,this._cachedBaseUrl=null}getBaseUrl(){if(this._cachedBaseUrl)return this._cachedBaseUrl;const e=this._resolveFromEmbedMarker(),t=this._resolveFromModuleUrl(),s=this._resolveFromLocationUrl(),i="assets/";return this._cachedBaseUrl=this._normalizeBaseUrl(e||t||s||i),this._cachedBaseUrl}resolve(e=""){if(!e)return this.getBaseUrl();if(this._isAbsolute(e))return e;const t=this.getBaseUrl(),s=this._normalizeBaseUrl(t),i=this._stripAssetsPrefix(e).replace(/^\/+/,"");return`${s}${i}`}_resolveFromEmbedMarker(){if(!this.documentRef)return null;const e=[];if(this.documentRef.currentScript&&e.push(this.documentRef.currentScript),this.documentRef.querySelector){const t=this.documentRef.querySelector("[data-interdead-assets-base]");t&&e.push(t)}for(const t of e){const s=t.getAttribute?.("data-interdead-assets-base"),i=t.dataset?.interdeadAssetsBase,r=s||i;if(r&&r.trim())return r.trim()}return null}_resolveFromModuleUrl(){if(!this.moduleUrl)return null;const e=new URL(this.moduleUrl),t="/assets/",s=e.pathname.lastIndexOf(t);if(s!==-1){const a=e.pathname.slice(0,s+t.length);return e.origin==="null"?a:`${e.origin}${a}`}const r=e.pathname.lastIndexOf("src/");if(r!==-1){const a=e.pathname.slice(0,r+1);return e.origin==="null"?`${a}assets/`:`${e.origin}${a}assets/`}return null}_resolveFromLocationUrl(){if(!this.locationUrl)return null;try{const e=new URL(this.locationUrl),t=e.pathname||"/",s=t.endsWith("/"),r=(t.split("/").filter(Boolean).pop()||"").includes("."),a=s?t:r?t.slice(0,t.lastIndexOf("/")+1):`${t}/`;return e.origin==="null"?`${a}assets/`:`${e.origin}${a}assets/`}catch{return null}}_normalizeBaseUrl(e){if(!e)return"assets/";const t=e.endsWith("/")?e:`${e}/`;if(this._isAbsolute(t)||t.startsWith("/"))return t;const s=this._resolveFromModuleUrl();if(!s)return t;if(t==="assets/"&&s.endsWith("/assets/"))return s;try{return new URL(t,s).toString()}catch{return t}const i=this._resolveFromLocationUrl();if(i){if(t==="assets/"&&i.endsWith("/assets/"))return i;try{return new URL(t,i).toString()}catch{}}return t}_stripAssetsPrefix(e){return e.startsWith("/assets/")?e.slice(8):e.startsWith("assets/")?e.slice(7):e}_isAbsolute(e){return/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(e)}}class tt{constructor(e=null){this.resolver=e||new et}mapConfig(e){return this._mapValue(e)}_mapValue(e){return Array.isArray(e)?e.map(t=>this._mapValue(t)):e&&typeof e=="object"?Object.fromEntries(Object.entries(e).map(([t,s])=>[t,this._mapValue(s)])):typeof e=="string"?this._mapString(e):e}_mapString(e){if(e.startsWith("/assets/")||e.startsWith("assets/")){const t=e.replace(/^\/?assets\//,"");return this.resolver.resolve(t)}return e}}const Re=new et;Re.getBaseUrl();const A=o=>Re.resolve(o);new tt(Re);const Jt={id:"guide",avatar:A("images/artifacts/guide/NIRO.webp"),reactions:{"guide-intro":["üôÇ"],"guide-camera":["üôÇ"],"guide-outro":["ü§î"]},sounds:{message:{ghost:A("audio/ghost_effect.mp3"),user:A("audio/type_sound.mp3")},detection:A("audio/ghost_effect.mp3")},stages:[{id:"guide-intro",reactions:["üôÇ"],reactionPreset:"üôÇ",event:{id:"intro",autoStart:!0,messages:[{author:"ghost",text:"guide.stage1"},{author:"user",text:"guide.user.reply1"},{author:"ghost",text:"guide.stage2"},{author:"user",text:"guide.user.reply2"},{author:"ghost",text:"guide.stage3"},{author:"user",text:"guide.user.reply3"}]}},{id:"guide-camera",reactions:["üôÇ"],reactionPreset:"üôÇ",event:{id:"camera-stage",autoStart:!0,messages:[{author:"ghost",text:"guide.stage4"}]},quest:{id:"find-person",type:"camera",requirement:{type:"object",target:"person"},overlay:{mode:"detected-only",x:0,y:0}}},{id:"guide-outro",reactions:["ü§î"],reactionPreset:"ü§î",event:{id:"outro",autoStart:!0,messages:[{author:"user",text:"guide.user.reply4"},{author:"ghost",text:"guide.stage5"},{author:"user",text:"guide.user.reply5"},{author:"ghost",text:"guide.stage6",effects:{reactionFinale:!0}}]}}],unlock:{requires:[]},messenger:{post:[{type:"always"}],"switch-ghost":[{type:"always"}],"toggle-camera":[{type:"localAuthReady"},{type:"aiReady"}],"reset-data":[{type:"always"}],"scroll-up":[{type:"always"}],"scroll-down":[{type:"always"}]}},st="images/artifacts/nectosphere_node_1",Zt={canvasWidth:1536,canvasHeight:1024,x:0,y:0,width:1536,height:512},es=o=>({...Zt,collage:!1,background:{src:A(`${st}/${o}`)}}),H=(o,e,t)=>({id:o,type:"camera",requirement:{type:"object",target:e},overlay:es(t)}),se=o=>({author:"user",autoGenerated:{targetEmoji:o}}),ts={id:"guest1",displayName:"üåô ‚è∏Ô∏è üíÄ",avatar:A(`${st}/artifact_nectosphere_node.webp`),reactions:{"guest1-handshake":["üôà"],"guest1-bed":["üôà"],"guest1-bottle":["üôà"],"guest1-chair":["üôà"],"guest1-clock":["üôà"]},sounds:{message:{ghost:A("audio/ghost_effect.mp3"),user:A("audio/type_sound.mp3")},detection:A("audio/ghost_effect.mp3")},stages:[{id:"guest1-handshake",reactions:["üôà"],reactionPreset:"üôà",event:{id:"handshake",autoStart:!0,messages:[{author:"user",text:"guest1.handshake.user1"},{author:"ghost",text:"guest1.handshake.ghost1"},{author:"user",text:"guest1.handshake.user2"},{author:"ghost",text:"guest1.handshake.ghost2"},{author:"ghost",text:"guest1.request.teddy"}]},quest:H("find-teddy-bear","teddy bear","artifact_1.webp")},{id:"guest1-bed",reactions:["üôà"],reactionPreset:"üôà",event:{id:"bed",autoStart:!0,messages:[{author:"ghost",text:"guest1.request.bed"},se("üõè")]},quest:H("find-bed","bed","artifact_2.webp")},{id:"guest1-bottle",reactions:["üôà"],reactionPreset:"üôà",event:{id:"bottle",autoStart:!0,messages:[{author:"ghost",text:"guest1.request.bottle"},se("üçº")]},quest:H("find-bottle","bottle","artifact_3.webp")},{id:"guest1-chair",reactions:["üôà"],reactionPreset:"üôà",event:{id:"chair",autoStart:!0,messages:[{author:"ghost",text:"guest1.request.chair"},se("ü™ë")]},quest:H("find-chair","chair","artifact_4.webp")},{id:"guest1-clock",reactions:["üôà"],reactionPreset:"üôà",event:{id:"clock",autoStart:!0,messages:[{author:"ghost",text:"guest1.request.clock"},se("üïí")]},quest:H("find-clock","clock","artifact_5.webp")},{id:"guest1-finale",event:{id:"finale",autoStart:!0,messages:[{author:"ghost",text:"guest1.finale.song",effects:{reactionFinale:!0}},{author:"ghost",type:"youtube",youtubeUrl:"https://youtu.be/sw63yEVj4AM",text:"guest1.finale.video"},{author:"ghost",text:"guest1.finale.goodbye"}]}}],unlock:{requires:["guide"],alwaysVisible:!0},messenger:{post:[{type:"always"}],"switch-ghost":[{type:"always"}],"toggle-camera":[{type:"localAuthReady"},{type:"aiReady"}],"reset-data":[{type:"always"}],"scroll-up":[{type:"always"}],"scroll-down":[{type:"always"}]}},ss={};var is={};const re={guide:Jt,guest1:ts},rs=new Set;for(const o of rs)re[o]&&delete re[o];const as=typeof window<"u"&&window.APP_SPIRIT||ss?.VITE_APP_SPIRIT||typeof process<"u"&&is.APP_SPIRIT||Ze.defaultGhost,ns=re[as]||{},it=re,J={...Ze,...ns};class rt{subscribe(e){throw new Error("Method subscribe must be implemented by event bus adapters.")}unsubscribe(e){throw new Error("Method unsubscribe must be implemented by event bus adapters.")}emit(e){throw new Error("Method emit must be implemented by event bus adapters.")}}class at{constructor(e=null){this.subscribers=[],this.logger=e??new L}subscribe(e){if(typeof e!="function")throw new TypeError("Handler must be a function");this.subscribers.push(e)}unsubscribe(e){const t=this.subscribers.indexOf(e);t!==-1&&this.subscribers.splice(t,1)}emit(e){const t=[...this.subscribers];for(const s of t)try{s(e)}catch(i){this.logger.error(`Observer handler error: ${i?.message||i}`)}}}class os extends rt{constructor(e=new at){super(),this.observer=e}subscribe(e){this.observer.subscribe(e)}unsubscribe(e){this.observer.unsubscribe(e)}emit(e){this.observer.emit(e)}}class ls{create(e=new at){return new os(e)}}const Be={debug:0,info:1,warn:2,error:3};class cs extends Ae{constructor(e="debug"){super(),this.level=String(e).toLowerCase(),this.booted=!1}async boot(){this.booted=!0}async dispose(){this.booted=!1}shouldLog(e){return Be[e]>=Be[this.level]}format(e,t){return`[${new Date().toISOString()}] [${e.toUpperCase()}] ${t}`}debug(e){this.shouldLog("debug")&&console.log(this.format("debug",e))}info(e){this.shouldLog("info")&&console.log(this.format("info",e))}warn(e){this.shouldLog("warn")&&console.warn(this.format("warn",e))}error(e){this.shouldLog("error")&&console.error(this.format("error",e))}}const D={debug:0,info:1,warn:2,error:3};class hs extends Ae{constructor(e="debug",t){super(),this.level=e.toLowerCase(),this.bus=t,this._evtHandler=s=>this._handleEvent(s),this._windowErrorHandler=s=>this._handleError(s?.error||s),this._rejectionHandler=s=>this._handleError(s?.reason||s)}boot(){this.bus&&this.bus.subscribe(this._evtHandler),typeof window<"u"&&(window.addEventListener("error",this._windowErrorHandler),window.addEventListener("unhandledrejection",this._rejectionHandler))}dispose(){this.bus&&this.bus.unsubscribe(this._evtHandler),typeof window<"u"&&(window.removeEventListener("error",this._windowErrorHandler),window.removeEventListener("unhandledrejection",this._rejectionHandler))}_handleEvent(e){if(!e||e.type!=="log")return;const t=(e.level||"info").toLowerCase();if(D[t]===void 0||D[t]<D[this.level])return;const s=e.message||"";(this[t]||this.info).call(this,s)}_handleError(e){const t=e?.stack||e?.message||String(e);this.error(t),this.bus&&this.bus.emit({type:"log",level:"error",message:t})}debug(e){D.debug>=D[this.level]&&console.log(`[DEBUG] ${e}`)}info(e){D.info>=D[this.level]&&console.log(`[INFO] ${e}`)}warn(e){D.warn>=D[this.level]&&console.warn(`[WARN] ${e}`)}error(e){console.error(`[ERROR] ${e}`)}}class ds{constructor(e,t){this.bus=e,this.logger=t,this._handler=s=>this._onEvent(s)}boot(){this.bus?.subscribe(this._handler)}dispose(){this.bus?.unsubscribe(this._handler)}_onEvent(e){if(!e||e.type!=="error")return;const t=e.error?.message||e.message||String(e.error||e);this.logger?.error(t)}}class us{load(e){throw new Error("Method load must be implemented by persistence adapters.")}save(e,t){throw new Error("Method save must be implemented by persistence adapters.")}remove(e){throw new Error("Method remove must be implemented by persistence adapters.")}clear(){throw new Error("Method clear must be implemented by persistence adapters.")}}class gs extends us{constructor(e=typeof localStorage<"u"?localStorage:null){super(),this.storage=e}load(e){try{if(!this.storage)return null;const t=this.storage.getItem(e);if(t===null)return null;try{return JSON.parse(t)}catch{return t}}catch{return null}}save(e,t){try{if(this.storage){const s=JSON.stringify(t);this.storage.setItem(e,s)}}catch{}}remove(e){try{this.storage&&this.storage.removeItem(e)}catch{}}clear(){try{this.storage?.clear()}catch{}}}class ps{async load(e){throw new Error("Method load must be implemented by config loader adapters.")}}class ms extends ps{constructor(e=null,t=globalThis.fetch){super(),this.logger=e,this.fetch=t}async load(e){try{const t=await this.fetch(e);if(!t.ok){const s=new Error(`Failed to fetch ${e}: ${t.status} ${t.statusText}`);throw this.logger?.error(s.message),s}return t.json()}catch(t){throw this.logger?.error(t?.message||String(t)),t}}}class fs{async loadTemplate(e){throw new Error("Method loadTemplate must be implemented by template renderer adapters.")}fill(e,t){throw new Error("Method fill must be implemented by template renderer adapters.")}async render(e,t){throw new Error("Method render must be implemented by template renderer adapters.")}async renderSection(e,t,s){throw new Error("Method renderSection must be implemented by template renderer adapters.")}}class _s{constructor({documentRef:e=typeof document<"u"?document:null,moduleUrl:t=null}={}){this.documentRef=e,this.moduleUrl=t,this._cachedBaseUrl=null}getBaseUrl(){if(this._cachedBaseUrl)return this._cachedBaseUrl;const e=this._resolveFromEmbedMarker(),t=this._resolveFromModuleUrl(),s="src/presentation/templates/";return this._cachedBaseUrl=this._normalizeBaseUrl(e||t||s),this._cachedBaseUrl}resolve(e=""){if(!e)return this.getBaseUrl();if(this._isAbsolute(e))return e;const t=this.getBaseUrl(),s=this._normalizeBaseUrl(t),i=this._stripTemplatesPrefix(e).replace(/^\/+/,"");return`${s}${i}`}normalizeBaseUrl(e){return this._normalizeBaseUrl(e)}_resolveFromEmbedMarker(){if(!this.documentRef)return null;const e=[];if(this.documentRef.currentScript&&e.push(this.documentRef.currentScript),this.documentRef.querySelector){const t=this.documentRef.querySelector("[data-interdead-templates-base]");t&&e.push(t)}for(const t of e){const s=t.getAttribute?.("data-interdead-templates-base"),i=t.dataset?.interdeadTemplatesBase,r=s||i;if(r&&r.trim())return r.trim()}return null}_resolveFromModuleUrl(){if(!this.moduleUrl)return null;const e=new URL(this.moduleUrl),t="src/presentation/templates/",s=e.pathname.lastIndexOf(t);if(s!==-1){const n=e.pathname.slice(0,s+t.length);return`${e.origin}${n}`}const i="src/",r=e.pathname.lastIndexOf(i);if(r===-1)return null;const a=e.pathname.slice(0,r+i.length);return`${e.origin}${a}presentation/templates/`}_normalizeBaseUrl(e){return e?e.endsWith("/")?e:`${e}/`:"src/presentation/templates/"}_stripTemplatesPrefix(e){return e.startsWith("src/presentation/templates/")?e.slice(28):e.startsWith("src/presentation/templates/")?e.slice(27):e}_isAbsolute(e){return/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(e)}}const nt=o=>new _s({moduleUrl:o}).getBaseUrl();class ys extends fs{constructor(e="src/presentation/templates/",t,s=import.meta.url){super();const i=e||nt(s);this.baseUrl=i.endsWith("/")?i:`${i}/`,this.logger=t}async loadTemplate(e){try{const t=await fetch(`${this.baseUrl}${e}.html`);if(!t.ok)throw new Error(`Template "${e}" not found`);return t.text()}catch(t){throw this.logger?.error(t.message),t}}fill(e,t={}){return e.replace(/\{\{\s*(\w+)\s*\}\}/g,(s,i)=>t[i]!==void 0?t[i]:"")}async render(e,t={}){const s=await this.loadTemplate(e);return this.fill(s,t)}async renderSection(e,t,s={}){try{const i=await this.render(t,s),r=typeof e=="string"?document.querySelector(e):e;return r&&(r.innerHTML=i),i}catch(i){throw this.logger?.error(i.message),i}}}const bs="modulepreload",vs=function(o,e){return new URL(o,e).href},ke={},ot=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),l=n?.nonce||n?.getAttribute("nonce");i=Promise.allSettled(t.map(c=>{if(c=vs(c,s),c in ke)return;ke[c]=!0;const h=c.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(!!s)for(let g=a.length-1;g>=0;g--){const m=a[g];if(m.href===c&&(!h||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":bs,h||(u.as="script"),u.crossOrigin="",u.href=c,l&&u.setAttribute("nonce",l),document.head.appendChild(u),h)return new Promise((g,m)=>{u.addEventListener("load",g),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return i.then(a=>{for(const n of a||[])n.status==="rejected"&&r(n.reason);return e().catch(r)})};class Ss{setLanguage(e){throw new Error("Method setLanguage must be implemented by localisation adapters.")}async translate(e,t){throw new Error("Method translate must be implemented by localisation adapters.")}}class ws extends Ss{constructor(e=null,t=import.meta.url){super();const s=e||this._resolveModuleBasePath(t);this.basePath=this._normalizeBasePath(s),this.cache={},this.language="en"}setLanguage(e){this.language=e}_resolveModuleBasePath(e){return e?new URL("../i18n/locales/",e).href:"src/i18n/locales"}_normalizeBasePath(e){const t="src/i18n/locales";return e?e.replace(/\/$/,""):t}async _loadDomain(e,t){const s=`${this.basePath}/${e}/${t}.json`;if(this.cache[e]=this.cache[e]||{},!this.cache[e][t])try{const i=await import(s,{assert:{type:"json"}});this.cache[e][t]=i.default}catch{this.cache[e][t]={}}return this.cache[e][t]}async translate(e,t="ui"){return(await this._loadDomain(this.language,t))[e]||e}}let v=class extends rt{subscribe(){}unsubscribe(){}emit(){}};const Ue={en:{welcome:"Welcome",continue:"Continue",next:"Next",post:"Post",your_location:"Your Location",detect_location:"Detect Location",detect_location_prompt:"Please detect your current location",detect_location_local:"Local mode","geo.latitude_label":"Lat","geo.longitude_label":"Lng",detection_in_progress:"Detection in progress, waiting for a person‚Ä¶",person_detected:"Person detected!",no_person_detected:"No person detected, try again.",main_title:"Main Screen",main_welcome:"Welcome to the main screen!",import:"Import",export:"Export Profile",capture:"Capture",start_analysis:"Start analysis",create_selfie:"Create a selfie",finish:"Finish",loading:"Loading...",ai_contact_line:"CONTACT ...",ai_loading_status:"AI is loading. The camera will be available after loading.",ai_failed_status:"AI failed to load. Retry?",ai_ready_status:"AI ready.",ai_retry:"Retry",ai_loading_camera:"AI is loading ‚Äî the camera will be available after loading.",ai_failed_camera:"AI failed to load. Retry from the loader.",ai_loading_badge:"AI",launcher_auth_required:"Sign in to open the chat",app_already_open:"Application already open in another tab",searching:"Searching...",checking:"Checking...",object_not_found:"Object not found, please try again."},ru:{welcome:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",continue:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",next:"–î–∞–ª–µ–µ",post:"–ó–∞–ø–∏—Å–∞—Ç—å",your_location:"–í–∞—à–µ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ",detect_location:"–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",detect_location_prompt:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ",detect_location_local:"–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º","geo.latitude_label":"–®–∏—Ä–æ—Ç–∞","geo.longitude_label":"–î–æ–ª–≥–æ—Ç–∞",detection_in_progress:"–ó–∞–ø—É—â–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è, –æ–∂–∏–¥–∞–µ–º —á–µ–ª–æ–≤–µ–∫–∞‚Ä¶",person_detected:"–ß–µ–ª–æ–≤–µ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!",no_person_detected:"–ß–µ–ª–æ–≤–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",main_title:"–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω",main_welcome:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!",import:"–ò–º–ø–æ—Ä—Ç",export:"–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è",capture:"–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ",start_analysis:"–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑",create_selfie:"–°–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏",finish:"–ó–∞–≤–µ—Ä—à–∏—Ç—å",loading:"–ó–∞–≥—Ä—É–∑–∫–∞...",ai_contact_line:"CONTACT ...",ai_loading_status:"–ò–ò –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ö–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.",ai_failed_status:"–ò–ò –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å?",ai_ready_status:"–ò–ò –≥–æ—Ç–æ–≤.",ai_retry:"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å",ai_loading_camera:"–ò–ò –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚Äî –∫–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.",ai_failed_camera:"–ò–ò –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –≤ –ª–æ–∞–¥–µ—Ä–µ.",ai_loading_badge:"–ò–ò",launcher_auth_required:"–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç",app_already_open:"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ",searching:"–ü–æ–∏—Å–∫...",checking:"–ü—Ä–æ–≤–µ—Ä–∫–∞...",object_not_found:"–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."},uk:{welcome:"–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!",continue:"–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",next:"–î–∞–ª—ñ",post:"–ó–∞–ø–∏—Å–∞—Ç–∏",your_location:"–í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è",detect_location:"–í–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è",detect_location_prompt:"–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–∑–Ω–∞—á—Ç–µ –≤–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è",detect_location_local:"–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º","geo.latitude_label":"–®–∏—Ä–æ—Ç–∞","geo.longitude_label":"–î–æ–≤–≥–æ—Ç–∞",detection_in_progress:"–ó–∞–ø—É—â–µ–Ω–æ –≤–∏—è–≤–ª–µ–Ω–Ω—è, —á–µ–∫–∞—î–º–æ –ª—é–¥–∏–Ω—É‚Ä¶",person_detected:"–õ—é–¥–∏–Ω–∞ –≤–∏—è–≤–ª–µ–Ω–∞!",no_person_detected:"–õ—é–¥–∏–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",main_title:"–ì–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω",main_welcome:"–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω!",import:"–Ü–º–ø–æ—Ä—Ç",export:"–ï–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ—ñ–ª—é",capture:"–ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ",start_analysis:"–ü–æ—á–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑",create_selfie:"–ó—Ä–æ–±–∏—Ç–∏ —Å–µ–ª—Ñ—ñ",finish:"–ó–∞–≤–µ—Ä—à–∏—Ç–∏",loading:"–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...",ai_contact_line:"CONTACT ...",ai_loading_status:"–®–Ü –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è. –ö–∞–º–µ—Ä–∞ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.",ai_failed_status:"–®–Ü –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏?",ai_ready_status:"–®–Ü –≥–æ—Ç–æ–≤–∏–π.",ai_retry:"–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏",ai_loading_camera:"–®–Ü –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è ‚Äî –∫–∞–º–µ—Ä–∞ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.",ai_failed_camera:"–®–Ü –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è. –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å —Å–ø—Ä–æ–±—É –≤ –ª–æ–∞–¥–µ—Ä—ñ.",ai_loading_badge:"–®–Ü",launcher_auth_required:"–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç",app_already_open:"–ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ",searching:"–ü–æ—à—É–∫...",checking:"–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...",object_not_found:"–û–±'—î–∫—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–≤—Ç–æ—Ä—ñ—Ç—å —Å–ø—Ä–æ–±—É."},ja:{welcome:"„Çà„ÅÜ„Åì„Åù",continue:"Á∂ö„Åë„Çã",next:"Ê¨°„Å∏",post:"ÊäïÁ®ø",your_location:"ÁèæÂú®Âú∞",detect_location:"‰ΩçÁΩÆ„ÇíÊ§úÂá∫",detect_location_prompt:"ÁèæÂú®Âú∞„ÇíÊ§úÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ",detect_location_local:"„É≠„Éº„Ç´„É´„É¢„Éº„Éâ","geo.latitude_label":"Á∑ØÂ∫¶","geo.longitude_label":"ÁµåÂ∫¶",detection_in_progress:"Ê§úÂá∫‰∏≠‚Ä¶‰∫∫„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ",person_detected:"‰∫∫Áâ©„ÇíÊ§úÂá∫„Åó„Åæ„Åó„ÅüÔºÅ",no_person_detected:"‰∫∫Áâ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",main_title:"„É°„Ç§„É≥ÁîªÈù¢",main_welcome:"„É°„Ç§„É≥ÁîªÈù¢„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ",import:"„Ç§„É≥„Éù„Éº„Éà",export:"„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÊõ∏„ÅçÂá∫„Åô",capture:"ÊíÆÂΩ±",start_analysis:"Ëß£Êûê„ÇíÈñãÂßã",create_selfie:"„Çª„É´„Éï„Ç£„Éº„Çí‰ΩúÊàê",finish:"ÂÆå‰∫Ü",loading:"Ë™≠„ÅøËæº„Åø‰∏≠...",ai_contact_line:"CONTACT ...",ai_loading_status:"AI„ÇíË™≠„ÅøËæº„Åø‰∏≠„Åß„Åô„ÄÇË™≠„ÅøËæº„ÅøÂæå„Å´„Ç´„É°„É©„ÅåÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ",ai_failed_status:"AI„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Åæ„Åô„ÅãÔºü",ai_ready_status:"AI„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ",ai_retry:"ÂÜçË©¶Ë°å",ai_loading_camera:"AI„ÇíË™≠„ÅøËæº„Åø‰∏≠ ‚Äî Ë™≠„ÅøËæº„ÅøÂæå„Å´„Ç´„É°„É©„ÅåÂà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ",ai_failed_camera:"AI„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Éº„ÉÄ„Éº„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",ai_loading_badge:"AI",launcher_auth_required:"„ÉÅ„É£„ÉÉ„Éà„ÇíÈñã„Åè„Å´„ÅØ„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ",app_already_open:"„Ç¢„Éó„É™„ÅØÂà•„ÅÆ„Çø„Éñ„ÅßÊó¢„Å´Èñã„Åã„Çå„Å¶„ÅÑ„Åæ„Åô",searching:"Ê§úÁ¥¢‰∏≠...",checking:"Á¢∫Ë™ç‰∏≠...",object_not_found:"ÂØæË±°„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ"}};class Es{async boot(){throw new Error("Method boot must be implemented by language adapters.")}dispose(){throw new Error("Method dispose must be implemented by language adapters.")}async addGhostLocales(e){throw new Error("Method addGhostLocales must be implemented by language adapters.")}setLanguage(e){throw new Error("Method setLanguage must be implemented by language adapters.")}async applyLanguage(e){throw new Error("Method applyLanguage must be implemented by language adapters.")}async translate(e,t){throw new Error("Method translate must be implemented by language adapters.")}}const As=6,qe=o=>String(o).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),Rs=["emoji_protocol.mode_label","emoji_protocol.intent_label","emoji_protocol.target_label","emoji_protocol.range_label","emoji_protocol.policy_label","emoji_protocol.output_label"],lt=o=>String(o||"").split(/\r?\n/).map(e=>e.trim()).filter(e=>e!==""),Ls=o=>lt(o).length===As,Ts=(o,e=[])=>{const t=Array.isArray(o)?o:[],s=Array.isArray(e)?e:[];return t.map((i,r)=>{const a=qe(s[r]||""),n=qe(i);return`
        <span class="dialog__protocol-line">
          <span class="dialog__protocol-label">${a}</span>
          <span class="dialog__protocol-value">${n}</span>
        </span>
      `}).join("")},Cs=/https?:\/\/[^\s<>"']+/g,j=o=>String(o).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");class Is{constructor({linkClass:e="dialog__message-link"}={}){this.linkClass=e}format(e=""){const t=String(e);if(!t)return{html:"",hasLinks:!1};let s="",i=!1,r=0;for(const a of t.matchAll(Cs)){const n=a.index??0,l=a[0]??"";s+=j(t.slice(r,n));const{url:c,trailing:h}=this._splitTrailingPunctuation(l);if(c){const d=j(c);s+=`<a class="${this.linkClass}" href="${d}" target="_blank" rel="noopener noreferrer">${d}</a>`,i=!0}else s+=j(l);h&&(s+=j(h)),r=n+l.length}return s+=j(t.slice(r)),{html:s,hasLinks:i}}_splitTrailingPunctuation(e){let t=e,s="";for(;t&&/[),.!?:;]+$/.test(t);)s=t.slice(-1)+s,t=t.slice(0,-1);return{url:t,trailing:s}}}class Ms extends Es{constructor(e=new v,t=null,s=null){super(),this.bus=e,this.storage=t,this.logger=s??new L,this.localization=new ws,this.current="en",this.locales={...Ue},this.textFormatter=new Is,this._handler=i=>{i&&i.type==="LANGUAGE_CHANGED"&&this.applyLanguage()}}async boot(){this.localization.setLanguage(this.current),this.locales={...Ue},this.storage&&(this.current=this.storage.load("language")||"en"),this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler)}async addGhostLocales(e){try{const s=(await ot(()=>import("./locales-KMsr9kx-.js"),[],import.meta.url)).default||{};for(const i of Object.keys(s))this.locales[i]={...this.locales[i]||{},...s[i]};this.applyLanguage()}catch{this.logger.warn(`No locales for ghost "${e}"`)}}setLanguage(e){this.current=e,this.localization.setLanguage(e),this.storage&&this.storage.save("language",e),this.bus.emit({type:"LANGUAGE_CHANGED",payload:{code:e}})}async applyLanguage(e=document){const t=[];let s=null;e.querySelectorAll("[data-i18n]").forEach(i=>{if(i.dataset.i18nLock==="true")return;const r=i.getAttribute("data-i18n");if(!r)return;const a=this.localization.translate(r,"ui").then(n=>{if(!n)return;const l=i.classList.contains("dialog__message-text"),c=i.classList.contains("dialog__finale-text"),h=l||c;if(i.dataset.emojiProtocol==="true"&&Ls(n))return s||(s=Promise.all(Rs.map(d=>this.localization.translate(d,"ui").catch(()=>d)))),s.then(d=>{l&&(i.classList.add("dialog__message-text--protocol"),i.classList.remove("dialog__message-text--plain"));const p=lt(n);i.innerHTML=Ts(p,d)});if(h&&(i.classList.remove("dialog__message-text--protocol"),i.classList.add("dialog__message-text--plain")),i.dataset.allowLinks==="true"){const{html:d,hasLinks:p}=this.textFormatter.format(n);p?i.innerHTML=d:i.textContent=n;return}i.textContent=n}).catch(n=>{this.logger?.warn?.(`Failed to translate ${r}: ${n?.message||n}`)});t.push(a)}),e.querySelectorAll("[data-i18n-placeholder]").forEach(i=>{const r=i.getAttribute("data-i18n-placeholder");if(!r)return;const a=this.localization.translate(r,"ui").then(n=>{n&&(i.placeholder=n)}).catch(n=>{this.logger?.warn?.(`Failed to translate placeholder ${r}: ${n?.message||n}`)});t.push(a)}),e.querySelectorAll("[data-i18n-title]").forEach(i=>{const r=i.getAttribute("data-i18n-title");if(!r)return;const a=this.localization.translate(r,"ui").then(n=>{n&&(i.title=n)}).catch(n=>{this.logger?.warn?.(`Failed to translate title ${r}: ${n?.message||n}`)});t.push(a)}),e.querySelectorAll("[data-i18n-href]").forEach(i=>{const r=i.getAttribute("data-i18n-href");if(!r)return;const a=this.localization.translate(r,"ui").then(n=>{n&&i.setAttribute("href",n)}).catch(n=>{this.logger?.warn?.(`Failed to translate href ${r}: ${n?.message||n}`)});t.push(a)}),await Promise.all(t)}async translate(e,t="ui"){return this.localization.translate(e,t)}}const Ds=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));let _e;if(typeof window<"u")window.initSqlJs||await new Promise((o,e)=>{const t=document.createElement("script");t.src=new URL(""+new URL("sql-wasm-CZHpDDNI.js",import.meta.url).href,import.meta.url).toString(),t.onload=o,t.onerror=e,document.head.appendChild(t)}),_e=window.initSqlJs;else{const{createRequire:o}=await ot(async()=>{const{createRequire:t}=await Promise.resolve().then(()=>Ds);return{createRequire:t}},void 0,import.meta.url);_e=o(import.meta.url)("sql.js/dist/sql-wasm.js")}const Os=_e;class xs{async boot(){throw new Error("Method boot must be implemented by database adapters.")}async exec(e,t=[]){throw new Error("Method exec must be implemented by database adapters.")}run(e,t=[]){throw new Error("Method run must be implemented by database adapters.")}async get(e,t=[]){throw new Error("Method get must be implemented by database adapters.")}fetchAll(e,t=[]){throw new Error("Method fetchAll must be implemented by database adapters.")}async executeQuery(e,t=[]){throw new Error("Method executeQuery must be implemented by database adapters.")}async saveUser(e){throw new Error("Method saveUser must be implemented by database adapters.")}async loadUser(){throw new Error("Method loadUser must be implemented by database adapters.")}async recordExport(e){throw new Error("Method recordExport must be implemented by database adapters.")}async saveLocation(e){throw new Error("Method saveLocation must be implemented by database adapters.")}async saveSelfie(e){throw new Error("Method saveSelfie must be implemented by database adapters.")}async clearAll(){throw new Error("Method clearAll must be implemented by database adapters.")}}class Ps extends xs{constructor(e=":memory:",t,s,i=null){super(),this.path=e,this.logger=t,this.db=null,this._initSqlJs=s,this.storage=i,this._bootPromise=null}async boot(){return this._bootPromise?this._bootPromise:(this._bootPromise=(async()=>{const e=this._initSqlJs||Os,t=A("libs/db/"),s={locateFile:a=>`${t}${a}`};!this._initSqlJs&&this._isBrowserRuntime()&&(s.wasmBinary=await this._fetchWasmBinary(`${t}sql-wasm.wasm`));const i=await e(s),r=this.storage?.load("sqlite_db");this.db=r?new i.Database(Uint8Array.from(atob(r),a=>a.charCodeAt(0))):new i.Database,typeof this.db.get!="function"&&(this.db.get=(a,n=[])=>{const l=this.db.prepare(a,n),c=l.step()?l.getAsObject():void 0;return l.free(),c}),this.db.exec(`
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        created_at TEXT NOT NULL,
        avatar BLOB
      );
      CREATE TABLE IF NOT EXISTS exports (
        id INTEGER PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        blob BLOB NOT NULL,
        created_at TEXT NOT NULL
      );
      CREATE TABLE IF NOT EXISTS locations (
        id INTEGER PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        lat REAL,
        lng REAL,
        mode TEXT,
        saved_at TEXT NOT NULL
      );
      CREATE TABLE IF NOT EXISTS selfies (
        id INTEGER PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        data BLOB NOT NULL,
        checked INTEGER NOT NULL,
        taken_at TEXT NOT NULL
      );
      CREATE TABLE IF NOT EXISTS posts (
        id INTEGER PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        ghost_type TEXT NOT NULL,
        content TEXT NOT NULL,
        created_at TEXT NOT NULL
      );
      `),this._persist()})(),this._bootPromise)}_isBrowserRuntime(){return typeof window<"u"&&typeof fetch=="function"}async _fetchWasmBinary(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load SQL.js WASM binary: ${t.status} ${t.statusText}`);const s=await t.arrayBuffer();return new Uint8Array(s)}_persist(){if(!this.db)return;const e=this.db.export(),t=this._toBase64(e);this.storage?.save("sqlite_db",t)}_toBase64(e){let t="";for(let i=0;i<e.length;i+=32768){const r=e.subarray(i,i+32768);t+=String.fromCharCode.apply(null,r)}return btoa(t)}exec(e,t=[]){return new Promise((s,i)=>{try{this.db.run(e,t),this._persist(),s()}catch(r){this.logger?.error(r?.message||r),i(r)}})}async get(e,t=[]){try{return this.db.get(e,t)||null}catch(s){throw this.logger?.error(s.message),s}}run(e,t=[]){try{this.db.run(e,t),this._persist()}catch(s){throw this.logger?.error(s.message),s}}executeQuery(e,t=[]){return this.exec(e,t)}fetchAll(e,t=[]){try{const s=this.db.prepare(e,t),i=[];for(;s.step();)i.push(s.getAsObject());return s.free(),i}catch(s){throw this.logger?.error(s.message),s}}async saveUser(e){await this.exec("INSERT INTO users(name, created_at, avatar) VALUES(?, ?, ?)",[e.name,e.created_at,e.avatar||null])}async loadUser(){return await this.get("SELECT * FROM users ORDER BY id DESC LIMIT 1")||null}async recordExport(e){const t=await this.loadUser(),s=t?t.id:null;await this.exec("INSERT INTO exports(user_id, blob, created_at) VALUES(?, ?, ?)",[s,e,new Date().toISOString()])}async saveLocation(e){await this.exec("INSERT INTO locations(user_id, lat, lng, mode, saved_at) VALUES(?,?,?,?,?)",[e.user_id,e.lat,e.lng,e.mode,e.saved_at])}async saveSelfie(e){await this.exec("INSERT INTO selfies(user_id, data, checked, taken_at) VALUES(?,?,?,?)",[e.user_id,e.data,e.checked,e.taken_at])}async clearAll(){await this.exec("DELETE FROM users;"),await this.exec("DELETE FROM posts;"),await this.exec("DELETE FROM locations;"),await this.exec("DELETE FROM selfies;"),await this.exec("DELETE FROM exports;"),await this.exec("DELETE FROM dialog_messages;")}}class Ns{async boot(){throw new Error("Method boot must be implemented by database publishers.")}async registerUser(e){throw new Error("Method registerUser must be implemented by database publishers.")}async publishPost(e,t){throw new Error("Method publishPost must be implemented by database publishers.")}async fetchPosts(e){throw new Error("Method fetchPosts must be implemented by database publishers.")}}class Bs extends Ns{constructor(e,t){super(),this.db=e,this.logger=t}async boot(){this.logger.info("DBPublisher booted")}async registerUser(e){const t=new Date().toISOString();await this.db.exec("INSERT INTO users(name, created_at) VALUES(?,?)",[e,t]),this.logger.info(`User registered: ${e}`)}async publishPost(e,t){const s=new Date().toISOString();await this.db.exec("INSERT INTO posts(user_id, content, created_at) VALUES(?,?,?)",[e,t,s]),this.logger.info(`Post published by user ${e}`)}async fetchPosts(e){return this.db.get("SELECT * FROM posts WHERE user_id = ? ORDER BY created_at DESC",[e])}}class ks{async encrypt(e,t){throw new Error("Method encrypt must be implemented by encryption adapters.")}async decrypt(e,t){throw new Error("Method decrypt must be implemented by encryption adapters.")}}const ct=new TextEncoder,Us=new TextDecoder;async function ht(o,e,t){const s=await crypto.subtle.importKey("raw",ct.encode(o),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!1,t)}async function qs(o,e){const t=crypto.getRandomValues(new Uint8Array(16)),s=crypto.getRandomValues(new Uint8Array(12)),i=await ht(e,t,["encrypt"]),r=new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:s},i,o)),a=new Uint8Array(t.length+s.length+r.length);return a.set(t),a.set(s,t.length),a.set(r,t.length+s.length),a}async function Fs(o,e){const t=o.slice(0,16),s=o.slice(16,28),i=o.slice(28),r=await ht(e,t,["decrypt"]),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},r,i);return new Uint8Array(a)}class Gs extends ks{constructor(e){super(),this.logger=e}async encrypt(e,t){try{const s=ct.encode(JSON.stringify(e));return await qs(s,t)}catch(s){throw this.logger?.error(`Encryption failed: ${s.message}`),s}}async decrypt(e,t){try{const s=await Fs(e,t);return JSON.parse(Us.decode(s))}catch(s){throw this.logger?.error(`Decryption failed: ${s.message}`),s}}}class Hs{async getCurrentLocation(){throw new Error("Method getCurrentLocation must be implemented by geolocation adapters.")}}class js extends Hs{constructor(e,t){super(),this.db=e,this.logger=t}async getCurrentLocation(){try{const e=await this.db.loadUser(),t=e?e.id:null;return await new Promise(s=>{if(!navigator.geolocation){this.db.saveLocation({user_id:t,lat:null,lng:null,mode:"local",saved_at:new Date().toISOString()}),s(null);return}navigator.geolocation.getCurrentPosition(i=>{const r={lat:i.coords.latitude,lng:i.coords.longitude};this.db.saveLocation({...r,user_id:t,mode:"remote",saved_at:new Date().toISOString()}),s(r)},()=>{this.db.saveLocation({user_id:t,lat:null,lng:null,mode:"local",saved_at:new Date().toISOString()}),s(null)})})}catch(e){return this.logger?.error(e.message),null}}}class $s{async startStream(e){throw new Error("Method startStream must be implemented by camera adapters.")}stopStream(){throw new Error("Method stopStream must be implemented by camera adapters.")}pauseStream(){throw new Error("Method pauseStream must be implemented by camera adapters.")}async resumeStream(e){throw new Error("Method resumeStream must be implemented by camera adapters.")}async takeSelfie(){throw new Error("Method takeSelfie must be implemented by camera adapters.")}}class Vs extends $s{constructor(e){super(),this.logger=e,this._stream=null,this._videoEl=null,this._streamStart=null,this._metadataHandler=null}async _initStream(e){if(!navigator.mediaDevices?.getUserMedia)throw this.logger?.error("Camera API not available"),new Error("Camera not available");const t=await navigator.mediaDevices.getUserMedia({video:!0});let s=this._videoEl;s?e&&!e.contains(s)&&e.appendChild(s):(s=document.createElement("video"),s.className="camera__stream",s.autoplay=!0,s.playsInline=!0,e&&e.appendChild(s),this._videoEl=s),s.srcObject=t,await new Promise(i=>{this._metadataHandler=()=>{s.play(),s.removeEventListener("loadedmetadata",this._metadataHandler),this._metadataHandler=null,i()},s.addEventListener("loadedmetadata",this._metadataHandler)}),this._stream=t,this._toggleIndicator(!0),this._toggleRetry(!1)}_stopTracks(){this._stream?.getTracks().forEach(e=>e.stop())}_getContainer(){return this._videoEl?.parentElement?.parentElement||this._videoEl?.parentElement}_toggleIndicator(e){const t=this._getContainer()?.querySelector('[data-js="record-indicator"]');t&&(t.hidden=!e)}_toggleRetry(e){const t=this._getContainer()?.querySelector('[data-js="retry-detection"]');t&&(e?t.classList.remove("retry-detection--hidden"):t.classList.add("retry-detection--hidden"))}async takeSelfie(){try{let e=this._videoEl,t=this._stream;!e||!t?(await this._initStream(),e=this._videoEl,t=this._stream):e.readyState<2&&await new Promise(a=>e.addEventListener("loadeddata",a,{once:!0}));const s=document.createElement("canvas");return s.width=e.videoWidth,s.height=e.videoHeight,s.getContext("2d").drawImage(e,0,0),await new Promise(a=>s.toBlob(a,"image/jpeg"))}catch(e){throw this.logger?.error(e.message),e}}async startStream(e){try{await this._initStream(e),this._streamStart=Date.now(),this.logger?.info?.("Camera stream started")}catch(t){throw this.logger?.error(t.message),t}}stopStream(){try{this._videoEl&&this._metadataHandler&&(this._videoEl.removeEventListener("loadedmetadata",this._metadataHandler),this._metadataHandler=null);const e=this._streamStart?Date.now()-this._streamStart:0;this._toggleIndicator(!1),this._toggleRetry(!1),this._stopTracks(),this._stream=null,this._videoEl?.remove(),this._videoEl=null,this._streamStart=null,this.logger?.info?.(`Camera stream stopped after ${e}ms`)}catch(e){this.logger?.error(e.message)}}pauseStream(){try{this._videoEl?.pause(),this._stopTracks(),this._toggleIndicator(!1),this._toggleRetry(!0)}catch(e){this.logger?.error(e?.message||e)}}async resumeStream(e){try{!this._stream||this._stream.getTracks().every(s=>s.readyState==="ended")?await this._initStream(e||this._videoEl?.parentElement||this._videoEl?.parentElement?.parentElement):(this._videoEl?.play(),this._toggleIndicator(!0),this._toggleRetry(!1))}catch(t){this.logger?.error(t?.message||t)}}}function Fe(o){return new Promise((e,t)=>{const s=document.createElement("script");s.src=o,s.async=!1,s.onload=()=>e(o),s.onerror=()=>t(new Error(`Failed to load ${o}`)),document.head.appendChild(s)})}class Ws{async detectTarget(e,t){throw new Error("Method detectTarget must be implemented by detection adapters.")}}var Ge={};const zs="dev",Ys=o=>{if(!o?.querySelector)return"";const e=o.querySelector("[data-interdead-cache-build-id]"),t=e?.getAttribute?.("data-interdead-cache-build-id")||e?.dataset?.interdeadCacheBuildId||"";return typeof t=="string"?t.trim():""},Ks=o=>{if(!o)return"";const e=o.__CACHE_BUILD_ID__||o.CACHE_BUILD_ID||"";return typeof e=="string"?e.trim():""},Qs=()=>{const o="96b342c098d7156006ae349763d75f7c0c3a9d83";if(o.trim())return o.trim();if(typeof process<"u"){const e=Ge?.CACHE_BUILD_ID||Ge?.VITE_CACHE_BUILD_ID;if(typeof e=="string"&&e.trim())return e.trim()}return""},Xs=({windowRef:o=typeof window<"u"?window:null,documentRef:e=typeof document<"u"?document:null}={})=>{const t=Ks(o);if(t)return t;const s=Ys(e);if(s)return s;const i=Qs();return i||zs},ye=Xs(),$=(o,e=ye)=>{if(!e||typeof o!="string")return o;const t=typeof window<"u"&&window.location?window.location.href:"https://localhost",s=new URL(o,t);return s.searchParams.set("v",e),s.toString()},dt="DUALITY_STARTED",ut="EVENT_STARTED",C="EVENT_MESSAGE_READY",Y="QUEST_STARTED",gt="QUEST_COMPLETED",Js="EVENT_COMPLETED",K="DUALITY_COMPLETED",ae="DUALITY_STAGE_STARTED",Q="DETECTION_SEARCH",ne="DETECTION_DONE",Le="DETECTION_STOPPED",de="AI_STATE_CHANGED",pt="AI_RETRY_REQUESTED",N="BUTTON_STATE_UPDATED",mt="BUTTON_VISIBILITY_UPDATED",Zs="EFFECT_UPDATE_REQUESTED",ei="EFFECT_STYLE_UPDATED",ti="EFFECT_DEFAULTS_SAVED",oe="DIALOG_WIDGET_READY",U="DIALOG_CLEAR",ft="VIEW_RENDER_REQUESTED",_t="VIEW_CAMERA_RENDER_REQUESTED",be="MESSENGER_POSTS_READY",yt="REGISTRATION_NAME_CHANGED",bt="GEO_STATUS_UPDATED",ie="CAMERA_PREVIEW_READY",vt="CAMERA_PREVIEW_CLEARED",ue="APP_RESET_REQUESTED",q="APP_RESET_COMPLETED",St="RESET_OPTIONS_REQUESTED",wt="GHOST_RESET_REQUESTED",si="GHOST_RESET_COMPLETED",Et="GHOST_REBOOT_REQUESTED",ii="GHOST_REBOOT_COMPLETED",At="PROFILE_IMPORT_REQUESTED",Rt="PROFILE_IMPORT_SELECTED",Lt="PROFILE_IMPORT_COMPLETED",Tt="PROFILE_EXPORT_REQUESTED",Ct="PROFILE_EXPORT_CONFIRMED",It="PROFILE_EXPORT_READY",Mt="PROFILE_TRANSFER_FAILED",ri="GHOST_UNLOCKED",Dt="DRUM_LAYOUT_UPDATED",ai="REACTION_REMINDER_READY",Te="REACTION_OVERLAY_REQUESTED",X="REACTION_SELECTED",ve="REACTION_FINALE_STATE_UPDATED",Ot="REACTION_FINALE_RECALCULATE_REQUESTED",xt="DIALOG_AWAITING_INPUT_CHANGED",ni="CHAT_SCROLL_UP",oi="CHAT_SCROLL_DOWN",le="CHAT_LOAD_OLDER",Ce="STATUS_SHOW",Pt="QUEST_ITEM_OVERLAY_READY",Ie="MODAL_SHOW",ce="MODAL_HIDE",he="OVERLAY_SHOW",Nt="MEDIA_OPEN",Me="USER_PROFILE_SAVED",He=Object.freeze([250,750,1500]);class li{constructor({logger:e=console,loadModel:t,retryDelaysMs:s=He,sleep:i=r=>new Promise(a=>setTimeout(a,r))}={}){this.logger=e||console,this.loadModel=t,this.retryDelaysMs=Array.isArray(s)?s:He,this.sleep=i}async loadWithFallback({primaryUrl:e,fallbackUrl:t}){const s=await this._loadPrimary(e);if(s.ok)return{model:s.model,source:e};if(!t||t===e)throw s.error;return this.logger.warn(`Failed to load COCO-SSD model from primary source after retries. Switching to fallback ${t}.`),{model:await this.loadModel(t),source:t}}async _loadPrimary(e){const t=this.retryDelaysMs.length+1;let s=null;for(let i=1;i<=t;i+=1)try{return{ok:!0,model:await this.loadModel(e)}}catch(r){if(s=r,this.logger.warn(`COCO-SSD primary model load failed (attempt ${i}/${t}) for ${e}: ${r?.message||r}`),i>=t)break;const a=this.retryDelaysMs[i-1]??0;await this.sleep(a)}return{ok:!1,error:s||new Error("Unknown model load error")}}}const O=Object.freeze({IDLE:"IDLE",LOADING_RUNTIME:"LOADING_RUNTIME",LOADING_MODEL:"LOADING_MODEL",WARMUP:"WARMUP",READY:"READY",FAILED:"FAILED"});let je=!1;class ci extends Ws{constructor(e,t=null,s=new v,i={}){super(),this.logger=e,this.stateService=t,this.eventBus=s,this.config=i,this.model=null,this.state=O.IDLE,this._bootPromise=null,this._runtimePromise=null,this._modelPromise=null,this.busy=!1}async loadAssets(){if(this._runtimePromise)return this._runtimePromise;const e=$(A("libs/tf.min.js")),t=$(A("libs/coco-ssd.min.js"));this._runtimePromise=Promise.all([Fe(e),Fe(t)]);try{await this._runtimePromise}catch(s){throw this._runtimePromise=null,s}return this._runtimePromise}async loadModel(){if(this.model)return this.model;if(this._modelPromise)return this._modelPromise;if(typeof window.cocoSsd>"u")return this.logger.warn("cocoSsd global not found"),null;this._ensureCacheBuildFetch();const e=$(A("models/coco-ssd/model.json")),t=this.config?.ai?.cocoSsdFallbackUrl||"",s=t?$(t):"";return this._modelPromise=this.loadModelWithFallback(e,s).then(i=>{if(this.model=i?.model||null,this.model){const r=i.source===e?"assets":"fallback CDN";this.logger.info(`COCO-SSD model loaded from ${r}`)}return this.model}).catch(i=>{throw this.model=null,this.logger.error("Failed to load COCO-SSD model.",i),i}).finally(()=>{this._modelPromise=null}),this._modelPromise}async boot({warmup:e=!0,force:t=!1}={}){if(!t&&this.state===O.READY&&this.model)return this.model;if(!t&&this._bootPromise)return this._bootPromise;const s=this._bootSequence({warmup:e,force:t});this._bootPromise=s;try{return await s}finally{this._bootPromise===s&&(this._bootPromise=null)}}async retry(){return this._reset(),this.boot({warmup:!0,force:!0})}getState(){return this.state}_reset(){this.model=null,this._runtimePromise=null,this._modelPromise=null,this._setState(O.IDLE)}async _bootSequence({warmup:e,force:t}){try{if(this._setState(O.LOADING_RUNTIME),(typeof window.cocoSsd>"u"||t)&&await this.loadAssets(),this._setState(O.LOADING_MODEL),await this.loadModel(),!this.model)throw new Error("AI model not loaded");return e&&this.config?.ai?.warmupWithDummyFrame!==!1&&(this._setState(O.WARMUP),await this._warmupModel()),this._setState(O.READY),this.model}catch(s){throw this._setState(O.FAILED,s),s}}async _warmupModel(){if(!this.model)return;const e=document.createElement("canvas");e.width=2,e.height=2,e.getContext("2d")?.fillRect(0,0,e.width,e.height);try{await this.model.detect(e)}catch(s){this.logger?.warn?.("DetectionService warmup failed",s)}}async detectTarget(e,t="person"){if(this.busy)return this.logger?.warn?.("Detection already in progress"),{ok:!1};this.busy=!0;try{if((this.state!==O.READY||!this.model)&&await this.boot({warmup:!1}),!this.model)return{ok:!1};const s=await createImageBitmap(e),i=await this.model.detect(s);this.logger.info(`Detection: ${i.length} objects`);const r=i.find(p=>p.class===t&&p.score>.5),a=!!r;if(this.stateService){const p=this.stateService.presence?.[t];if(a&&!p){this.stateService.setPresence(t,!0);const u=this.stateService?.currentScreen||"registration-camera";this.eventBus.emit({type:"BUTTON_STATE_UPDATED",screen:u})}}if(!a)return{ok:a};const[n,l,c,h]=r.bbox;let d=null;if(Array.isArray(r.segmentation)&&r.segmentation.length){const p=r.segmentation[0],u=[];for(let g=0;g<p.length;g+=2)u.push({x:p[g],y:p[g+1]});d={polygon:u}}else r.mask&&(d={imageData:r.mask});return d||(d={polygon:[{x:n,y:l},{x:n+c,y:l},{x:n+c,y:l+h},{x:n,y:l+h}]}),{ok:a,box:{x:n,y:l,width:c,height:h},mask:d}}finally{this.busy=!1}}async loadModelWithFallback(e,t){return new li({logger:this.logger,loadModel:i=>cocoSsd.load({modelUrl:i})}).loadWithFallback({primaryUrl:e,fallbackUrl:t})}_setState(e,t=null){this.state!==e&&(this.state=e,this.eventBus.emit({type:de,state:e,error:t?String(t.message||t):null}))}_ensureCacheBuildFetch(){if(je||typeof window>"u"||typeof window.fetch!="function")return;const e=window.fetch.bind(window);window.fetch=(t,s)=>{const i=this._withCacheBuildParam(t);return e(i,s)},je=!0,this.logger?.info?.("[AI] Installed cache-build fetch wrapper for AI assets")}_withCacheBuildParam(e){const t=this._resolveFetchUrl(e);return!t||!this._isAiAssetUrl(t)?e:$(t)}_resolveFetchUrl(e){return typeof e=="string"?e:e instanceof Request?e.url:null}_isAiAssetUrl(e){return e.includes("/models/coco-ssd/")||e.includes("/libs/")}}class hi{create(e=0,t=0){throw new Error("Method create must be implemented by canvas factory adapters.")}}class di extends hi{create(e=0,t=0){const s=document.createElement("canvas");return s.width=e,s.height=t,s}}class ui{showNotification(e,t){throw new Error("Method showNotification must be implemented by notification adapters.")}}class gi extends ui{constructor(e=new v){super(),this.bus=e}showNotification(e,t={}){this.bus.emit({type:Ce,message:e,options:t})}}class pi{async detectItems(e){throw new Error("Method detectItems must be implemented by item detection adapters.")}}class mi extends pi{constructor(e){super(),this.logger=e}async detectItems(e){return this.logger.info("ItemDetectionService: detectItems called"),[]}}class fi{constructor({logger:e=console,documentRef:t=null}={}){this.logger=e,this.documentRef=t||(typeof document<"u"?document:null),this._cached=null}resolve(){if(this._cached)return this._cached;const e=this._detectMode(),t={mode:e};return this._cached=t,this.logger?.info?.(`[InterDead][Embed] Resolved embedding mode: ${e}`),t}_detectMode(){const e=this.documentRef;if(!e)return"full";const t=this._findModeMarker(e);return t&&(t.getAttribute("data-interdead-embed")||t.dataset.interdeadEmbed||"").toLowerCase()==="launcher"?"launcher":"full"}_findModeMarker(e){const t=e.querySelector("[data-interdead-embed]");return t||e.querySelector("[data-interdead-launcher]")}}const _i=["camera","microphone"];class yi{constructor({documentRef:e=null,logger:t=console,requiredPermissions:s=null}={}){this.documentRef=e||(typeof document<"u"?document:null),this.logger=t,this.requiredPermissions=Array.isArray(s)&&s.length?[...s]:_i,this._cached=null}resolveAllowAttribute(){if(this._cached)return this._cached;const t=this._resolveAllowList().join("; ");return this._cached=t,this.logger?.info?.(`[InterDead][Embed] Resolved iframe allow list: ${t}`),t}_resolveAllowList(){const e=this._findMarker(),t=e?.getAttribute("data-interdead-allow")||e?.dataset?.interdeadAllow,s=this._parsePermissions(t);return this._mergePermissions(s)}_findMarker(){const e=this.documentRef;return e?e.querySelector("[data-interdead-embed], [data-interdead-launcher]"):null}_parsePermissions(e){if(!e||!e.trim())return[];const t=e.split(/[;,]/).map(s=>s.trim()).filter(Boolean);return[...new Set(t)]}_mergePermissions(e){const t=new Set(this.requiredPermissions);return e.forEach(s=>t.add(s)),[...t]}}class bi{constructor({windowRef:e=null,logger:t=console}={}){this.windowRef=e||(typeof window<"u"?window:null),this.logger=t||console,this.port=null,this.snapshot=null,this._listeners=new Set,this._portUnsubscribe=null,this._handlePortsReady=s=>this._bindFromPorts(s?.detail?.ports)}boot(){this._bindFromPorts(this._getPorts()),this.windowRef&&this.windowRef.addEventListener("interdead:ports-ready",this._handlePortsReady)}dispose(){this.windowRef&&this.windowRef.removeEventListener("interdead:ports-ready",this._handlePortsReady),this._portUnsubscribe?.(),this._portUnsubscribe=null,this._listeners.clear()}hasPort(){return!!this.port}getSnapshot(){if(this.port?.getSnapshot)try{return this.port.getSnapshot()}catch(e){this.logger?.warn?.("[InterDead][Embed] Failed to read auth snapshot",e)}return this.snapshot}isAuthenticated(){return this.getSnapshot()?.status==="authenticated"}onChange(e){return typeof e!="function"?()=>{}:(this._listeners.add(e),()=>this._listeners.delete(e))}_getPorts(){if(!this.windowRef)return null;const e=this.windowRef.InterdeadPorts||null;return e||this._getParentPorts()}_getParentPorts(){if(!this.windowRef||this.windowRef.parent===this.windowRef)return null;try{return this.windowRef.parent?.InterdeadPorts||null}catch(e){return this.logger?.warn?.("[InterDead][Embed] Unable to access parent ports",e),null}}_bindFromPorts(e){const t=e?.authVisibility||null;if(t!==this.port){if(this._portUnsubscribe?.(),this._portUnsubscribe=null,this.port=t,!this.port){this.logger?.info?.("[InterDead][Embed] Auth visibility port missing"),this._emit(this.snapshot);return}this.logger?.info?.("[InterDead][Embed] Auth visibility port connected"),this.snapshot=this.port.getSnapshot?.()||null,this._emit(this.snapshot),this.port.onChange&&(this._portUnsubscribe=this.port.onChange(s=>{this.snapshot=s,this._emit(s)}))}}_emit(e){this._listeners.forEach(t=>t(e))}}class vi{constructor({windowRef:e=null,documentRef:t=null,logger:s=console}={}){this.windowRef=e||(typeof window<"u"?window:null),this.documentRef=t||(typeof document<"u"?document:null),this.logger=s||console,this._internal=null}open(e){const t=this._getPort();if(t?.open)try{t.open(e);return}catch(s){this.logger?.warn?.("[InterDead][Embed] Host modal open failed",s)}this._openInternal(e)}close(){const e=this._getPort();if(e?.close)try{e.close();return}catch(t){this.logger?.warn?.("[InterDead][Embed] Host modal close failed",t)}this._closeInternal()}_getPort(){if(!this.windowRef)return null;const e=this.windowRef.InterdeadPorts?.modal;if(e)return e;if(this.windowRef.parent&&this.windowRef.parent!==this.windowRef)try{return this.windowRef.parent?.InterdeadPorts?.modal||null}catch(t){this.logger?.warn?.("[InterDead][Embed] Unable to access parent modal port",t)}return null}_openInternal(e){if(!this.documentRef)return;this._internal||(this._internal=this._createInternalModal());const{overlay:t,content:s}=this._internal;e&&s.firstChild!==e&&(s.innerHTML="",s.appendChild(e)),t.classList.add("interdead-launcher-modal--visible")}_closeInternal(){this._internal&&this._internal.overlay.classList.remove("interdead-launcher-modal--visible")}_createInternalModal(){const e=this.documentRef.createElement("div");e.className="interdead-launcher-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true");const t=this.documentRef.createElement("div");return t.className="interdead-launcher-modal__content",e.appendChild(t),e.addEventListener("click",s=>{s.target===e&&this._closeInternal()}),this.documentRef.body.appendChild(e),{overlay:e,content:t}}}class Si{constructor({container:e,bootManager:t,eventBus:s,logger:i,windowRef:r=null}={}){this.container=e,this.bootManager=t,this.eventBus=s,this.logger=i,this.windowRef=r||(typeof window<"u"?window:null)}async boot(){this.windowRef&&this.windowRef.addEventListener("beforeunload",()=>{this.bootManager.disposeAll()}),this.container.resolve("Logging").boot(),await this.container.resolve("Loader").load(async()=>{await this.bootManager.bootAll();const e=this.container.resolve("ButtonVisibilityService");e.setScreenVisibility("registration-camera","toggle-messenger",!1),e.setScreenVisibility("camera","toggle-messenger",!1),this.container.resolve("ResetService").boot(),this.container.resolve("GlobalViewPresenter").boot(),await this.container.resolve("ViewService").boot(),await this.container.resolve("ViewAdapter").boot(),await this._restoreState()})}async _restoreState(){const e=this.container.resolve("IPersistence"),t=this.container.resolve("DatabaseService");let s=e?.load("userId"),i=e?.load("captured")===!0;if(!s||!i)try{const a=await t.loadUser();a?.id&&a?.avatar&&(s=s||String(a.id),i=i||!!a.avatar,e?.save?.("userId",String(a.id)),e?.save?.("captured",!0))}catch{}const r=this.container.resolve("StateService");s&&i?(r?.markCaptured?.(),r?.setLocalAuthReady?.(!0),this.container.resolve("GhostService"),this.container.resolve("PostsService"),this.eventBus.emit({type:"SCREEN_CHANGE",screen:"messenger"})):s?(await t.clearAll?.(),e.remove?.("userId"),e.remove?.("captured"),r?.setLocalAuthReady?.(!1),this.eventBus.emit({type:"SCREEN_CHANGE",screen:"registration"})):(r?.setLocalAuthReady?.(!1),this.eventBus.emit({type:"SCREEN_CHANGE",screen:"welcome"}))}}class wi{constructor({container:e,windowRef:t=null}={}){this.container=e,this.windowRef=t||(typeof window<"u"?window:null)}async boot(){this.container.resolve("Logging").boot(),await this.container.resolve("LanguageService").boot?.();const t=this.container.resolve("ChatLauncherService");await t.boot?.(),this.container.resolve("AiWarmupService").boot?.(),this.windowRef&&this.windowRef.addEventListener("beforeunload",()=>t.dispose?.())}}class Ei{constructor({windowRef:e=null,logger:t=console,embeddingResolver:s=null}={}){this.windowRef=e||(typeof window<"u"?window:null),this.logger=t||console,this.embeddingResolver=s}async boot(){if(this._shouldRegister()&&this.windowRef?.navigator?.serviceWorker)try{const e=new URL("sw.js",this.windowRef.location.href);e.searchParams.set("v",ye),await this.windowRef.navigator.serviceWorker.register(e.toString()),this.logger?.info?.(`[SW] Registered with build id ${ye}`)}catch(e){this.logger?.warn?.(`[SW] Registration failed: ${e?.message||e}`)}}_shouldRegister(){return this.embeddingResolver?.resolve?.()?.mode!=="launcher"}}class Ai{constructor(e){this.context=e}register(){const{container:e,config:t}=this.context,s=new ls,i=s.create();this.context.eventBusFactory=s,this.context.eventBus=i,e.register("EventBusFactory",()=>s,{priority:1}),e.register("IEventBus",()=>i,{priority:5}),e.register("IPersistence",()=>new gs,{priority:6}),e.register("Logger",()=>new cs(t.LOG_LEVEL),{priority:10}),e.register("Logging",()=>new hs(t.LOG_LEVEL,e.resolve("IEventBus")),{priority:15}),e.register("ErrorManager",()=>new ds(e.resolve("IEventBus"),e.resolve("Logging")),{priority:16}),e.register("IConfigLoader",()=>new ms(e.resolve("Logging")),{priority:35}),e.register("TemplateService",()=>new ys(nt(import.meta.url),e.resolve("Logger"),import.meta.url),{priority:40}),e.register("LanguageService",()=>new Ms(e.resolve("IEventBus"),e.resolve("IPersistence"),e.resolve("Logging")),{priority:50}),e.register("DatabaseService",()=>new Ps(":memory:",e.resolve("Logger"),void 0,e.resolve("IPersistence")),{priority:20}),e.register("DBPublisher",()=>new Bs(e.resolve("DatabaseService"),e.resolve("Logger")),{priority:21}),e.register("IEncryption",()=>new Gs(e.resolve("Logger")),{priority:70}),e.register("GeoService",()=>new js(e.resolve("DatabaseService"),e.resolve("Logger")),{priority:90}),e.register("CameraService",()=>new Vs(e.resolve("Logger")),{priority:100}),e.register("DetectionService",()=>new ci(e.resolve("Logger"),e.resolve("StateService"),e.resolve("IEventBus"),t),{priority:110}),e.register("ICanvasFactory",()=>new di,{priority:109}),e.register("NotificationManager",()=>new gi(e.resolve("IEventBus")),{priority:113}),e.register("ItemDetectionService",()=>new mi(e.resolve("Logger")),{priority:111}),e.register("EmbeddingModeResolver",()=>new fi({logger:e.resolve("Logger"),documentRef:typeof document<"u"?document:null}),{priority:7}),e.register("EmbedPermissionsResolver",()=>new yi({logger:e.resolve("Logger"),documentRef:typeof document<"u"?document:null}),{priority:7}),e.register("AuthVisibilityAdapter",()=>new bi({windowRef:typeof window<"u"?window:null,logger:e.resolve("Logger")}),{priority:8}),e.register("HostModalAdapter",()=>new vi({windowRef:typeof window<"u"?window:null,documentRef:typeof document<"u"?document:null,logger:e.resolve("Logger")}),{priority:9}),e.register("FullAppBootstrapper",()=>new Si({container:e,bootManager:e.resolve("BootManager"),eventBus:e.resolve("IEventBus"),logger:e.resolve("Logger"),windowRef:typeof window<"u"?window:null}),{priority:12}),e.register("ServiceWorkerRegistrar",()=>new Ei({windowRef:typeof window<"u"?window:null,logger:e.resolve("Logger"),embeddingResolver:e.resolve("EmbeddingModeResolver")}),{priority:11}),e.register("LauncherBootstrapper",()=>new wi({container:e,windowRef:typeof window<"u"?window:null}),{priority:13})}}let Ri=class{constructor(e,t,s="",i=null){this.eventBus=e,this.persistence=t,this.id=s,this.started=!1,this.completed=!1,this.logger=i??new L}start(){this.started=!0,this.eventBus?.emit({type:ut,id:this.id}),this.logger.info(`Event started: ${this.id}`)}complete(){this.completed=!0,this.eventBus?.emit({type:Js,id:this.id}),this.persistence?.save?.(`event:${this.id}`,this.serializeState()),this.logger.info(`Event completed: ${this.id}`)}serializeState(){return{id:this.id,started:this.started,completed:this.completed}}};class Li{constructor(e,t,s="",i=null){this.eventBus=e,this.persistence=t,this.id=s,this.started=!1,this.completed=!1,this.logger=i??new L}start(){this.started=!0,this.eventBus?.emit({type:Y,id:this.id}),this.persistence?.save?.(`quest:${this.id}`,this.serializeState()),this.logger.info(`Quest started: ${this.id}`)}ready(){this.eventBus?.emit({type:Y,id:this.id})}complete(){this.completed=!0,this.eventBus?.emit({type:gt,id:this.id}),this.persistence?.save?.(`quest:${this.id}`,this.serializeState()),this.logger.info(`Quest completed: ${this.id}`)}serializeState(){return{id:this.id,started:this.started,completed:this.completed}}}class Bt{constructor(e=[],t=0){this.messages=e,this.typingDelay=t,this.index=0}next(){return this.isComplete()?null:this.messages[this.index++]}isComplete(){return this.index>=this.messages.length}restore(e=0){this.index=e}serializeState(){return{index:this.index}}}class Ti{constructor(e,t,s={},i=null){this.bus=e,this.store=t,this.logger=i??new L,this.id=s.id||null,this.eventConfig=s.event||{},this.questConfig=s.quest||null,this.reactions=Array.isArray(s.reactions)?[...s.reactions]:null,this.reactionPreset=typeof s.reactionPreset=="string"&&s.reactionPreset.trim()!==""?s.reactionPreset:null,this.event=this.eventConfig.id?new Ri(e,t,this.eventConfig.id,this.logger):null,this.questConfig?.id?(this.quest=new Li(e,t,this.questConfig.id,this.logger),this.quest.overlay=this.questConfig.overlay):this.quest=null}start(){this.event&&this.eventConfig.autoStart&&this.event.start()}getDialog(){return new Bt(this.eventConfig.messages||[])}getRequirement(){return this.questConfig?.requirement||null}completeEvent(){this.event&&(this.event.complete(),this.quest&&this.quest.start())}completeQuest(){this.quest&&this.quest.complete()}isQuestActive(){return!!this.quest?.started&&!this.quest?.completed}getId(){return this.id||this.questConfig?.id||this.eventConfig?.id||null}getReactions(){return this.reactions?[...this.reactions]:[]}getReactionPreset(){return this.reactionPreset}}class Ci{constructor(e,t,s=null){this.bus=e,this.store=t,this.logger=s??new L,this.sequence=null,this.stages=[],this.current=0,this.completionGuard=null,this._completionDeferred=null}load(e){this.sequence=e,this.stages=(e.stages||[]).map(r=>new Ti(this.bus,this.store,r,this.logger));const t=this.store?.load?.(`duality:${e.id}:stage`),i=!!this.store?.load?.(`duality:${e.id}`)?.completed;if(this.current=typeof t?.index=="number"?t.index:0,i)this.current=Math.min(this.current,this.stages.length-1),this.bus?.emit({type:K,id:e.id});else{const a=this.stages[this.current]?.quest,n=a?this.store?.load?.(`quest:${a.id}`):null;a&&!n?.completed&&n?.started&&a.start()}}start(){this.sequence&&(this.bus?.emit({type:dt,id:this.sequence.id}),this.logger.info(`Duality started: ${this.sequence.id}`),this.stages[0]?.start())}getCurrentDialog(){return this.stages[this.current]?.getDialog()}completeCurrentEvent(){const e=this.stages[this.current];e&&(e.completeEvent(),e.quest||this._advance())}completeQuest(){const e=this.stages[this.current];e?.quest&&(e.completeQuest(),this._advance())}_advance(){if(this.current>=this.stages.length-1){if(this.store?.save?.(`duality:${this.sequence?.id}:stage`,{index:this.current}),this._shouldDeferCompletion())return;this._completeSequence()}else this.current+=1,this.store?.save?.(`duality:${this.sequence?.id}:stage`,{index:this.current}),this.stages[this.current].start(),this.bus?.emit({type:ae,id:this.sequence?.id,index:this.current})}setCompletionGuard(e){this.completionGuard=e||null}resumeCompletion(){return this._completionDeferred?(this._completionDeferred=null,this._completeSequence(),!0):!1}_shouldDeferCompletion(){if(!this.completionGuard?.shouldHoldCompletion)return!1;if(this._completionDeferred)return!0;const e={dualityId:this.sequence?.id||null,stageIndex:this.current,stageConfig:this.getStageConfig(this.current),resume:()=>this.resumeCompletion()};return this.completionGuard.shouldHoldCompletion(e)?(this._completionDeferred=e,!0):!1}_completeSequence(){this.bus?.emit({type:K,id:this.sequence?.id}),this.store?.save?.(`duality:${this.sequence?.id}`,{completed:!0}),this.logger.info(`Duality completed: ${this.sequence?.id}`)}getRequirement(){return this.stages[this.current]?.getRequirement()}getCurrentStageIndex(){return this.current}resetProgress(e){if(!e)return;const t=e.id;t&&(this.store?.remove?.(`duality:${t}`),this.store?.remove?.(`duality:${t}:stage`)),(e.stages||[]).forEach(s=>{const i=s?.quest?.id;i&&this.store?.remove?.(`quest:${i}`)}),this.current=0,this._completionDeferred=null}getStageConfig(e=this.current){return this.sequence?.stages?.[e]||null}getQuest(){return this.stages[this.current]?.quest||null}getQuestOverlay(){return this.getQuest()?.overlay||null}isQuestActive(){return this.stages[this.current]?.isQuestActive()||!1}}class kt{constructor(e=null){this.logger=e}debug(e){this.logger?.debug?.(e)}info(e){this.logger?.info?.(e)}warn(e){this.logger?.warn?.(e)}error(e){this.logger?.error?.(e)}}class Ii extends kt{constructor(e,t,s,i=null,r=null){super(r),this.dialog=e,this.eventBus=t,this.persistence=s,this.buttonStateService=i,this._msgSeq=0,this._orderSeq=0}progress(){const e=this.dialog.next();if(!e)return null;e.avatar=e.avatar||"",e.timestamp=e.timestamp||Date.now(),typeof e.id!="number"&&(e.id=this._msgSeq++),typeof e.order!="number"&&(this._orderSeq+=1,e.order=this._orderSeq);const{type:t,...s}=e;if(this.eventBus?.emit({type:C,...s,message:e}),this.buttonStateService){const i=this.dialog.messages?.[this.dialog.index],r=i&&i.author==="user";this.buttonStateService.setState?.("post",r,"main")}return this.persistence?.save?.("dialog",this.dialog.serializeState()),this.debug(`Progressed dialog to message ${e.id}`),e}}class Mi{constructor(e){this.context=e}register(){const{container:e}=this.context;e.register("DualityManager",()=>new Ci(e.resolve("IEventBus"),e.resolve("IPersistence"),e.resolve("Logging")),{priority:140}),e.register("DialogManager",()=>new Ii(new Bt([]),e.resolve("IEventBus"),e.resolve("IPersistence"),null,e.resolve("Logger")),{priority:141})}}class Di{constructor(e,t="src/config/spirits",s=new tt){if(!e||typeof e.load!="function")throw new TypeError("DualityConfigService requires a config loader implementing IConfigLoader.");this.configLoader=e,this.basePath=t,this.assetUrlMapper=s}async load(e){const t=await this.configLoader.load(`${this.basePath}/${e}.json`);if(!Array.isArray(t.stages))throw new Error("Stages array is required");return this.assetUrlMapper.mapConfig(t)}}class Oi{constructor(e,t,s,i=new v,r=null){this.db=e,this.enc=t,this.logger=s,this.bus=i,this.stateService=r,this.name="",this.avatar=null,this._imported=!1,this._exported=!1,this._resetHandler=a=>{a?.type===q&&this._handleReset()},this.bus?.subscribe?.(this._resetHandler)}setName(e){this.name=e}setAvatar(e){this.avatar=e;const t=e?e.length:0;this.logger?.info?.(`ProfileRegistrationService: avatar set (${t} bytes)`)}async importProfile(e,t){try{const s=new Uint8Array(await e.arrayBuffer()),i=await this.enc.decrypt(s,t),r=i?.profile||i;return await this.db.saveUser({name:r.name,created_at:r.created_at,avatar:r.avatar||null}),this.name=r.name,this.avatar=r.avatar||null,this.stateService?.setLocalAuthReady?.(!0),this._imported=!0,this.logger?.info(`ProfileRegistrationService: imported profile, name=${this.name}`),i}catch(s){throw this.logger?.error(`Import failed: ${s.message}`),s}}async exportProfile(e,t={}){try{const s={name:this.name,created_at:new Date().toISOString(),avatar:this.avatar};await this.db.saveUser(s);const i={profile:s,ghosts:t.ghosts||{},meta:t.meta||{}},r=await this.enc.encrypt(i,e);return await this.db.recordExport(r),this._exported=!0,this.logger?.info(`ProfileRegistrationService: exported profile, name=${this.name}`),r}catch(s){throw this.logger?.error(`Export failed: ${s.message}`),s}}async saveProfile(){if(!this.avatar)throw this.logger?.warn?.("ProfileRegistrationService: cannot save profile without avatar"),new Error("Avatar is required");this.logger?.info?.(`ProfileRegistrationService: saving profile, avatar length ${this.avatar.length}`);const e={name:this.name,created_at:new Date().toISOString(),avatar:this.avatar};this.stateService?.setPresence?.("person",!0),this.stateService?.setLocalAuthReady?.(!0),await this.db.saveUser(e),this.logger?.info(`Profile saved: ${this.name}`),this.bus?.emit?.({type:Me,avatar:this.avatar})}canProceed(){return!!this.name||this._imported||this._exported}_handleReset(){this.name="",this.avatar=null,this._imported=!1,this._exported=!1,this.stateService?.setLocalAuthReady?.(!1)}dispose(){this._resetHandler&&(this.bus?.unsubscribe?.(this._resetHandler),this._resetHandler=null)}}class xi{constructor(e,t={}){this.storage=e,this.defaultGhost=t.defaultGhost||"guide",this.current=this.storage.load("ghostType")||this.defaultGhost}setCurrentGhost(e){this.current=e,this.storage.save("ghostType",e)}getCurrentGhost(){return{name:this.current}}}class Pi{constructor(e,t=new v){this.store=e,this.bus=t,this.completed=new Set(this.store?.load?.("ghostsCompleted")||[])}isCompleted(e){return this.completed.has(e)}markCompleted(e,t){const s=t?this.getUnlocked(t):[];if(this.completed.add(e),this.store?.save?.("ghostsCompleted",Array.from(this.completed)),t){const r=this.getUnlocked(t).filter(a=>!s.includes(a));r.length&&this.bus.emit({type:"GHOST_UNLOCKED",ghosts:r})}}getUnlocked(e){return Object.keys(e).filter(t=>(e[t].unlock?.requires||[]).every(i=>this.completed.has(i)))}getAvailable(e,t=null){const s=this.getUnlocked(e),i=Object.keys(e).filter(a=>e[a].unlock?.alwaysVisible),r=new Set([...s,...i]);return t&&r.add(t),Array.from(r)}}class Ni{constructor(e){this.db=e}ensureSchema(){this.db.run(`
        CREATE TABLE IF NOT EXISTS dialog_messages(
          ghost TEXT NOT NULL,
          order_idx INTEGER NOT NULL,
          author TEXT NOT NULL,
          text   TEXT,
          type   TEXT,
          avatar TEXT,
          src    TEXT,
          media_id TEXT,
          stage_id TEXT,
          reaction TEXT,
          reaction_origin TEXT,
          fingerprint TEXT NOT NULL,
          ts     INTEGER NOT NULL,
          PRIMARY KEY (ghost, fingerprint)
        );
      `),this._ensureColumn("dialog_messages","reaction","TEXT"),this._ensureColumn("dialog_messages","reaction_origin","TEXT"),this._ensureColumn("dialog_messages","stage_id","TEXT")}_ensureColumn(e,t,s){const i=this.db.fetchAll(`PRAGMA table_info(${e})`);new Set(i.map(a=>String(a.name||"").toLowerCase())).has(t.toLowerCase())||this.db.run(`ALTER TABLE ${e} ADD COLUMN ${t} ${s}`)}appendUnique(e,t=[]){const s=`INSERT INTO dialog_messages(ghost, order_idx, author, text, type, avatar, src, media_id, stage_id, fingerprint, ts, reaction, reaction_origin)
      VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?)
      ON CONFLICT(ghost, fingerprint) DO UPDATE SET
        order_idx=excluded.order_idx,
        author=excluded.author,
        text=excluded.text,
        type=excluded.type,
        avatar=excluded.avatar,
        src=excluded.src,
        media_id=excluded.media_id,
        stage_id=excluded.stage_id,
        ts=excluded.ts,
        reaction=excluded.reaction,
        reaction_origin=excluded.reaction_origin`;t.forEach((i,r)=>{const a=i.timestamp??Date.now(),n=i.order??r+1,l=typeof i.reaction=="string"&&i.reaction.trim()!==""?i.reaction:null,c=typeof i.reaction_origin=="string"&&i.reaction_origin.trim()!==""?i.reaction_origin:null;this.db.run(s,[e,n,i.author,i.text??null,i.type??null,i.avatar??null,i.src??null,i.media_id??null,i.stage_id??null,i.fingerprint,a,l,c])})}replaceFingerprints(e,t=[],s=[]){const i=`INSERT INTO dialog_messages(ghost, order_idx, author, text, type, avatar, src, media_id, stage_id, fingerprint, ts, reaction, reaction_origin)
      VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?)
      ON CONFLICT(ghost, fingerprint) DO UPDATE SET
        order_idx=excluded.order_idx,
        author=excluded.author,
        text=excluded.text,
        type=excluded.type,
        avatar=excluded.avatar,
        src=excluded.src,
        media_id=excluded.media_id,
        stage_id=excluded.stage_id,
        ts=excluded.ts,
        reaction=excluded.reaction,
        reaction_origin=excluded.reaction_origin`;if(t.forEach(r=>{const a=r.timestamp??Date.now(),n=r.order??0,l=typeof r.reaction=="string"&&r.reaction.trim()!==""?r.reaction:null,c=typeof r.reaction_origin=="string"&&r.reaction_origin.trim()!==""?r.reaction_origin:null;this.db.run(i,[e,n,r.author,r.text??null,r.type??null,r.avatar??null,r.src??null,r.media_id??null,r.stage_id??null,r.fingerprint,a,l,c])}),s.length){const r=s.map(()=>"?").join(",");this.db.run(`DELETE FROM dialog_messages WHERE ghost = ? AND fingerprint IN (${r})`,[e,...s])}}loadAll(e){return this.db.fetchAll("SELECT author, text, type, avatar, src, media_id, stage_id, reaction, reaction_origin, fingerprint, ts as timestamp, order_idx FROM dialog_messages WHERE ghost = ? ORDER BY ts, order_idx",[e]).map(s=>({author:s.author,text:s.text,type:s.type,avatar:s.avatar,src:s.src,media_id:s.media_id,stage_id:s.stage_id,reaction:s.reaction,reaction_origin:s.reaction_origin,fingerprint:s.fingerprint,timestamp:Number(s.timestamp),order:Number(s.order_idx)}))}loadAllGrouped(){return this.db.fetchAll(`SELECT ghost, author, text, type, avatar, src, media_id, stage_id, reaction, reaction_origin, fingerprint, ts as timestamp, order_idx
       FROM dialog_messages
       ORDER BY ghost, ts, order_idx`).reduce((t,s)=>(t[s.ghost]||(t[s.ghost]=[]),t[s.ghost].push({author:s.author,text:s.text,type:s.type,avatar:s.avatar,src:s.src,media_id:s.media_id,stage_id:s.stage_id,reaction:s.reaction,reaction_origin:s.reaction_origin,fingerprint:s.fingerprint,timestamp:Number(s.timestamp),order:Number(s.order_idx)}),t),{})}clearAll(){this.db.run("DELETE FROM dialog_messages;")}clearGhost(e){e&&this.db.run("DELETE FROM dialog_messages WHERE ghost = ?;",[e])}replaceAll(e={}){this.clearAll(),Object.entries(e||{}).forEach(([t,s])=>{Array.isArray(s)&&this.appendUnique(t,s.map(i=>({author:i.author,text:i.text,type:i.type,avatar:i.avatar,src:i.src,media_id:i.media_id,stage_id:i.stage_id,reaction:typeof i.reaction=="string"&&i.reaction.trim()!==""?i.reaction:null,reaction_origin:typeof i.reaction_origin=="string"&&i.reaction_origin.trim()!==""?i.reaction_origin:null,fingerprint:i.fingerprint,timestamp:i.timestamp,order:i.order})))})}updateReaction(e,t,s,i=null){if(!e||!t)return;const r=typeof s=="string"&&s.trim()!==""?s:null,a=typeof i=="string"&&i.trim()!==""?i:null;this.db.run("UPDATE dialog_messages SET reaction = ?, reaction_origin = COALESCE(?, reaction_origin) WHERE ghost = ? AND fingerprint = ?",[r,a,e,t])}}const Bi=new Set(["youtube.com","www.youtube.com","m.youtube.com","youtu.be","www.youtu.be","youtube-nocookie.com","www.youtube-nocookie.com"]),ki=o=>{try{const e=new URL(o);if(!Bi.has(e.hostname))return"";if(e.hostname.includes("youtu.be"))return e.pathname.replace("/","").trim();const t=e.searchParams.get("v");if(t)return t.trim();const s=e.pathname.split("/").filter(Boolean),i=s.indexOf("embed");if(i>=0&&s[i+1])return s[i+1].trim();const r=s.indexOf("shorts");return r>=0&&s[r+1]?s[r+1].trim():""}catch{return""}},Ui=o=>{if(typeof o!="string")return"";const e=o.trim();if(!e)return"";const t=ki(e);return t||e},Ut=(...o)=>{for(const e of o){const t=Ui(e);if(t)return t}return""};function I(o={}){const{fingerprint:e,ghost:t="",author:s="",type:i="",text:r="",src:a="",media:n=null,youtubeId:l="",youtubeUrl:c="",youtube:h=null,stageId:d=""}=o;if(e)return String(e);const p=Ut(l,c,h?.id,h?.src),u=a||n&&(n.id||n.src)||p;return`${t}:${typeof d=="string"?d:""}:${s}:${i}:${r}:${u}`}class qi{constructor(e){this.repo=e,this._seen=new Map}_normalizeReaction(e){return typeof e!="string"?"":e.trim()}_prepare(e,t=[],s=new Set){const i=Date.now(),r=[];return t.forEach((a,n)=>{const l=a.timestamp??i+n,c=a.order??n+1,h=a.persistSrc||a.src,d=typeof h=="string"&&h.startsWith("blob:")?null:h,p=a.media?.id?{id:a.media.id}:null,u=this._normalizeReaction(a.reaction),g=u===""?null:u,m=a.reactionOrigin==="system"?"system":"user",f=typeof a.stageId=="string"&&a.stageId.trim()!==""?a.stageId.trim():null,y=I({fingerprint:a.fingerprint&&!String(a.fingerprint).includes("blob:")?a.fingerprint:void 0,ghost:e,stageId:f||"",author:a.author,text:a.text||"",type:a.type||"",src:d||void 0,media:p});if(s.has(y))return;if(s.add(y),a.type==="image"){r.push({type:"image",src:d,media_id:p?.id,timestamp:l,order:c,fingerprint:y,author:a.author,avatar:a.avatar,reaction:g,reaction_origin:g?m:null,stage_id:f});return}const b={author:a.author,text:a.text,timestamp:l,order:c,fingerprint:y,reaction:g,reaction_origin:g?m:null};a.avatar&&(b.avatar=a.avatar),d&&(b.src=d),p&&(b.media_id=p.id),f&&(b.stage_id=f),r.push(b)}),r}_fingerprintKey(e={}){return e.fingerprint!==void 0?String(e.fingerprint):e.id!==void 0?`id:${e.id}`:I({ghost:e.ghost||"",stageId:e.stageId||e.stage_id||"",author:e.author||"",type:e.type||"",text:e.text||"",src:e.src||e.media&&(e.media.id||e.media.src)||""})}has(e,t){const s=this._fingerprintKey(t);return s===null?!1:this._seen.get(e)?.has(s)||!1}markSeen(e,t){const s=this._fingerprintKey(t);s!==null&&(this._seen.has(e)||this._seen.set(e,new Set),this._seen.get(e).add(s))}clearSeen(e){e&&this._seen.delete(e)}clear(e){e&&(this.repo?.clearGhost?.(e),this.clearSeen(e))}reset(){this.repo?.clearAll?.(),this._seen.clear()}save(e,t){const s=this._prepare(e,t);this.repo?.appendUnique?.(e,s),s.forEach(i=>this.markSeen(e,i))}load(e){let t=this.repo?.loadAll?.(e)||[];const s=t.filter(i=>/^\d+$/.test(String(i.fingerprint)));if(s.length&&typeof this.repo?.replaceFingerprints=="function"){const i=[],r=new Set;t.forEach(a=>{const n=a.media_id?{id:a.media_id}:void 0,l=/^\d+$/.test(String(a.fingerprint))?I({ghost:e,stageId:a.stage_id||"",author:a.author,text:a.text||"",type:a.type||"",src:a.src||"",media:n}):a.fingerprint;r.has(l)||(r.add(l),i.push({...a,fingerprint:l}))}),this.repo.replaceFingerprints(e,i,s.map(a=>a.fingerprint)),t=i}return t.map(i=>{const r={author:i.author,text:i.text,type:i.type,avatar:i.avatar,fingerprint:i.fingerprint,timestamp:Number(i.timestamp),order:Number(i.order)};return i.src&&(r.src=i.src),i.media_id&&(r.media={id:i.media_id}),r.reaction=this._normalizeReaction(i.reaction),r.reactionOrigin=i.reaction_origin==="system"?"system":"user",r.reactionLocked=r.reactionOrigin==="system",i.stage_id&&(r.stageId=i.stage_id),r})}setReaction(e,t,s,i=null){if(!e||!t)return;const r=this._normalizeReaction(s),a=r===""?null:r,n=i==="system"?"system":"user";this.repo?.updateReaction?.(e,t,a,n)}appendUnique(e,t){const s=this.load(e),i=new Set(s.map(a=>a.fingerprint)),r=this._prepare(e,t,i);this.repo?.appendUnique?.(e,r),r.forEach(a=>this.markSeen(e,a))}append(e,t){this.appendUnique(e,t)}exportAll(){return this.repo?.loadAllGrouped?.()||{}}replaceAll(e={}){this._seen.clear(),this.repo?.replaceAll?.(e)}clearAll(){this._seen.clear(),this.repo?.clearAll?.()}}class Fi{constructor(e){this.bus=e,this.active=null,this._handler=t=>{t.type==="SCREEN_CHANGE"&&(this.active=t.screen)}}boot(){this.bus?.subscribe(this._handler)}getActive(){return this.active}dispose(){this._handler&&this.bus?.unsubscribe(this._handler)}}class Gi{constructor(e,t,s,i=null){this.bus=e,this.store=t,this.screenService=s,this.logger=i??new L,this.state={},this.ready=!1,this.awaiting={awaits:!1},this._handler=r=>{r.type===xt&&(this.awaiting=r,this._applyAwaiting()),r.type==="SCREEN_CHANGE"&&this._applyStored(r.screen)},this.bus.subscribe(this._handler)}boot(){let e=this.store?.load?.("buttonState");if(typeof e=="string")try{e=JSON.parse(e)}catch{this.logger.warn("Legacy buttonState detected, clearing entry."),this.store?.remove?.("buttonState"),e={}}e&&(typeof e!="object"||e===null)&&(this.logger.warn("Invalid buttonState data, resetting to empty object."),e={}),this.state=e||{},"messenger:post"in this.state||(this.state["messenger:post"]=!0),"camera:capture-btn"in this.state||(this.state["camera:capture-btn"]=!1),this.ready=!0;const t=this.screenService?.getActive?.();t&&this._applyStored(t)}setState(e,t,s){const i=s?`${s}:${e}`:e;this.state[i]=t,this.store?.save?.("buttonState",this.state),this.bus?.emit({type:N,button:e,active:t,screen:s})}setScreenState(e,t,s){this.setState(t,s,e)}getStatesForScreen(e){const t=`${e}:`,s={};for(const[i,r]of Object.entries(this.state))if(i.startsWith(t)){const a=i.slice(t.length);s[a]=!!r}return s}isActive(e,t){if(typeof this.state!="object"||this.state===null)return this.logger.warn("Button state is corrupted, assuming active."),!0;const s=t?`${t}:${e}`:e;return s in this.state?!!this.state[s]:e in this.state?!!this.state[e]:!0}isReady(){return this.ready}_applyAwaiting(){const e=this.screenService?.getActive?.(),{awaits:t,kind:s,targetScreen:i}=this.awaiting,r=t&&s==="user_text"&&i===e;(!t||s!=="camera_capture"||i!==e)&&this.setScreenState("camera","capture-btn",!1),this.setScreenState("messenger","post",!!r)}_applyStored(e){const t=this.getStatesForScreen(e);for(const[s,i]of Object.entries(t))this.bus?.emit({type:N,button:s,active:i,screen:e})}}class Hi{constructor(e,t,s=null){this.bus=e,this.store=t,this.logger=s??new L,this.visibility={},this.ready=!1}boot(){let e=this.store?.load?.("buttonVisibility");if(typeof e=="string")try{e=JSON.parse(e)}catch{this.logger.warn("Legacy buttonVisibility detected, clearing entry."),this.store?.remove?.("buttonVisibility"),e={}}e&&(typeof e!="object"||e===null)&&(this.logger.warn("Invalid buttonVisibility data, resetting to empty object."),e={}),this.visibility=e||{},"messenger:toggle-camera"in this.visibility||(this.visibility["messenger:toggle-camera"]=!0),"camera:toggle-messenger"in this.visibility||(this.visibility["camera:toggle-messenger"]=!1),"messenger:post"in this.visibility||(this.visibility["messenger:post"]=!0),"camera:capture-btn"in this.visibility||(this.visibility["camera:capture-btn"]=!1),this.ready=!0}setVisibility(e,t,s){const i=s?`${s}:${e}`:e;this.visibility[i]!==t&&(this.visibility[i]=t,this.store?.save?.("buttonVisibility",this.visibility),this.bus?.emit({type:mt,button:e,visible:t,screen:s}))}setScreenVisibility(e,t,s){this.setVisibility(t,s,e)}getVisibilityForScreen(e){const t=`${e}:`,s={};for(const[i,r]of Object.entries(this.visibility))if(i.startsWith(t)){const a=i.slice(t.length);s[a]=!!r}return s}isVisible(e,t){if(typeof this.visibility!="object"||this.visibility===null)return this.logger.warn("Button visibility is corrupted, assuming visible."),!0;const s=t?`${t}:${e}`:e;return s in this.visibility?!!this.visibility[s]:e in this.visibility?!!this.visibility[e]:!0}isReady(){return this.ready}}class ji{constructor(e){this.onMessenger=e}build(e={}){const{showMessengerButton:t=!1}=e;if(!t)return null;const s=document.createElement("div");s.className="modal__actions";const i=document.createElement("button");return i.type="button",i.className="modal__button modal__button--primary",i.setAttribute("data-i18n","open_messenger"),i.addEventListener("click",()=>{this.onMessenger?.()}),s.appendChild(i),s}}class $i{constructor(e=new v){this.bus=e,this.actionsBuilder=new ji(()=>{this.hide(),this.bus.emit({type:"SCREEN_CHANGE",screen:"messenger"})}),this._handler=t=>{t.type===he&&(t.node?this.show(t.node):t.src&&this.showFromDataURL(t.src,t.revoke,{showMessengerButton:t.showMessengerButton===!0}))}}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler)}show(e){this.bus.emit({type:Ie,node:e})}showFromDataURL(e,t=null,s={}){const i=new Image;if(i.className="modal__image",typeof t=="function"){const a=()=>t();i.addEventListener("load",a,{once:!0}),i.addEventListener("error",a,{once:!0})}const{showMessengerButton:r=!1}=s;i.onload=()=>this.show(this._wrapWithActions(i,{showMessengerButton:r})),i.src=e}hide(){this.bus.emit({type:ce})}_wrapWithActions(e,t={}){const s=document.createElement("div");s.className="modal__viewer";const i=document.createElement("div");i.className="modal__media",e&&i.appendChild(e);const r=this.actionsBuilder.build(t);return s.appendChild(i),r&&s.appendChild(r),s}}class Vi{constructor(e,t){this.db=e,this.ghostService=t}async publish(e=""){await this.db.boot?.();const t=await this.db.loadUser();if(!t)return;const s=this.ghostService.getCurrentGhost();await this.db.executeQuery("INSERT INTO posts(user_id, ghost_type, content, created_at) VALUES(?,?,?,?)",[t.id,s.name,e,new Date().toISOString()])}async getPostsForCurrent(){const e=await this.db.loadUser(),t=this.ghostService.getCurrentGhost();return this.db.fetchAll("SELECT * FROM posts WHERE user_id=? AND ghost_type=? ORDER BY created_at DESC",[e.id,t.name])}async exportAllByGhost(){const e=await this.db.loadUser();return e?(await this.db.fetchAll("SELECT ghost_type, content, created_at FROM posts WHERE user_id=? ORDER BY created_at ASC",[e.id])).reduce((s,i)=>{const r=i.ghost_type||"unknown";return s[r]||(s[r]=[]),s[r].push({content:i.content,created_at:i.created_at}),s},{}):{}}async replaceAllByGhost(e={}){const t=await this.db.loadUser();if(!t)return;await this.db.exec("DELETE FROM posts WHERE user_id=?",[t.id]);const s=Object.entries(e||{});for(const[i,r]of s)if(Array.isArray(r))for(const a of r){const n=a.created_at||new Date().toISOString(),l=a.content||"";await this.db.exec("INSERT INTO posts(user_id, ghost_type, content, created_at) VALUES(?,?,?,?)",[t.id,i,l,n])}}}class Wi extends kt{constructor(e,t=null){super(t),this.database=e}async getUserAvatar(){try{const e=await this.database.get("SELECT avatar FROM users ORDER BY id DESC LIMIT 1");if(e?.avatar){const t=e.avatar.slice(0,20);return this.info(`User avatar retrieved: ${t}`),e.avatar}return this.warn("User avatar not found"),null}catch(e){return this.warn(`User avatar lookup failed: ${e?.message||e}`),null}}}class zi{constructor(e,t,s,i,r=null){this.templateService=e,this.languageManager=t,this.profileRegService=s,this.bus=i,this.storage=r,this._handler=a=>{a.type==="BUTTON_ACTION"&&this.handleAction(a)},this.bus.subscribe(this._handler)}async boot(){}dispose(){this.bus.unsubscribe(this._handler)}async renderButtons(e=[]){return(await Promise.all(e.map(s=>{const i={...s,icon:s.icon||"",i18nKey:s.i18n||s.action};return this.templateService.render(`buttons/${s.template}`,i)}))).join("")}async init(e,t){const s=await this.renderButtons(t);this.bus.emit({type:"BUTTONS_RENDER",container:e,html:s})}async handleAction(e){const{action:t,value:s}=e;if(t==="change-language"){this.languageManager.setLanguage(s);return}if(t==="capture-btn"){this.bus.emit({type:"capture-btn"});return}if(t==="import-profile"){this.bus.emit({type:At});return}if(t==="export-profile"){this.bus.emit({type:Tt});return}if(t==="reset-account"){const r={source:"button"};s&&typeof s=="object"&&(r.options=s),this.bus.emit({type:ue,payload:r});return}if(t==="enter-name"&&this.profileRegService){this.profileRegService.setName(s),this.bus.emit({type:"NEXT_BUTTON_ENABLE",enabled:this.profileRegService.canProceed()}),this.bus.emit({type:"enter-name",payload:{value:s}});return}const i=s!==void 0?{value:s}:void 0;this.bus.emit({type:t,payload:i})}}const $e={welcome:{next:[{type:"always"}],"change-language":[{type:"always"}],"import-profile":[{type:"always"}]},registration:{next:[{type:"profileReady"}],"change-language":[{type:"always"}],"import-profile":[{type:"always"}]},"apartment-plan":{"detect-geo":[{type:"always"}],next:[{type:"always"}]},"registration-camera":{finish:[{type:"afterCapture"}]},camera:{"capture-btn":[{type:"always"}],"toggle-messenger":[{type:"always"}],finish:[{type:"afterCapture"}]}};function qt(o={},e={}){const t={...o};for(const[s,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?t[s]=qt(t[s]||{},i):t[s]=i;return t}class Yi{constructor(e,t,s,i,r,a=null){this.profile=e,this.geo=t,this.ghostService=s,this.eventBus=i,this.logger=r,this.screenService=a,this.config=null,this.currentScreen=null,this.presence={},this.captured=!1,this.localAuthReady=!1,this.aiState="IDLE",this._handler=null}async boot(){this.config={...$e};const e=this.ghostService.getCurrentGhost();await this._loadGhostConfig(e.name),this._handler=async t=>{t.type==="GHOST_CHANGE"&&(this.config={...$e},await this._loadGhostConfig(t.payload.name),this.eventBus.emit({type:"BUTTON_STATE_UPDATED",screen:this.currentScreen})),t.type===de&&t.state&&(this.setAiState(t.state),this._emitButtonRefresh()),t.type===Me&&(this.setLocalAuthReady(!0),this._emitButtonRefresh()),t.type===q&&(this.setLocalAuthReady(!1),this.setAiState("IDLE"),this.resetPresence(),this.resetCaptured(),this._emitButtonRefresh())},this.eventBus.subscribe(this._handler)}async _loadGhostConfig(e){const t=it?.[e];if(!t){this.logger?.warn?.(`No override for ghost: ${e}`);return}this.config=qt(this.config,t)}isButtonEnabled(e,t){this.currentScreen=e;const s=this.config[e]?.[t];return!Array.isArray(s)||s.length===0?!1:s.every(i=>this._evaluate(i))}setPresence(e,t){this.presence[e]=t}markCaptured(){this.captured=!0}resetCaptured(){this.captured=!1}resetPresence(){this.presence={}}setLocalAuthReady(e){this.localAuthReady=!!e}isLocalAuthReady(){return this.localAuthReady===!0}setAiState(e){this.aiState=e}getAiState(){return this.aiState}isAiReady(){return this.aiState==="READY"}isAiLoading(){return this.aiState!=="READY"&&this.aiState!=="FAILED"}dispose(){this._handler&&(this.eventBus.unsubscribe(this._handler),this._handler=null)}_evaluate(e){switch(e.type){case"always":return!0;case"profileReady":return this.profile.canProceed();case"afterCapture":return this.captured===!0;case"presence":return this.presence[e.object];case"localAuthReady":return this.localAuthReady===!0;case"aiReady":return this.aiState==="READY";default:return!1}}_emitButtonRefresh(){const e=this.screenService?.getActive?.()||this.currentScreen;e&&this.eventBus.emit({type:"BUTTON_STATE_UPDATED",screen:e})}}const Ft="DETECTION_START",Gt="DETECTION_DONE",Ht="DIALOG_ADVANCE",Ki="QUEST_START",Qi="QUEST_COMPLETE",Xi="AWAIT_USER",Ji="REPLAY_HISTORY",Zi=o=>({type:Ft,payload:o}),Ve=o=>({type:Gt,payload:o}),V=()=>({type:Ht}),Se="camera.detect",we="dialog.progress",Ee="history.save",jt=!1;var We={};const De={detection:{busy:!1},dialog:{index:0,awaiting:"ghost"},quest:{active:!1},dsl:{index:0}};function er(o=De,e={}){switch(e.type){case Ft:return o.detection.busy?{state:o,effects:[]}:{state:{...o,detection:{busy:!0}},effects:[{type:Se,payload:e.payload}]};case Gt:return{state:{...o,detection:{busy:!1}},effects:[]};case"DETECTION_FINISHED":{const t=We.DSL_ENABLED==="true";return{state:{...o,detection:{busy:!1},dsl:{index:t?o.dsl.index+1:o.dsl.index}},effects:[]}}case Ht:{const t=o.dialog.index+1,s=o.dialog.awaiting==="user"?"ghost":"user";return{state:{...o,dialog:{index:t,awaiting:s}},effects:[{type:we},{type:Ee}]}}case"DIALOG_POST":{const t=o.dialog.index+1,s=o.dialog.awaiting==="user"?"ghost":"user",r=We.DSL_ENABLED==="true"?o.dsl.index+1:o.dsl.index;return{state:{...o,dialog:{index:t,awaiting:s},dsl:{index:r}},effects:[{type:we},{type:Ee}]}}case Ki:return{state:{...o,quest:{active:!0}},effects:[]};case Qi:return{state:{...o,quest:{active:!1}},effects:[]};case Xi:return{state:{...o,dialog:{...o.dialog,awaiting:"user"}},effects:[]};case Ji:{const t=e.payload||{},s={...o,...t};return{state:JSON.stringify(s)===JSON.stringify(o)?o:s,effects:[]}}default:return{state:o,effects:[]}}}class tr{constructor(e=De,t=er){this.state=e,this.reducer=t}getState(){return this.state}dispatch(e){const{state:t,effects:s}=this.reducer(this.state,e);return this.state=t,s}}function sr(o=De){return new tr(o)}const ge=sr();class ir{constructor(e={}){this.inner=e,this.type=e?.type||"object",this.target=e?.target??e?.object??null}isSatisfied(){return!0}}class rr extends ir{constructor(e,t){super(t),this.dualityManager=e}isSatisfied(){return!!this.dualityManager?.isQuestActive?.()}}class $t{getRequirement(){return null}}class ar extends $t{getRequirement(){return{type:"presence",target:"person"}}}class nr extends $t{constructor(e,t){super(),this.dualityManager=e,this.bus=t}getRequirement(){const e=this.dualityManager?.getRequirement?.()||null,t=e?.target??e?.object;if(!t)return this.bus?.emit({type:Q}),null;const s=e?.type||"object";return new rr(this.dualityManager,{...e,type:s,target:t})}}class or{constructor(e,t,s,i=null,r=null,a=null,n=new v,l=null,c=null,h=null,d=null,p=null,u=null,g=null,m=null,f=ge,y=jt){if(!u)throw new Error("CameraOrchestratorService: missing imageComposer");if(!g)throw new Error("CameraOrchestratorService: missing mediaRepository");this.cameraService=e,this.detectionService=t,this.logger=s,this.stateService=i,this.dualityManager=r,this.dialogManager=a,this.inputGate=p,this.bus=n,this.buttonStateService=l,this.buttonVisibilityService=c,this.overlayService=h,this.avatarService=d,this.imageComposer=u,this.mediaRepository=g,this.canvasFactory=m,this.store=f,this.engineEnabled=y,this.effectHandlers={[Se]:b=>this._runDetection(b)},this.captured=!1,this.active=!1,this._handler=null,this.cameraOpen=!1,this.lastContainer=null,this.lastRequirement=null,this.lastCameraType="quest",this.lastForce=!1,this.registrationStrategy=new ar,this.questStrategy=new nr(this.dualityManager,this.bus),this._msgSeq=0,this.detectionBusy=!1,this._retryTimer=null}_runEffects(e=[]){const t=[];return e.forEach(s=>{const i=this.effectHandlers[s.type];if(i){const r=i(s.payload);r!==void 0&&t.push(r)}}),t}boot(){this._handler=async e=>{if(e.type==="CAMERA_VIEW_OPENED"){this.cameraOpen=!0;const{cameraType:t="quest",force:s=!1,onDetected:i}=e.options||{};this.lastContainer=e.container,this.lastCameraType=t,this.lastOnDetected=i,this.lastForce=s;try{await this.cameraService.startStream(e.container)}catch(n){this.logger?.error(n.message)}if(!this.cameraOpen){this.logger?.info?.("[Camera] view closed before stream ready");return}this.captured=!1,this.stateService?.resetCaptured?.(),this.stateService?.resetPresence?.();const r=this.dualityManager?.isQuestActive?.(),a=r||s||t==="registration";this.logger?.info?.("[Camera] view opened",{questActive:r,force:s,cameraType:t,shouldStart:a}),a?(this.start(e.container,{cameraType:t,force:s,onDetected:i}),this.inputGate?.advanceToUserTurn()):this.logger?.info?.("[Camera] detection not started on open",{questActive:r,force:s,cameraType:t}),this.buttonVisibilityService?.setScreenVisibility("messenger","toggle-camera",!1),this.buttonVisibilityService?.setScreenVisibility("camera","toggle-messenger",!0),this.buttonVisibilityService?.setScreenVisibility("messenger","post",!1),this.buttonVisibilityService?.setScreenVisibility("camera","capture-btn",!!r)}if(e.type==="CAMERA_VIEW_CLOSED"){this.cameraOpen=!1,this.cameraService?.stopStream(),this.stop(),this.buttonVisibilityService?.setScreenVisibility("messenger","toggle-camera",!0),this.buttonVisibilityService?.setScreenVisibility("camera","toggle-messenger",!1),this.buttonVisibilityService?.setScreenVisibility("messenger","post",!0),this.buttonVisibilityService?.setScreenVisibility("camera","capture-btn",!1);const t=this.dialogManager?.dialog,s=t?.messages?.[t.index];s&&s.author,this.inputGate?.advanceToUserTurn(),this.captured=!1,this.stateService?.resetCaptured?.(),this.stateService?.resetPresence?.()}e.type===Y&&this.cameraOpen&&(this.start(this.lastContainer,{cameraType:this.lastCameraType,force:this.lastForce,onDetected:this.lastOnDetected}),this.inputGate?.advanceToUserTurn()),e.type===gt&&(this.stop(),this.stateService?.resetCaptured?.(),this.stateService?.resetPresence?.(),this.inputGate?.advanceToUserTurn(),this.lastRequirement=null)},this.bus?.subscribe?.(this._handler)}start(e,t={}){if(!this.imageComposer||!this.mediaRepository){this.logger?.error("[Camera] Missing deps",{imageComposer:!!this.imageComposer,mediaRepository:!!this.mediaRepository}),this.buttonStateService?.setScreenState?.("camera","capture-btn",!1),this.buttonStateService?.setScreenState?.("main","toggle-camera",!1);return}const{force:s=!1,cameraType:i="quest",onDetected:r}=t;this.lastContainer=e,this.lastCameraType=i,this.lastOnDetected=r,this.lastForce=s,this.buttonStateService?.setScreenState("camera","capture-btn",!1);const n=(i==="registration"?this.registrationStrategy:this.questStrategy).getRequirement();this.lastRequirement=n,this.logger?.info?.("[Camera] requirement selected",n);const l=i==="quest"?this.dualityManager?.isQuestActive?.():!0,c=n?.target||n?.object;if(this.logger?.info?.("[Camera] start parameters",{questActive:l,force:s,cameraType:i,target:c,requirementType:n?.type}),i==="quest"&&!c){this.logger?.info?.("[Camera] waiting for requirement update");return}if(!(s||(l||i==="registration"&&c==="person")&&c&&(n.type==="presence"||n.type==="object"))){this.logger?.info?.("[Camera] detection skipped",{questActive:l,force:s,target:c,requirementType:n?.type});return}this.bus.emit({type:Q,target:c}),this.active=!0,this.startDetection(e,{requirement:n,onDetected:r})}startDetection(e,t={}){if(!this.active||this.detectionBusy){this.logger?.info?.("[Camera] startDetection aborted",{active:this.active,busy:this.detectionBusy});return}const{onDetected:s,requirement:i}=t;if(i?.isSatisfied&&!i.isSatisfied()){this.logger?.info?.("[Camera] waiting for requirement",i);const l=c=>{c.type===Y&&(this.bus?.unsubscribe?.(l),this.startDetection(e,t))};this.bus?.subscribe?.(l);return}this.logger?.info?.("[Camera] startDetection",i);const r=i?.target||i?.object;if(!r){this.logger?.error?.("startDetection called without target");return}this.detectionBusy=!0;const a=this.store.dispatch(Zi({container:e,target:r,onDetected:s})),n=this.engineEnabled?this._runEffects(a):a.filter(l=>l.type===Se).map(l=>this._runDetection(l.payload));return Promise.all(n).finally(()=>{this.detectionBusy=!1})}async _runDetection({container:e,target:t,onDetected:s}){let i={ok:!1};try{if(!this.active){this.logger?.info?.("[Camera] _runDetection skipped: inactive");return}if(!e||e.offsetParent===null){this.logger?.info?.("[Camera] _runDetection skipped: container hidden");return}const r=await this.cameraService.takeSelfie();i=await this.detectionService.detectTarget(r,t),this.logger?.info?.("[Camera] detection result",{ok:i.ok,box:i.box}),i.ok&&(clearTimeout(this._retryTimer),this._retryTimer=null,this.cameraService?.stopStream?.(),this.bus.emit({type:"CAMERA_STATUS",status:"paused"}),this.buttonStateService?.setScreenState("camera","capture-btn",!0),s&&await s(t,r,i.box,i.mask),this.inputGate?.advanceToUserTurn())}catch(r){this.logger.error(r?.message||r)}finally{this.store.dispatch(Ve()),!i.ok&&this.active&&this.cameraOpen&&(this._retryTimer=setTimeout(()=>{this.startDetection(this.lastContainer,{requirement:this.lastRequirement,onDetected:this.lastOnDetected})},500))}}async resumeDetection({hidePreview:e=!1}={}){if(!this.active)return;clearTimeout(this._retryTimer),this._retryTimer=null,this.stateService?.resetCaptured?.(),this.buttonStateService?.setScreenState("camera","capture-btn",!1);const t=this.lastCameraType==="registration"?"registration-camera":"camera";if(this.bus.emit({type:"BUTTON_STATE_UPDATED",screen:t}),this.bus.emit({type:Q}),this.inputGate?.advanceToUserTurn(),await this.cameraService?.startStream?.(this.lastContainer),this.lastContainer&&(this.lastContainer.hidden=!1,e)){const r=this.lastContainer.parentElement?.querySelector('[data-js="selfie-preview"]');r&&(r.hidden=!0)}const i=(this.lastCameraType==="registration"?this.registrationStrategy:this.questStrategy).getRequirement();this.lastRequirement=i,this.startDetection(this.lastContainer,{requirement:i,onDetected:this.lastOnDetected})}hasCaptured(){return this.captured}markCaptured(){this.captured=!0,this.stateService&&this.stateService.markCaptured()}async captureOverlay(e={},t=null,s=null,i=null){if(!this.overlayService||!this.mediaRepository){this.logger?.error("[Camera] Missing deps",{overlayService:!!this.overlayService,mediaRepository:!!this.mediaRepository});return}const r=this._resolveOverlayMode(e),a=r!=="background-only",n=a?t||await this.cameraService.takeSelfie():null,{background:l,...c}=e;let h=null;if(l?.src)try{h=await this._loadImage(l.src)}catch(R){this.logger?.error?.(R.message)}else if(l?.color){const R=this.canvasFactory.create();R.width=l.width||c.canvasWidth||c.width||0,R.height=l.height||c.canvasHeight||c.height||0;const Pe=R.getContext("2d");Pe.fillStyle=l.color,Pe.fillRect(0,0,R.width,R.height),h=R}if(!this.overlayService){this.logger?.error?.("[Camera] Missing overlayService");return}const d=s?{srcX:s.x,srcY:s.y,srcWidth:s.width,srcHeight:s.height}:{},p={...c,...d},u=await this.overlayService.compose(n,h,p,i,{includeFrame:a,compositionMode:r}),g=u.toDataURL("image/png"),m=await this._toBlobWithFallback(u,"full"),f=this.canvasFactory.create();f.width=64,f.height=64,f.getContext("2d").drawImage(u,0,0,u.width,u.height,0,0,64,64);const y=await this._toBlobWithFallback(f,"thumb"),b=f.toDataURL("image/png");if(!m||!y||!b){this.logger?.error?.("[Camera] overlay composition failed");return}const w=await this.mediaRepository.save({full:m,thumb:y},{crop:d,overlays:i?[{mask:i}]:[]});this.bus.emit({type:he,src:g,showMessengerButton:!0}),this.logger?.info?.("[Camera] overlay composed",{mediaId:w});const x=await this.avatarService?.getUserAvatar?.()||"";this.markCaptured();const F=await this.mediaRepository.get(w),_=await this.mediaRepository.getObjectURL(F.thumbKey),S=_?.url||b;if(!S){this.logger?.error?.("[Camera] missing thumbnail URL");return}this.bus.emit({type:Pt,src:S});const E=Date.now(),T=this._msgSeq++;let Z=Date.now(),M=null;if(this.dialogManager?.dialog){M=this.dialogManager.dialog;const R=M.messages?.[(M.index??0)-1];R&&typeof R.order=="number"&&(Z=R.order+1)}const B=this.dualityManager?.getStageConfig?.(),ee=B?.quest||null,Oe=B?.id||ee?.id||B?.event?.id||null,{reaction:te,origin:xe}=this._resolveReaction(B),G={type:"image",src:S,persistSrc:b,media:{id:w},author:"user",avatar:x,timestamp:E,id:T,order:Z,fingerprint:`capture:${E}`,_revoke:_?.revoke,stageId:Oe,questId:ee?.id||null,reaction:te,reactionOrigin:xe,reactionLocked:!!te,revisionAllowed:!1};if(M){const R=M.index??0;M.messages.splice(R,0,{...G}),M.index=R+1}const{type:va,...zt}=G;this.bus.emit({type:C,...zt,message:G}),te&&this.bus.emit({type:Te,messageId:G.id,fingerprint:G.fingerprint,stageId:Oe,auto:!0,locked:!0,reaction:te,origin:xe}),this.buttonStateService?.setScreenState("main","toggle-camera",!1),this.dualityManager?.completeQuest?.()}_resolveOverlayMode(e={}){const t=typeof e.mode=="string"?e.mode.trim():"";return t||(e.collage===!1?"background-only":"collage")}async _loadImage(e){return new Promise((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=s,i.src=e})}_resolveReaction(e){const t=Array.isArray(e?.reactions)?e.reactions.filter(i=>typeof i=="string"&&i.trim()!==""):[],s=typeof e?.reactionPreset=="string"?e.reactionPreset.trim():"";return s&&(!t.length||t.includes(s))?{reaction:s,origin:"system"}:t.length?{reaction:t[0],origin:"system"}:{reaction:null,origin:null}}async _toBlobWithFallback(e,t){const s=await new Promise(i=>e.toBlob(i));if(s)return s;this.logger?.error?.(`[Camera] ${t} toBlob failed`);try{const i=e.toDataURL("image/png");return this._dataUrlToBlob(i)}catch(i){return this.logger?.error?.(`[Camera] ${t} toDataURL fallback failed`,i),null}}_dataUrlToBlob(e){const[t,s]=e.split(","),i=t.match(/data:(.*);base64/)[1],r=Buffer.from(s,"base64");return new Blob([r],{type:i})}stopDetection(){this.store.dispatch(Ve()),this.bus?.emit?.({type:Le})}stop(){this.active=!1,this.stopDetection(),clearTimeout(this._retryTimer),this._retryTimer=null,this.buttonStateService?.setScreenState("camera","capture-btn",!1)}toggleVisibility(){this.active=!this.active,this.active||(this.cameraService?.stopStream?.(),this.stopDetection()),this.bus.emit({type:"CAMERA_TOGGLE",active:this.active})}dispose(){this._handler&&(this.bus?.unsubscribe?.(this._handler),this._handler=null),this.cameraService?.stopStream?.(),this.stop()}}class lr{constructor(e){this.canvasFactory=e}async compose(e,t=null,s={},i=null,r={}){const a=r.includeFrame!==!1,n=this._resolveCompositionMode(r.compositionMode),l=a&&e?await this._blobToImage(e):null,c=this.canvasFactory.create(),h=this._resolveCanvasDimensions({compositionMode:n,background:t,coords:s,img:l}),d=h.width,p=h.height;c.width=Math.max(1,d),c.height=Math.max(1,p);const u=c.getContext("2d");if(t&&u.drawImage(t,0,0,c.width,c.height),!a||!l)return c;const{x:g=0,y:m=0,srcX:f=0,srcY:y=0,srcWidth:b=l.width,srcHeight:w=l.height}=s,x=n==="detected-only"?b:s.width??l.width,F=n==="detected-only"?w:s.height??l.height,_=this.canvasFactory.create();_.width=b,_.height=w;const S=_.getContext("2d");if(S.drawImage(l,f,y,b,w,0,0,b,w),i){let E=i;i.polygon?E={...i,polygon:i.polygon.map(T=>({x:T.x-f,y:T.y-y}))}:i.imageData&&(E={imageData:this._cropImageData(i.imageData,f,y,b,w)}),this._applyMask(S,E,b,w)}return u.drawImage(_,0,0,b,w,g,m,x,F),c}_resolveCompositionMode(e){return new Set(["collage","background-only","detected-only"]).has(e)?e:"collage"}_resolveCanvasDimensions({compositionMode:e,background:t,coords:s,img:i}){if(e==="detected-only"){const r=s.srcWidth??i?.width??0,a=s.srcHeight??i?.height??0,n=s.x??0,l=s.y??0;return{width:Math.max(1,n+Math.max(1,r),s.canvasWidth||0),height:Math.max(1,l+Math.max(1,a),s.canvasHeight||0)}}return{width:Math.max(1,t?.width||s.canvasWidth||s.width||i?.width||0),height:Math.max(1,t?.height||s.canvasHeight||s.height||i?.height||0)}}_applyMask(e,t,s,i){if(e.save(),e.globalCompositeOperation="destination-in",Array.isArray(t.polygon)){e.beginPath();const[r,...a]=t.polygon;if(r){e.moveTo(r.x,r.y);for(const n of a)e.lineTo(n.x,n.y);e.closePath(),e.fill()}}else if(t.imageData){const r=this.canvasFactory.create();r.width=t.imageData.width||s,r.height=t.imageData.height||i,r.getContext("2d").putImageData(t.imageData,0,0),e.drawImage(r,0,0,s,i)}e.restore()}_cropImageData(e,t,s,i,r){const a=new Uint8ClampedArray(i*r*4),n=e.width;for(let l=0;l<r;l++)for(let c=0;c<i;c++){const h=((s+l)*n+(t+c))*4,d=(l*i+c)*4;a[d]=e.data[h],a[d+1]=e.data[h+1],a[d+2]=e.data[h+2],a[d+3]=e.data[h+3]}return{data:a,width:i,height:r}}async _blobToImage(e){return new Promise(t=>{const s=URL.createObjectURL(e),i=new Image;i.onload=()=>{URL.revokeObjectURL(s),t(i)},i.src=s})}}class cr{constructor(e){if(!e||typeof e.create!="function")throw new TypeError("ImageComposerService requires a canvas factory implementing ICanvasFactory.");this.canvasFactory=e}async compose({frame:e,crop:t={},background:s=null,overlays:i=[],outputs:r={}}){const a=r.full||{},n=a.width||e?.width||0,l=a.height||e?.height||0,c=this._createSurface(n,l);if(s){const u=await this._toDrawable(s);if(u){const g=u.width??n,m=u.height??l;c.drawImage(u,0,0,g,m,0,0,n,l)}else s.color&&c.fillRect(0,0,n,l,s.color)}if(e){const u=await this._toDrawable(e);if(u){const g=u.width??n,m=u.height??l,f=t.srcX??0,y=t.srcY??0,b=t.srcWidth??g,w=t.srcHeight??m;c.drawImage(u,f,y,b,w,0,0,n,l)}}for(const u of i){const g=u?.image??u?.mask??u,m=await this._toDrawable(g);if(!m)continue;const f=u.x??0,y=u.y??0,b=u.width??m.width??0,w=u.height??m.height??0;c.drawImage(m,f,y,b,w)}const h=await c.toBlob();let d=h;if(r.thumb){const u=r.thumb.width||n,g=r.thumb.height||l,m=this._createSurface(u,g);m.drawImage(c.drawable,0,0,n,l,0,0,u,g),d=await m.toBlob()}return{blobs:{full:h,thumb:d},meta:{crop:t,overlays:i}}}async _toDrawable(e){if(!e)return null;if(typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement)return e;if(typeof e=="string"||e?.src){const t=typeof e=="string"?e:e.src;return await this._loadImage(t)}if(typeof Blob<"u"&&e instanceof Blob){if(typeof createImageBitmap=="function")try{return await createImageBitmap(e)}catch{}const t=URL.createObjectURL(e);try{return await this._loadImage(t)}finally{URL.revokeObjectURL(t)}}return null}_loadImage(e){return new Promise((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=s,i.src=e})}_createSurface(e,t){const s=this.canvasFactory.create(e,t);typeof s.width=="number"&&(s.width=e),typeof s.height=="number"&&(s.height=t);const i=s.getContext("2d");if(!i)throw new Error("ImageComposerService requires a 2D rendering context from the canvas factory.");return{canvas:s,ctx:i,drawable:s,drawImage:(...r)=>i.drawImage(...r),fillRect:(r,a,n,l,c)=>{i.fillStyle=c,i.fillRect(r,a,n,l)},async toBlob(r="image/png",a=1){if(typeof s.convertToBlob=="function")return s.convertToBlob({type:r,quality:a});if(typeof s.toBlob=="function")return new Promise((n,l)=>{s.toBlob(c=>{c?n(c):l(new Error("Failed to generate blob from canvas."))},r,a)});throw new Error("Canvas implementation does not support blob conversion.")}}}}class hr{constructor(){this._id=0,this._blobs=new Map,this._meta=new Map,this._urls=new Set}async save(e,t={}){const s=++this._id,i=`thumb-${s}`,r=`full-${s}`;return this._blobs.set(i,e.thumb),this._blobs.set(r,e.full),this._meta.set(s,{thumbKey:i,fullKey:r,...t}),s}async get(e){return this._meta.get(e)}async getObjectURL(e){const t=this._blobs.get(e);if(!t)return null;const s=URL.createObjectURL(t);return this._urls.add(s),{url:s,revoke:()=>{this._urls.has(s)&&(URL.revokeObjectURL(s),this._urls.delete(s))}}}revokeAll(){for(const e of this._urls)URL.revokeObjectURL(e);this._urls.clear()}}const Vt=["üôÇ","ü§î","üòÆ","üò¢","üò°","üòç"],dr={layout:Vt,overrides:{layout:null}};class ur{constructor(e=null,t=new v,s=dr){this.persistence=e,this.bus=t,this.config=s,this.overrideLayout=this._normalizeLayout(s?.overrides?.layout),this.booted=!1}boot(){if(this.booted)return;this.booted=!0;const e=this.persistence?.load?.("drumOverrides");if(Array.isArray(e?.layout))this.overrideLayout=this._normalizeLayout(e.layout);else if(Array.isArray(e))this.overrideLayout=this._normalizeLayout(e.default||e.guide||e);else if(e&&typeof e=="object"){const t=Object.values(e)[0];this.overrideLayout=this._normalizeLayout(t)}}dispose(){}getLayout(){const e=this._getBaseLayout();return this.overrideLayout?.length?e.map((t,s)=>this.overrideLayout[s]||t):e}getLayoutForGhost(){return this.getLayout()}setOverride(e){this.overrideLayout=this._normalizeLayout(e);const t=this.overrideLayout?.length?{layout:this.overrideLayout}:{layout:null};this.persistence?.save?.("drumOverrides",t),this.notifyLayoutChange()}notifyLayoutChange(){const e=this.getLayout();this.bus.emit({type:Dt,layout:e})}_getBaseLayout(){return Array.isArray(this.config?.layout)?[...this.config.layout]:[...Vt]}_normalizeLayout(e){return Array.isArray(e)?e.map(t=>typeof t=="string"?t:"").filter(Boolean):null}}class gr{constructor(e,t,s={},i=null){this.ghostService=e,this.dualityManager=t,this.spiritConfigs=s,this.logger=i}getReactionsForCurrentStage(){const e=this.ghostService?.getCurrentGhost?.()?.name,t=this.dualityManager?.getStageConfig?.(),s=this._extractStageId(t),i=this.getReactionsForStage(e,s);if(!i.length&&this.logger?.warn){const r=e||"unknown-ghost",a=s||"unknown-stage";this.logger.warn(`No reactions configured for ${r}:${a}`)}return i}getReactionsForStage(e,t){if(!e||!t)return[];const s=this.spiritConfigs?.[e];if(!s)return[];const r=(s.reactions||{})[t];return Array.isArray(r)?r.filter(a=>typeof a=="string"&&a.trim().length>0):[]}getPresetForStage(e,t){if(!e||!t)return null;const s=this.spiritConfigs?.[e];if(!s)return null;const i=(s.stages||[]).find(l=>l.id===t||l.quest?.id===t||l.event?.id===t),r=i?.reactionPreset,a=i?.reactions||this.getReactionsForStage(e,t),n=typeof r=="string"?r.trim():"";return n&&a.includes(n)||n&&!a.length?n:a.length?a[0]:null}_extractStageId(e){return!e||typeof e!="object"?null:typeof e.id=="string"&&e.id?e.id:typeof e.quest?.id=="string"&&e.quest.id?e.quest.id:typeof e.event?.id=="string"&&e.event.id?e.event.id:null}}class pr{constructor(e,t,s,i,r=new v,a=console){this.dialogManager=e,this.historyService=t,this.historyBuffer=s,this.ghostService=i,this.bus=r,this.logger=a,this._handler=this._handleEvent.bind(this)}boot(){this.bus?.subscribe?.(this._handler)}dispose(){this.bus?.unsubscribe?.(this._handler)}_handleEvent(e){if(!e||e.type!==X)return;const s=this.ghostService?.getCurrentGhost?.()?.name||null;if(!s){this._log("warn","Skipping reaction persistence because active ghost is unknown.",{event:e});return}const i=this._normalizeReaction(e.reaction),r=this._normalizeOrigin(e.origin),a=this._findMessage(e),n=this._resolveFingerprint(e,a,s);if(!n){this._log("warn","Failed to persist reaction because fingerprint is missing.",{event:e});return}a&&(a.fingerprint||(a.fingerprint=n),a.reaction=i,a.reactionOrigin=r,a.reactionLocked=r==="system"||a.reactionLocked===!0),this.historyBuffer?.updateReaction?.(n,i,r),this.historyService?.setReaction?.(s,n,i,r)}_findMessage(e){const t=this.dialogManager?.dialog;if(!t?.messages?.length)return null;const s=e?.fingerprint;if(s){const r=t.messages.find(a=>a?.fingerprint===s);if(r)return r}const i=e?.messageId;if(i!=null){const r=Number(i);if(!Number.isNaN(r)){const a=t.messages.find(n=>Number(n?.id)===r);if(a)return a}}return null}_resolveFingerprint(e,t,s){return e?.fingerprint?e.fingerprint:t?.fingerprint?t.fingerprint:t&&I({...t,ghost:s})||null}_normalizeReaction(e){return typeof e!="string"?"":e.trim()}_normalizeOrigin(e){return e==="system"||e==="user"?e:"user"}_log(e,t,s){const i=this.logger?.[e];typeof i=="function"&&i.call(this.logger,`[ReactionPersistence] ${t}`,s)}}const mr={guest1:{excludedStages:["guest1-finale"],pending:{messageKey:"reactions.finale.pending",buttonKey:"reactions.finale.recalculate"},success:{titleKey:"reactions.finale.guest1.title",messageKey:"reactions.finale.guest1.message",imageUrl:A("images/artifacts/nectosphere_node_1/artifact_nectosphere_node.webp"),imageAltKey:"reactions.finale.guest1.image_alt"}},guide:{excludedStages:["guide-outro"],pending:{messageKey:"reactions.finale.pending",buttonKey:"reactions.finale.recalculate"},success:{titleKey:"reactions.finale.guide.title",messageKey:"reactions.finale.guide.message",imageUrl:A("images/pencil.png"),imageAltKey:"reactions.finale.guide.image_alt"}}};class fr{constructor(e=new v,t=null,s=null,i={},r=mr,a=null){this.bus=e,this.dualityManager=t,this.ghostService=s,this.spiritConfigs=i||{},this.config=r||{},this.logger=a??new L,this._requirements=new Map,this._stageProgress=new Map,this._messageStage=new Map,this._finaleMessages=new Map,this._pendingCompletion=new Map,this._handler=this._handleEvent.bind(this)}boot(){this.dualityManager?.setCompletionGuard?.(this),this.bus?.subscribe?.(this._handler)}dispose(){this.bus?.unsubscribe?.(this._handler),this._pendingCompletion.clear(),this._finaleMessages.clear(),this._messageStage.clear(),this._stageProgress.clear()}shouldHoldCompletion(e={}){const t=e.dualityId||this._currentGhostId();if(!t||!this._isConfigured(t))return!1;const s=this._finaleMessages.get(t);if(!s)return this.logger?.info?.(`[ReactionFinale] Deferring completion for ${t} until finale message renders.`),this._pendingCompletion.set(t,e.resume||(()=>{})),!0;const i=this._computeMissingStages(t);return i.length===0?(this._publishComplete(t,s),!1):(this._pendingCompletion.set(t,e.resume||(()=>{})),this._publishPending(t,s,i),!0)}_handleEvent(e){if(e){if(e.type===C){this._handleMessageReady(e);return}if(e.type===X){this._handleReaction(e);return}if(e.type===Ot){this._handleRecalculate(e);return}if(e.type===K){this._handleCompletion(e);return}e.type===U&&this._handleDialogClear()}}_handleMessageReady(e){const t=this._currentGhostId();if(!t)return;const s=this._extractFingerprint(e),i=this._extractStageId(e);s&&this._getMessageStageIndex(t).set(s,i);const r=this._normalizeReaction(e.reaction||e.message?.reaction);if(i&&r&&this._markStageSatisfied(t,i),this._isFinaleMessage(e)&&s){const n={fingerprint:s,stageId:i};this._finaleMessages.set(t,n);const l=this._computeMissingStages(t);l.length===0?this._publishComplete(t,n):this._publishPending(t,n,l)}}_handleReaction(e){const t=this._currentGhostId();if(!t)return;const s=e.stageId||this._lookupStageByFingerprint(t,e.fingerprint);if(!s)return;this._normalizeReaction(e.reaction)&&(this._markStageSatisfied(t,s),this._evaluatePendingCompletion(t))}_handleRecalculate(e){const t=e?.ghostId||this._currentGhostId();if(!t)return;const s=this._finaleMessages.get(t);if(!s)return;const i=this._computeMissingStages(t);i.length===0?(this._publishComplete(t,s),this._resumeIfPending(t)):this._publishPending(t,s,i)}_handleCompletion(e){e?.id&&(this._pendingCompletion.delete(e.id),this._finaleMessages.delete(e.id))}_handleDialogClear(){this._messageStage.clear()}_evaluatePendingCompletion(e){const t=this._finaleMessages.get(e);if(!t)return;const s=this._computeMissingStages(e);s.length===0?(this._publishComplete(e,t),this._resumeIfPending(e)):this._pendingCompletion.has(e)&&this._publishPending(e,t,s)}_publishPending(e,t,s){const i=this._resolveConfig(e),r=i?.pending?.messageKey||"reactions.finale.pending",a=i?.pending?.buttonKey||"reactions.finale.recalculate";this.bus?.emit?.({type:ve,ghostId:e,fingerprint:t?.fingerprint||null,stageId:t?.stageId||null,status:"pending",promptKey:r,buttonKey:a,missingStages:[...s]})}_publishComplete(e,t){const s=this._resolveConfig(e),i={type:ve,ghostId:e,fingerprint:t?.fingerprint||null,stageId:t?.stageId||null,status:"complete",titleKey:s?.success?.titleKey||null,messageKey:s?.success?.messageKey||null,imageUrl:s?.success?.imageUrl||"",imageAltKey:s?.success?.imageAltKey||null};this.bus?.emit?.(i),this._resumeIfPending(e)}_resumeIfPending(e){const t=this._pendingCompletion.get(e);if(typeof t=="function"){this._pendingCompletion.delete(e);try{t()}catch(s){this.logger?.error?.(s?.message||s)}}}_markStageSatisfied(e,t){if(!t)return;this._getStageProgress(e).set(t,!0)}_computeMissingStages(e){const t=this._getRequirements(e),s=this._getStageProgress(e),i=[];return t.forEach(r=>{s.get(r)||i.push(r)}),i}_getRequirements(e){if(!this._requirements.has(e)){const t=this._resolveConfig(e);let s=Array.isArray(t?.requiredStages)?t.requiredStages.filter(r=>typeof r=="string"&&r.trim()!==""):[];if(!s.length){const r=this.spiritConfigs?.[e];Array.isArray(r?.stages)?s=r.stages.filter(a=>Array.isArray(a?.reactions)&&a.reactions.length>0).map(a=>a.id||a.event?.id||a.quest?.id).filter(a=>typeof a=="string"&&a.trim()!==""):r?.reactions&&typeof r.reactions=="object"&&(s=Object.keys(r.reactions).filter(a=>typeof a=="string"&&a.trim()!==""))}const i=Array.isArray(t?.excludedStages)?new Set(t.excludedStages.filter(r=>typeof r=="string"&&r.trim()!=="")):null;i&&(s=s.filter(r=>!i.has(r))),this._requirements.set(e,new Set(s))}return this._requirements.get(e)}_getStageProgress(e){return this._stageProgress.has(e)||this._stageProgress.set(e,new Map),this._stageProgress.get(e)}_getMessageStageIndex(e){return this._messageStage.has(e)||this._messageStage.set(e,new Map),this._messageStage.get(e)}_lookupStageByFingerprint(e,t){return t&&this._getMessageStageIndex(e).get(t)||null}_resolveConfig(e){return this.config?.[e]||null}_isConfigured(e){return!!this._resolveConfig(e)}_isFinaleMessage(e){const t=e?.effects||e?.message?.effects;return t?t.reactionFinale===!0||typeof t.reactionFinale=="object":!1}_extractFingerprint(e){return e?.fingerprint?e.fingerprint:e?.message?.fingerprint?e.message.fingerprint:null}_extractStageId(e){return typeof e?.stageId=="string"&&e.stageId.trim()!==""?e.stageId:typeof e?.message?.stageId=="string"&&e.message.stageId.trim()!==""?e.message.stageId:null}_currentGhostId(){return this.ghostService?.getCurrentGhost?.()?.name||null}_normalizeReaction(e){return typeof e!="string"?"":e.trim()}}class Wt{constructor(){this._messages=[],this._fingerprints=new Set}append(e){const t=I(e);if(!t||this._fingerprints.has(t))return;this._fingerprints.add(t);const s=typeof e.reactionOrigin=="string"&&e.reactionOrigin.trim()!==""?e.reactionOrigin.trim():null;this._messages.push({...e,fingerprint:t,reaction:this._normalizeReaction(e.reaction),reactionOrigin:s,reactionLocked:e.reactionLocked===!0||s==="system"})}merge(e=[]){const t=new Set;(e||[]).forEach(i=>{const r=I(i);r&&(t.add(r),this._fingerprints.has(r)||this._fingerprints.add(r))});const s=this._messages.filter(i=>!t.has(i.fingerprint));return this._messages=[...e,...s],[...s]}updateUserAvatars(e){this._messages=this._messages.map(t=>t.author==="user"?{...t,avatar:e}:t)}updateReaction(e,t,s=null){if(!e)return;const i=this._normalizeReaction(t);this._messages=this._messages.map(r=>r.fingerprint===e?{...r,reaction:i,reactionOrigin:s||r.reactionOrigin||null,reactionLocked:s==="system"||r.reactionLocked===!0}:r)}flushTo(e,t){this._messages.length&&e?.append?.(t,this._messages)}clear(){this._messages.length=0}reset(){this._messages.length=0,this._fingerprints.clear()}getAll(){return this._messages.map(e=>({...e}))}_normalizeReaction(e){return typeof e!="string"?"":e.trim()}}class _r{constructor({header:e="üß≠R",confirmation:t="‚úÖ",searchToken:s="üîé",context:i="üßäüñº‚õìÔ∏èüôà",phase:r="üß±",channel:a="üñº"}={}){this.header=e,this.confirmation=t,this.searchToken=s,this.context=i,this.phase=r,this.channel=a}buildDetectionReply(e=""){const t=e?`${this.searchToken}${e}`:this.searchToken;return[this.header,this.confirmation,t,this.context,this.phase,this.channel].join(`
`)}}class yr{constructor(e,t,s,i,r,a,n,l,c,h=null,d=new v,p=null,u=new Wt,g=ge,m=jt,f=null){this.dualityManager=e,this.dialogManager=t,this.ghostService=s,this.buttonStateService=i,this.buttonVisibilityService=r,this.historyService=a,this.avatarService=n,this.ghostSwitchService=l,this.spiritConfigs=c||{},this.inputGate=h,this.bus=d,this.started=!1,this._handler=null,this._readyHandler=null,this.waitingForWidget=!1,this.currentGhost=null,this.onMessenger=!1,this.initializedGhosts=new Set,this.historyBuffer=u,this._widgetReady=!1,this._lastReplayedIndex=-1,this._hasAdvanced=!1,this._replayedFingerprints=new Map,this.postLocked=!1,this._pendingPosts=[],this.logger=p??new L,this.store=g,this.userAvatar="",this.awaitingAvatar=!1,this.autoReplyBuilder=new _r,this._pendingAvatarRefresh=!1,this.engineEnabled=m,this.rebootCheckpointService=f,this.effectHandlers={[we]:()=>this.dialogManager.progress(),[Ee]:()=>{const y=this.currentGhost;if(!y)return;const b=this.dialogManager.dialog,w=b?.messages?.slice(0,b.index)||[];this.historyService?.appendUnique?.(y,w)}}}_runEffects(e=[]){e.forEach(t=>{const s=this.effectHandlers[t.type];s&&s(t.payload)})}async _loadConfig(e){return this.spiritConfigs?.[e]||{}}async _prepareConfig(e,t){const s=await this.avatarService?.getUserAvatar?.();this.awaitingAvatar=!s;const i=(t.stages||[]).map((r,a)=>{const n=r.id||r.event?.id||r.quest?.id||`stage-${a}`;return{...r,event:{...r.event,messages:(r.event?.messages||[]).map(l=>{const c=this._resolveAutoGeneratedText(l,r),h=typeof l.text=="string"?l.text:c||"",d=l.stageId||n;return{...l,text:h,stageId:d,avatar:l.avatar||(l.author==="ghost"?t.avatar:s||""),fingerprint:I({ghost:e,stageId:d,author:l.author,text:h,type:l.type||"",src:l.src||l.media&&(l.media.id||l.media.src)||"",fingerprint:l.fingerprint})}})}}});return{cfg:{...t,stages:i},userAvatar:s}}_resolveAutoGeneratedText(e={},t={}){if(!e||typeof e!="object"||e.type==="image"||e.type==="youtube"||e.author!=="user"||typeof e.text=="string"&&e.text.trim()!==""||!(e.autoGenerated===!0||typeof e.autoGenerated=="object"||typeof e.autoReplyTarget=="string"))return null;const i=typeof e.autoGenerated=="object"?e.autoGenerated:{},r=typeof e.autoReplyTarget=="string"&&e.autoReplyTarget.trim()||typeof i.targetEmoji=="string"&&i.targetEmoji.trim()||typeof i.target=="string"&&i.target.trim()||"";return r||this.logger?.warn?.("[Dialog] auto-generated reply missing target emoji",{stageId:t?.id||t?.event?.id||null}),this.autoReplyBuilder.buildDetectionReply(r)}_normalizeHistory(e,t=""){const s=Date.now()-e.length,i=new Set,r=[];return e.forEach((a,n)=>{const l=a.media||(a.media_id?{id:a.media_id}:void 0),c=I({...a,media:l,ghost:t}),h=a.fingerprint??a.id??c;if(h!==void 0&&i.has(h))return;h!==void 0&&i.add(h);const d={...a,...l?{media:l}:{},timestamp:a.timestamp??s+n,id:typeof a.id=="number"?a.id:n,order:typeof a.order=="number"?a.order:n+1,fingerprint:c};delete d.media_id,r.push(d)}),r}_replayHistory(e){const t=this.currentGhost,s=new Set,i=[];if(this._replayedFingerprints.clear(),e.forEach((r,a)=>{const n=r.media||(r.media_id?{id:r.media_id}:void 0);n&&(r.media=n,delete r.media_id),r.fingerprint===void 0&&(r.fingerprint=I({...r,ghost:t})),typeof r.id!="number"&&(r.id=a),this._replayedFingerprints.set(a,{id:r.id,fingerprint:r.fingerprint});const l=r.fingerprint??r.id;l!==void 0&&s.has(l)||(l!==void 0&&s.add(l),!this.historyService?.has?.(t,r)&&i.push(r))}),!i.length){this.bus.emit({type:U});return}this.bus.emit({type:U}),i.forEach(r=>{const{type:a,...n}=r;this.bus.emit({type:C,replay:!0,...n,message:r}),this.historyService?.markSeen?.(t,r)})}_refreshLastReplayedIndex(){const e=(this.dialogManager.dialog?.index??0)-1;e>this._lastReplayedIndex&&(this._hasAdvanced=!0),this._lastReplayedIndex=e}_syncLastReplayedIndex(){this._lastReplayedIndex=(this.dialogManager.dialog?.index??0)-1,this._hasAdvanced=!1}_updatePostLockFromDialogState(){const e=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog?.index],t=this.onMessenger&&!this.dialogManager.dialog?.isComplete?.()&&e?.author==="user";this.postLocked=!t}_resetRuntimeState({keepWidgetReady:e=!1}={}){this.historyBuffer?.reset?.(),this._pendingPosts=[],this._replayedFingerprints.clear(),this._lastReplayedIndex=-1,this._hasAdvanced=!1,this.postLocked=!1,this.waitingForWidget=!1,this._pendingAvatarRefresh=!1,e||(this._widgetReady=!1)}_handleAppReset(){this._resetRuntimeState({keepWidgetReady:!1}),this.inputGate?.reset?.(),this.started=!1,this.onMessenger=!1,this.currentGhost=null,this.initializedGhosts.clear(),this.userAvatar="",this.awaitingAvatar=!1,this.historyService?.reset?.()}async _handleGhostReset(e){const t=e?.payload?.ghost||this.ghostService?.getCurrentGhost?.()?.name;if(!t)return;const s=await this._loadConfig(t),{cfg:i,userAvatar:r}=await this._prepareConfig(t,s);if(this._resetRuntimeState({keepWidgetReady:!0}),this.inputGate?.reset?.(),this.historyService?.clear?.(t),this.rebootCheckpointService?.clearGhost?.(t),this.currentGhost=t,this.initializedGhosts.delete(t),this.dualityManager.resetProgress?.(i),this.dualityManager.load(i),this.dialogManager.dialog=this.dualityManager.getCurrentDialog(),!this.dialogManager.dialog){this.logger.error(`Missing dialog for ghost "${t}" after reset`);return}this.userAvatar=r,this.dialogManager.dialog.restore(0),this._replayHistory([]),this._syncLastReplayedIndex();const a=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog.index];this.waitingForWidget=this.onMessenger&&a?.author==="ghost",this.onMessenger&&this._widgetReady&&(this.waitingForWidget&&this._maybeStart(),this._advanceGate()),this.bus.emit({type:si,payload:{ghost:t}})}_buildHistorySnapshot(e){const t=this._normalizeHistory(this.historyService?.load?.(e)||[],e),s=this._normalizeHistory(this.historyBuffer?.getAll?.()||[],e),i=new Set,r=[];return[...t,...s].forEach(a=>{const n=a.fingerprint??`${a.author}:${a.text}:${a.timestamp}`;i.has(n)||(i.add(n),r.push({...a}))}),r}_captureRebootCheckpoint(e){if(!e)return;const t=this._buildHistorySnapshot(e);this.rebootCheckpointService?.saveCheckpoint?.(e,{ghost:e,history:t,savedAt:Date.now()})}async _handleGhostReboot(e){const t=e?.payload?.ghost||this.ghostService?.getCurrentGhost?.()?.name;if(!t)return;const s=await this._loadConfig(t),{cfg:i,userAvatar:r}=await this._prepareConfig(t,s);if(this._resetRuntimeState({keepWidgetReady:!0}),this.inputGate?.reset?.(),this.currentGhost=t,this.initializedGhosts.delete(t),this.dualityManager.resetProgress?.(i),this.dualityManager.load(i),this.dialogManager.dialog=this.dualityManager.getCurrentDialog(),!this.dialogManager.dialog){this.logger.error(`Missing dialog for ghost "${t}" after reboot`);return}this.userAvatar=r;const a=this.rebootCheckpointService?.getCheckpoint?.(t),n=this._normalizeHistory(a?.history||[],t).map(h=>({...h,avatar:h.avatar||(h.author==="ghost"?i.avatar:r||"")})),l=this.dialogManager.dialog,c=l.messages.slice(n.length);l.messages=[...n,...c],l.restore(n.length),this._replayHistory(n),this._syncLastReplayedIndex(),this.waitingForWidget=!1,this.onMessenger&&this._widgetReady&&(this._maybeStart(),this._advanceGate()),this.bus.emit({type:ii,payload:{ghost:t,hasCheckpoint:n.length>0}})}async _refreshUserAvatar(){const e=await this.avatarService?.getUserAvatar?.()||"";this.userAvatar=e;const t=this.dialogManager.dialog;let s=0;t?.messages&&(t.messages.forEach(r=>{r.author==="user"&&(r.avatar=e)}),t.messages.slice(0,t.index).forEach(r=>{r.author==="user"&&(this.bus.emit({type:C,replay:!0,...r,message:r}),s++)})),this.historyBuffer?.updateUserAvatars?.(e),this.logger?.info?.(`Refreshed user avatar to '${e}', re-emitted ${s} messages`)}_advanceGate(){const e=this.dialogManager.dialog,t=e?.index??0,s=this._replayedFingerprints.get(t);s&&e&&e.messages[t]&&(e.messages[t].fingerprint===void 0&&(e.messages[t].fingerprint=s.fingerprint),typeof e.messages[t].id!="number"&&(e.messages[t].id=s.id)),this.inputGate?.advanceToUserTurn?.(e,this._replayedFingerprints),(this.dialogManager.dialog?.index??0)!==t&&this._widgetReady&&this._refreshLastReplayedIndex()}_maybeStart(){if(!this.waitingForWidget||!this._widgetReady)return!1;this.waitingForWidget=!1;const e=this.currentGhost;if(!this.initializedGhosts.has(e)&&(this.dualityManager.start(),this.initializedGhosts.add(e),this._refreshLastReplayedIndex(),typeof this.inputGate?.advanceToUserTurn!="function")){let t=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog.index];for(;t&&t.author==="ghost";){const s=this.store.dispatch(V());this.engineEnabled?this._runEffects(s):this.dialogManager.progress(),this._refreshLastReplayedIndex(),t=this.dialogManager.dialog.messages[this.dialogManager.dialog.index]}}return this.dialogManager.dialog?.isComplete?.()&&this._hasAdvanced&&this.dualityManager.completeCurrentEvent(),!0}boot(){this._readyHandler=async e=>{if(e.type===oe){if(this._widgetReady=!0,this.dialogManager.dialog){const t=this.ghostService.getCurrentGhost().name,s=this._normalizeHistory(this.historyService.load(t)||[],t),i=this.historyBuffer.merge(s),r=[...s,...i];if(r.length>0){const a=this.dialogManager.dialog,n=a.messages.slice(s.length);a.messages=[...r,...n],a.restore(r.length),this._replayHistory(r),this._syncLastReplayedIndex()}this.historyBuffer.clear()}this._pendingAvatarRefresh&&(await this._refreshUserAvatar(),this._pendingAvatarRefresh=!1),this._maybeStart(),this._advanceGate(),this._pendingPosts.length&&(this._replayHistory(this._pendingPosts),this.postLocked=!1,this._pendingPosts=[])}},this.bus?.subscribe?.(this._readyHandler),this._handler=async e=>{if(e.type===Me){this.awaitingAvatar=!1,this._pendingAvatarRefresh=!0,this._widgetReady&&(await this._refreshUserAvatar(),this._pendingAvatarRefresh=!1);return}if(e.type===q){this._handleAppReset(),this.rebootCheckpointService?.reset?.();return}if(e.type===wt){await this._handleGhostReset(e);return}if(e.type===Et){await this._handleGhostReboot(e);return}if((e.type===ae||e.type===K)&&this._captureRebootCheckpoint(this.currentGhost||this.ghostService?.getCurrentGhost?.()?.name),e.type==="SCREEN_CHANGE")if(this.waitingForWidget=!1,e.screen==="messenger"){this.onMessenger=!0;const t=this.ghostService.getCurrentGhost().name;this.historyService?.clearSeen?.(t);const s=this.historyService?.load?.(t)||[];let i=this._normalizeHistory(s,t);if(this.started)this.dialogManager.dialog?.restore?.(i.length);else{const a=await this._loadConfig(t),{cfg:n,userAvatar:l}=await this._prepareConfig(t,a);if(this.userAvatar=l,this.dualityManager.load(n),this.dialogManager.dialog=this.dualityManager.getCurrentDialog(),!this.dialogManager.dialog){this.logger.error(`Missing dialog for ghost "${t}"`);return}this.buttonVisibilityService?.setScreenVisibility?.("camera","capture-btn",!1),i=i.map(d=>({...d,avatar:d.avatar||(d.author==="ghost"?n.avatar:l||"")}));const c=this.dialogManager.dialog,h=c.messages.slice(i.length);c.messages=[...i,...h],c.restore(i.length),this.started=!0,this.currentGhost=t}const r=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog.index];if(this._updatePostLockFromDialogState(),this._widgetReady){const a=this.historyBuffer.merge(i),n=[...i,...a],l=this.dialogManager.dialog,c=l.messages.slice(i.length);l.messages=[...n,...c],l.restore(n.length),this._replayHistory(n),this._syncLastReplayedIndex(),this.historyBuffer.clear(),this._maybeStart(),this._advanceGate()}else this.waitingForWidget=i.length===0&&r?.author==="ghost"}else this.onMessenger&&(this.postLocked=!1,this._widgetReady=!1,this.historyBuffer.flushTo(this.historyService,this.currentGhost),this.historyBuffer.reset(),this.onMessenger=!1);if(e.type==="GHOST_CHANGE"&&this.started){this.waitingForWidget=!1;const t=this.ghostService.getCurrentGhost().name,s=this.currentGhost;if(t===s)return;this.inputGate?.reset?.(),this.currentGhost=t;const i=this.dialogManager.dialog?.messages?.slice(0,this.dialogManager.dialog?.index)||[];this.historyBuffer.flushTo(this.historyService,s),this.historyBuffer.reset(),this.historyService?.save?.(s,i);const r=await this._loadConfig(t),{cfg:a,userAvatar:n}=await this._prepareConfig(t,r);if(this.userAvatar=n,this.dualityManager.load(a),this.dialogManager.dialog=this.dualityManager.getCurrentDialog(),!this.dialogManager.dialog){this.logger.error(`Missing dialog for ghost "${t}"`);return}this.buttonVisibilityService?.setScreenVisibility?.("camera","capture-btn",!1);const l=this.historyService?.load?.(t)||[];this.historyService?.clearSeen?.(t);const c=this._normalizeHistory(l,t).map(u=>({...u,avatar:u.avatar||(u.author==="ghost"?a.avatar:n||"")})),h=this.dialogManager.dialog,d=h.messages.slice(c.length);h.messages=[...c,...d],h.restore(c.length),this._replayHistory(c),this._syncLastReplayedIndex();const p=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog.index];this.waitingForWidget=c.length===0&&p?.author==="ghost",this._updatePostLockFromDialogState(),this._maybeStart(),this._advanceGate()}if(e.type===C&&(this.historyBuffer.append({...e.message||e,ghost:this.currentGhost}),e.replay||(this._widgetReady&&this._refreshLastReplayedIndex(),this._updatePostLockFromDialogState(),this._advanceGate(),this._updatePostLockFromDialogState())),e.type==="post"){if(this.postLocked)return;this.postLocked=!0;const t=this.dialogManager.dialog?.index,s=this.dialogManager.dialog?.messages?.[t];if(s?.author==="user"){const r=await this.avatarService?.getUserAvatar?.();s.avatar=r||""}if(!this._widgetReady&&s){const r={...s};r.timestamp===void 0&&(r.timestamp=Date.now()),this.historyBuffer.append({...r,ghost:this.currentGhost}),this._pendingPosts.push(r)}if(typeof this.inputGate?.progressDialog=="function")this.inputGate.progressDialog();else{const r=this.store.dispatch(V());this.engineEnabled?this._runEffects(r):this.dialogManager.progress()}this._refreshLastReplayedIndex();let i=this.dialogManager.dialog?.isComplete?.();if(i&&this._hasAdvanced&&this.dualityManager.completeCurrentEvent(),typeof this.inputGate?.advanceToUserTurn=="function")this._advanceGate();else{let r=this.dialogManager.dialog?.messages?.[this.dialogManager.dialog.index];for(;r&&r.author==="ghost";){const a=this.store.dispatch(V());this.engineEnabled?this._runEffects(a):this.dialogManager.progress(),this._refreshLastReplayedIndex(),r=this.dialogManager.dialog.messages[this.dialogManager.dialog.index]}}!i&&this.dialogManager.dialog?.isComplete?.()&&this._hasAdvanced&&this.dualityManager.completeCurrentEvent()}if(e.type===Y&&(this.buttonStateService?.setScreenState?.("main","toggle-camera",!0),this._advanceGate(),this._updatePostLockFromDialogState()),e.type===ae){const t=this.dualityManager.getCurrentDialog(),s=this.dialogManager.dialog,i=s.messages.length;if(s.messages.push(...t.messages),s.restore(i),typeof this.inputGate?.advanceToUserTurn=="function")this._advanceGate();else{let r=s.messages[s.index];for(;r&&r.author==="ghost";){const a=this.store.dispatch(V());this.engineEnabled?this._runEffects(a):this.dialogManager.progress(),this._refreshLastReplayedIndex(),r=s.messages[s.index]}}s.isComplete?.()&&this._hasAdvanced&&(this.buttonStateService?.setState?.("post",!1,"main"),this.dualityManager.completeCurrentEvent()),this._updatePostLockFromDialogState()}if(e.type===K){const t=e.id||this.currentGhost;this.ghostSwitchService?.markCompleted?.(t,this.spiritConfigs),this.buttonStateService?.setScreenState?.("messenger","switch-ghost",!0)}},this.bus?.subscribe?.(this._handler)}dispose(){this._handler&&(this.bus?.unsubscribe?.(this._handler),this._handler=null),this._readyHandler&&(this.bus?.unsubscribe?.(this._readyHandler),this._readyHandler=null)}}class br{constructor(e='[data-js="dialog-list"]',t=new v){this.selector=e,this.bus=t,this.step=J.chatScrollStep,this._container=null,this._handler=s=>this._handle(s),this._screenHandler=s=>{s.type==="SCREEN_CHANGE"&&(s.screen==="messenger"?(typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):r=>setTimeout(r,0))(()=>this._bind()):this._unbind())},this._scrollListener=()=>{if(!this._container)return;const{scrollTop:s}=this._container;s<=0&&this.bus.emit({type:le})},this._observer=null}_resolve(){return typeof document>"u"?null:typeof this.selector=="string"?document.querySelector(this.selector):this.selector}_bind(){this._unbind();const e=this._resolve();e?(e.addEventListener("scroll",this._scrollListener),this._container=e):(this._observer=new MutationObserver(()=>{const t=this._resolve();t&&(this._observer?.disconnect(),this._observer=null,t.addEventListener("scroll",this._scrollListener),this._container=t)}),this._observer.observe(document.body,{childList:!0,subtree:!0}))}_unbind(){this._observer&&(this._observer.disconnect(),this._observer=null),this._container&&(this._container.removeEventListener("scroll",this._scrollListener),this._container=null)}boot(){this.bus.subscribe(this._handler),this.bus.subscribe(this._screenHandler),this._bind()}dispose(){this.bus.unsubscribe(this._handler),this.bus.unsubscribe(this._screenHandler),this._unbind()}_handle(e){const t=this._container||this._resolve();t&&(e.type===ni?(t.scrollBy(0,-this.step),t.scrollTop<=0&&this.bus.emit({type:le})):e.type===oi&&t.scrollBy(0,this.step))}}class vr extends br{constructor(e='[data-js="dialog-list"]',t=new v){super(e,t)}boot(){super.boot()}}class Sr{constructor(e,t,s,i=new v){this.dialogManager=e,this.historyService=t,this.ghostService=s,this.bus=i,this._handler=null}boot(){this._handler=e=>{if(e.type!==C||e.replay)return;const t=this.ghostService?.getCurrentGhost?.().name,s=e.message||e;queueMicrotask(()=>{this.historyService?.append?.(t,[s])})},this.bus?.subscribe?.(this._handler)}dispose(){this._handler&&(this.bus?.unsubscribe?.(this._handler),this._handler=null)}}class wr{constructor(e,t,s,i=new v,r=console){this.config=e||{},this.database=t,this.persistence=s,this.bus=i,this.logger=r,this._handler=this._handleEvent.bind(this)}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler)}async _handleEvent(e){e?.type===ue&&await this._performReset(e.payload||{})}async _performReset(e){const s={...this.config.reset||{},...e.options||{}};try{s.clearDatabase!==!1&&await this.database?.clearAll?.(),s.clearStorage!==!1&&this.persistence?.clear?.(),this.bus.emit({type:q,payload:{options:s}});const i=s.initialScreen||"welcome";i&&this.bus.emit({type:"SCREEN_CHANGE",screen:i,options:{force:!0}})}catch(i){this.logger?.error?.(`ResetService: reset failed - ${i?.message||i}`)}}}class Er{constructor(e,t,s,i,r=new v,a=console){this.profileService=e,this.postsService=t,this.historyService=s,this.ghostService=i,this.bus=r,this.logger=a,this._handler=this._handleEvent.bind(this),this._booted=!1}boot(){this._booted||(this.bus.subscribe(this._handler),this._booted=!0)}dispose(){this._booted&&(this.bus.unsubscribe(this._handler),this._booted=!1)}async _handleEvent(e){e&&(e.type===Ct&&await this._handleExport(e.payload||{}),e.type===Rt&&await this._handleImport(e.payload||{}))}async _handleExport(e){try{const t=e.password||"",s=await this.postsService?.exportAllByGhost?.(),i=this.historyService?.exportAll?.()||{},r={...s};Object.entries(i||{}).forEach(([c,h])=>{r[c]||(r[c]={}),r[c]={...typeof r[c]=="object"&&!Array.isArray(r[c])?r[c]:{posts:r[c]||[]},dialog:h}});const a={};Object.entries(r).forEach(([c,h])=>{const d=Array.isArray(h.posts)?h.posts:Array.isArray(h)?h:[],p=Array.isArray(h.dialog)?h.dialog:[];a[c]={posts:d,dialog:p}});const n={currentGhost:this.ghostService?.getCurrentGhost?.()?.name||null},l=await this.profileService.exportProfile(t,{ghosts:a,meta:n});this.bus.emit({type:It,payload:{blob:l,meta:n}})}catch(t){this._reportFailure("export",t)}}async _handleImport(e){try{const{buffer:t,password:s=""}=e;if(!(t instanceof ArrayBuffer))throw new Error("Invalid profile payload");const i={arrayBuffer:async()=>t},r=await this.profileService.importProfile(i,s),a=r?.ghosts||{},n=r?.meta||{},l={},c={};Object.entries(a).forEach(([d,p])=>{Array.isArray(p?.posts)&&(l[d]=p.posts),Array.isArray(p?.dialog)&&(c[d]=p.dialog)}),await this.postsService?.replaceAllByGhost?.(l),this.historyService?.replaceAll?.(Object.entries(c).reduce((d,[p,u])=>(d[p]=u,d),{}));const h=n.currentGhost||this.ghostService?.defaultGhost;h&&this.ghostService?.setCurrentGhost&&this.ghostService.setCurrentGhost(h),this.bus.emit({type:Lt,payload:{ghosts:Object.keys(a)}})}catch(t){this._reportFailure("import",t)}}_reportFailure(e,t){const s=t?.message||String(t);this.logger?.error?.(`ProfileTransferService: ${e} failed - ${s}`),this.bus.emit({type:Mt,payload:{operation:e,message:s}})}}const Ar={},ze="effects:overrides";class Rr{constructor(e=new v,t=null,s=null,i=null,r=Ar,a=null,n={}){this.bus=e,this.persistence=t,this.ghostService=s,this.dualityManager=i,this.logger=a??new L,this.baseConfig=r||{},this.spiritConfigs=n||{},this.overrides=this._loadPersistedOverrides(),this.runtimeOverrides={},this.activeStage=0,this.activeGhost=this.ghostService?.getCurrentGhost?.().name||null,this.current=new Map,this._handler=this._onEvent.bind(this),this._booted=!1}boot(){this._booted||(this.bus?.subscribe?.(this._handler),this._booted=!0,this._emitForCurrentContext("boot",{includeStage:!1}))}dispose(){this._booted&&(this.bus?.unsubscribe?.(this._handler),this._booted=!1,this.runtimeOverrides={},this.current.clear())}setSpiritConfigs(e={}){this.spiritConfigs=e,this._emitForCurrentContext("config-refresh")}_onEvent(e={}){switch(e.type){case Zs:this._applyUpdate(e);break;case dt:this.activeStage=this.dualityManager?.getCurrentStageIndex?.()??0,this.runtimeOverrides={},this._emitForCurrentContext("duality-start");break;case ae:this.activeStage=typeof e.index=="number"?e.index:this.dualityManager?.getCurrentStageIndex?.()??0,this.runtimeOverrides={},this._emitForCurrentContext("stage-change");break;case ut:this._emitForCurrentContext("event-start");break;case q:this.runtimeOverrides={},this.activeStage=0,this.activeGhost=this.ghostService?.getCurrentGhost?.().name||null,this._emitForCurrentContext("app-reset");break;default:e.type==="GHOST_CHANGE"&&(this.activeGhost=e.payload?.name||this.ghostService?.getCurrentGhost?.().name||null,this.runtimeOverrides={},this._emitForCurrentContext("ghost-change"));break}}_applyUpdate(e){const t=e.effect||e.name;if(!t)return;const s={...e.values||e.config||e.updates||{}},i=e.replace===!0,r=e.persist===!0;i?this.runtimeOverrides[t]={...s}:this.runtimeOverrides[t]={...this.runtimeOverrides[t]||{},...s},r&&this._persistEffect(t,this.runtimeOverrides[t]),this._emitEffect(t,"manual-update")}_emitForCurrentContext(e="",t={}){const s=Object.keys(this.baseConfig||{});s.length&&s.forEach(i=>this._emitEffect(i,e,t))}_emitEffect(e,t="",s={}){const i=this._buildEffectConfig(e,s);i&&(this.current.set(e,i),this.bus?.emit?.({type:ei,effect:e,config:i,reason:t,ghost:this.activeGhost,stage:this.activeStage}))}_buildEffectConfig(e,{includeStage:t=!0}={}){const s=this._clone(this.baseConfig?.[e]?.defaults||{}),i=this._clone(this._getGhostDefaults(e)),r=this._clone(this.overrides?.[e]||{}),a=t?this._clone(this._getStageOverrides(e)||{}):{},{persist:n,replace:l,...c}=a;n&&Object.keys(c).length>0&&this._persistEffect(e,c);const h=this._clone(this.runtimeOverrides?.[e]||{});let d={...s,...i,...r};return l===!0?d={...d,...c}:d={...d,...c},d={...d,...h},d}_persistEffect(e,t={}){if(!this.persistence||!t||Object.keys(t).length===0)return;const s=this.overrides?.[e]||{},i={...s,...t};if(!this._isShallowEqual(s,i)){this.overrides={...this.overrides||{},[e]:i};try{this.persistence.save?.(ze,this.overrides),this.bus?.emit?.({type:ti,effect:e,overrides:this._clone(this.overrides[e])})}catch(r){this.logger?.warn?.(`Failed to persist effect overrides: ${r?.message||r}`)}}}_getGhostDefaults(e){if(!this.activeGhost)return{};const t=this.spiritConfigs?.[this.activeGhost];if(!t)return{};const i=(t.effects||{})[e];return i?i.defaults&&typeof i.defaults=="object"?i.defaults:i:{}}_getStageOverrides(e){if(!this.activeGhost)return{};const t=this.spiritConfigs?.[this.activeGhost];if(!t?.stages)return{};const s=t.stages?.[this.activeStage];if(!s?.effects)return{};const i=s.effects[e];return!i||typeof i!="object"?{}:i}_loadPersistedOverrides(){if(!this.persistence)return{};try{const e=this.persistence.load?.(ze)||{};return typeof e=="object"&&e!==null?e:{}}catch(e){return this.logger?.warn?.(`Failed to load effect overrides: ${e?.message||e}`),{}}}_clone(e){return!e||typeof e!="object"?e:Array.isArray(e)?e.slice():{...e}}_isShallowEqual(e={},t={}){const s=Object.keys(e||{}),i=Object.keys(t||{});return s.length!==i.length?!1:s.every(r=>e[r]===t[r])}}class Lr{constructor(e,t,s,i=ge){this.dialogManager=e,this.dualityManager=t,this.bus=s,this.store=i,this._lastGhostIndex=-1}reset(){this._lastGhostIndex=-1}advanceToUserTurn(e=this.dialogManager?.dialog,t=null){if(!e){this._emit(!1);return}for(;!e.isComplete?.();){const i=e.index;if(i===this._lastGhostIndex)break;const r=e.messages?.[i];if(r&&r.author==="ghost"){const a=t?.get?.(i);a&&(r.fingerprint===void 0&&(r.fingerprint=a.fingerprint),typeof r.id!="number"&&(r.id=a.id)),this._lastGhostIndex=i,this.progressDialog();continue}break}e.messages?.[e.index]?.author==="user"&&(this._lastGhostIndex=e.index-1);const s=e.messages?.[e.index];if(s&&s.author==="user"){this._emit(!0,"user_text","messenger");return}if(this.dualityManager?.isQuestActive?.()){this._emit(!0,"camera_capture","camera");return}this._emit(!1)}boot(){}progressDialog(){this.store.dispatch(V()).forEach(t=>{t.type==="dialog.progress"&&this.dialogManager.progress()})}_emit(e,t=null,s=null){this.bus?.emit({type:xt,awaits:e,kind:t,targetScreen:s})}}class Tr{constructor(e=null,t="ghostRebootCheckpoints"){this.persistence=e,this.storageKey=t,this.cache=this._loadAll()}saveCheckpoint(e,t){!e||typeof t!="object"||t===null||(this.cache[e]={...t,history:Array.isArray(t.history)?t.history.map(s=>({...s})):[]},this._persist())}getCheckpoint(e){if(!e)return null;const t=this.cache[e];return t?{...t,history:Array.isArray(t.history)?t.history.map(s=>({...s})):[]}:null}clearGhost(e){e&&e in this.cache&&(delete this.cache[e],this._persist())}reset(){this.cache={},this._persist()}_loadAll(){const e=this.persistence?.load?.(this.storageKey);return!e||typeof e!="object"?{}:{...e}}_persist(){this.persistence?.save?.(this.storageKey,this.cache)}}class Cr{constructor(e,t,s,i,r,a,n,l,c,h,d,p,u,g,m,f=new v,y=null,b=null,w=null,x=null,F=null){this.templateService=e,this.panelService=t,this.languageManager=s,this.profileRegService=i,this.geoService=r,this.bus=f,this.db=a,this.postsService=n,this.detectionService=l,this.cameraService=c,this.cameraSectionManager=h,this.notificationManager=d,this.logger=p,this.storage=u,this.buttonStateService=g,this.dualityManager=m,this.ghostService=y,this.historyService=b,this.historyBuffer=w,this.mediaRepository=x,this.loginPrefillService=F,this._booted=!1,this.currentScreen=null,this.lastDetection=null,this._nextHandler=async _=>{if(_.type!=="next")return;let S=null;this.currentScreen==="welcome"?S="registration":this.currentScreen==="registration"&&this.profileRegService?.canProceed()?S="apartment-plan":this.currentScreen==="apartment-plan"&&(S="registration-camera"),S&&S!==this.currentScreen&&this.bus.emit({type:"SCREEN_CHANGE",screen:S})},this._handler=async _=>{if(!_||_.type!=="SCREEN_CHANGE")return;if((this.currentScreen==="camera"||this.currentScreen==="registration-camera")&&_.screen!==this.currentScreen&&(this.bus.emit({type:"CAMERA_VIEW_CLOSED"}),this.cameraSectionManager?.cameraService?.stopStream?.(),this.cameraSectionManager?.stop?.()),this.currentScreen==="messenger"&&_.screen!=="messenger"){const E=this.ghostService?.getCurrentGhost?.()?.name;this.historyBuffer?.flushTo?.(this.historyService,E)}if(_.screen==="registration-camera"||_.screen==="camera"){this.cameraSectionManager?.stateService?.resetCaptured?.(),this.cameraSectionManager?.stateService?.resetPresence?.(),this.storage?.remove?.("captured");const T={cameraType:_.screen==="registration-camera"?"registration":"quest",force:_.screen==="registration-camera"?!0:_.options?.force,onDetected:(Z,M,B,ee)=>this.bus.emit({type:ne,target:Z,blob:M,box:B,mask:ee}),..._.options};this.bus.emit({type:_t,screen:_.screen,camera:{options:T,panel:{screen:_.screen}}})}else{const E={};if(_.screen==="messenger"){const T=await this.postsService.getPostsForCurrent();E.posts=T}_.screen==="registration"&&(this.loginPrefillService?.prefillIfNeeded?.(),E.registration={name:this.profileRegService?.name||""}),this.bus.emit({type:ft,screen:_.screen,payload:_.payload||{},view:E}),_.screen==="messenger"&&E.posts&&this.bus.emit({type:be,posts:E.posts})}const S=this.buttonStateService?.getStatesForScreen?.(_.screen)||{};Object.entries(S).forEach(([E,T])=>{this.bus.emit({type:N,button:E,active:T,screen:_.screen})}),this.currentScreen=_.screen},this._geoHandler=async _=>{if(_.type==="detect-geo")try{const S=await this.geoService.getCurrentLocation();this.bus.emit({type:bt,status:S?{mode:"coords",coords:S}:{mode:"local"},panel:{screen:"apartment-plan",cameraSectionManager:this.cameraSectionManager}}),this.bus.emit({type:"NEXT_BUTTON_ENABLE",enabled:!0})}catch(S){this.geoService.logger?.error(S.message)}},this._mainHandler=async _=>{_.type==="post"?await this.publishPost():_.type==="toggle-camera"||_.type==="toggle-messenger"?this.toggleCameraSection():_.type==="reset-data"&&await this.resetData()},this._captureHandler=_=>this.handleCaptureEvents(_),this._registrationHandler=_=>{if(_.type!==yt)return;const S=_.payload?.value||"";this.profileRegService.setName(S),this.bus.emit({type:"NEXT_BUTTON_ENABLE",enabled:this.profileRegService.canProceed()}),this.bus.emit({type:"enter-name",payload:{value:S}})}}boot(){this._booted||(this._booted=!0,this.bus.subscribe(this._handler),this.bus.subscribe(this._nextHandler),this.bus.subscribe(this._geoHandler),this.bus.subscribe(this._mainHandler),this.bus.subscribe(this._captureHandler),this.bus.subscribe(this._registrationHandler))}dispose(){this.bus.unsubscribe(this._handler),this.bus.unsubscribe(this._nextHandler),this.bus.unsubscribe(this._geoHandler),this.bus.unsubscribe(this._mainHandler),this._captureHandler&&this.bus.unsubscribe(this._captureHandler),this._registrationHandler&&this.bus.unsubscribe(this._registrationHandler)}handleCaptureEvents=async e=>{if(e.type==="capture-btn"){if(this.lastDetection?.blob){if(this.bus.emit({type:"CAMERA_STATUS",status:"hidden"}),this.currentScreen==="camera"){const n=(this.dualityManager?.getQuest?.()||null)?.overlay||{};await this.cameraSectionManager.captureOverlay(n,this.lastDetection.blob,this.lastDetection.box,this.lastDetection.mask)}else{const a=await this._storeAvatarFromBlob(this.lastDetection.blob);this.cameraService.stopStream?.(),this.bus.emit({type:ie,avatarUrl:a}),this.cameraSectionManager.markCaptured(),this.bus.emit({type:"BUTTON_STATE_UPDATED",screen:this.currentScreen})}this.lastDetection=null;return}const t=await this.cameraService.takeSelfie();this.bus.emit({type:"CAMERA_STATUS",status:"checking"});const s=this.dualityManager?.getRequirement?.(),i=this.currentScreen==="registration-camera"?"person":s?.target;if(!i){this.bus.emit({type:"CAMERA_STATUS",status:"not_found"}),this.cameraSectionManager.resumeDetection();return}const r=await this.detectionService.detectTarget(t,i);if(!r.ok){this.bus.emit({type:"CAMERA_STATUS",status:"not_found"}),this.cameraSectionManager.resumeDetection();return}if(this.bus.emit({type:"CAMERA_STATUS",status:"hidden"}),this.currentScreen==="camera"){const n=(this.dualityManager?.getQuest?.()||null)?.overlay||{};await this.cameraSectionManager.captureOverlay(n,t,r.box,r.mask)}else{const a=await this._storeAvatarFromBlob(t);this.cameraService.stopStream?.(),this.bus.emit({type:ie,avatarUrl:a}),this.cameraSectionManager.markCaptured(),this.bus.emit({type:"BUTTON_STATE_UPDATED",screen:this.currentScreen})}}if(e.type==="finish"){const t=this.cameraSectionManager.stateService;if(t?.captured&&t?.presence?.person){await this.profileRegService.saveProfile();const s=await this.db.loadUser();s&&this.storage&&(this.storage.save("userId",String(s.id)),this.storage.save("captured",!0)),this.notificationManager?.notify?.({type:"success",message:"profile-saved"}),this.cameraSectionManager.stopDetection?.(),this.cameraService.stopStream?.(),this.bus.emit({type:"SCREEN_CHANGE",screen:"messenger"})}}if(e.type===ne){if(e.blob){const t=URL.createObjectURL(e.blob);this.bus.emit({type:ie,blobUrl:t})}this.currentScreen==="registration-camera"&&(e.blob&&(await this._storeAvatarFromBlob(e.blob),this.cameraService.stopStream?.()),this.cameraSectionManager.markCaptured()),this.cameraSectionManager.stateService&&this.cameraSectionManager.stateService.setPresence(e.target,!0),this.lastDetection={target:e.target,blob:e.blob,box:e.box,mask:e.mask},this.bus.emit({type:"BUTTON_STATE_UPDATED",screen:this.currentScreen})}e.type==="RETRY_DETECTION"&&(this.bus.emit({type:vt}),this.lastDetection=null,this.cameraSectionManager.resumeDetection({hidePreview:!0}))};async publishPost(){try{await this.postsService.publish();const e=await this.postsService.getPostsForCurrent();this.bus.emit({type:be,posts:e})}catch(e){this.logger.error(e.message)}}toggleCameraSection(){const e=this.currentScreen==="camera"?"messenger":"camera",t=e==="camera"?{force:!1}:{};this.bus.emit({type:"SCREEN_CHANGE",screen:e,options:t})}openMessenger(){this.bus.emit({type:"SCREEN_CHANGE",screen:"messenger"})}async _storeAvatarFromBlob(e){try{const t=await this._blobToBase64(e);return t?(this.profileRegService.setAvatar(t),this.logger?.info?.(`ViewService: captured avatar (${t.length} chars)`)):this.logger?.warn?.("ViewService: empty avatar after conversion"),t||""}catch(t){return this.logger?.error?.(`ViewService: avatar conversion failed: ${t.message}`),""}}async _blobToBase64(e){if(typeof FileReader<"u")return await new Promise((s,i)=>{const r=new FileReader;r.onloadend=()=>s(r.result),r.onerror=i,r.readAsDataURL(e)});const t=await e.arrayBuffer();return`data:image/jpeg;base64,${Buffer.from(t).toString("base64")}`}async resetData(){try{if(typeof document>"u"){this.bus.emit({type:ue,payload:{source:"view",reason:"no_modal"}});return}this.bus.emit({type:St,payload:{source:"view"}})}catch(e){this.logger.error(e.message)}}async handle(){}}class Ir{constructor(e=new v,t=null,s={},i=null){this.bus=e,this.ghostService=t,this.spiritConfigs=s||{},this.logger=i??new L,this._handler=this._handleEvent.bind(this),this._loops=new Map}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler),this._stopLoop("detection")}_handleEvent(e){if(e){if(e.type===C&&!e.replay){const t=e.author||e.message?.author;this._playMessageSound(t)}e.type===Q&&this._startDetectionSound(),(e.type===ne||e.type===Le||e.type==="CAMERA_VIEW_CLOSED")&&this._stopLoop("detection")}}_playMessageSound(e){const t=this._resolveMessageSound(e);t&&this._playOnce(t)}_startDetectionSound(){const e=this._resolveDetectionSound();e&&this._startLoop("detection",e)}_resolveMessageSound(e){if(!e)return null;const t=this.ghostService?.getCurrentGhost?.()?.name;if(!t)return null;const s=this._getSoundsForGhost(t),i=s.message||{};return e==="ghost"?s.ghostMessage||i.ghost||null:e==="user"&&(s.userMessage||i.user)||null}_resolveDetectionSound(){const e=this.ghostService?.getCurrentGhost?.()?.name;return e&&this._getSoundsForGhost(e).detection||null}_getSoundsForGhost(e){return this.spiritConfigs?.[e]?.sounds||{}}_playOnce(e){if(!(!e||typeof Audio>"u"))try{new Audio(e).play().catch(s=>this.logger?.warn?.(s?.message||s))}catch(t){this.logger?.warn?.(t?.message||t)}}_startLoop(e,t){if(!(!t||typeof Audio>"u"||this._loops.get(e)?.source===t)){this._stopLoop(e);try{const i=new Audio(t);i.loop=!0,i.play().catch(r=>this.logger?.warn?.(r?.message||r)),this._loops.set(e,{audio:i,source:t})}catch(i){this.logger?.warn?.(i?.message||i)}}}_stopLoop(e){const t=this._loops.get(e),s=t?.audio||t;if(s){try{s.pause(),s.currentTime=0}catch(i){this.logger?.warn?.(i?.message||i)}this._loops.delete(e)}}}class Mr{constructor(e,t=console){this.authVisibilityAdapter=e,this.logger=t||console}resolve(){const e=this.authVisibilityAdapter?.getSnapshot?.(),t=e?.session||e,i=[t?.username,t?.displayName].filter(Boolean).map(r=>String(r).trim()).find(r=>r.length>0)||null;return i&&this.logger?.info?.("[InterDead][Embed] Resolved login from auth session"),i}}class Dr{constructor({authLoginResolver:e,profileRegistrationService:t,persistence:s,embeddingResolver:i,logger:r=console}={}){this.authLoginResolver=e,this.profileRegistrationService=t,this.persistence=s,this.embeddingResolver=i,this.logger=r||console}prefillIfNeeded(){if(!this._isLauncherMode()||!this.profileRegistrationService||this.persistence?.load?.("login_prefilled")||this.profileRegistrationService.name)return!1;const e=this.authLoginResolver?.resolve?.();return e?(this.profileRegistrationService.setName(e),this.persistence?.save?.("login_prefilled",!0),this.logger?.info?.("[InterDead][Embed] Prefilled registration login"),!0):!1}_isLauncherMode(){return this.embeddingResolver?.resolve?.()?.mode==="launcher"}}class Or{constructor(e,t=console,s={}){this.authVisibilityAdapter=e,this.logger=t||console,this.config=s,this._listeners=new Set,this._unsubscribeAuth=null}boot(){this.authVisibilityAdapter?.boot&&(this.authVisibilityAdapter.boot(),this._unsubscribeAuth=this.authVisibilityAdapter.onChange(()=>{this._emit(this.getStatus())}),this._emit(this.getStatus()))}dispose(){this._unsubscribeAuth?.(),this._unsubscribeAuth=null,this.authVisibilityAdapter?.dispose?.(),this._listeners.clear()}isVisible(){return this._getVisibilityMode()==="hidden-until-auth"?this.isAuthenticated():!0}isAuthenticated(){return this._getVisibilityMode()==="always"||!this.authVisibilityAdapter?.hasPort?.()?!0:this.authVisibilityAdapter.isAuthenticated?.()===!0}getStatus(){return{visible:this.isVisible(),authenticated:this.isAuthenticated()}}onChange(e){return typeof e!="function"?()=>{}:(this._listeners.add(e),()=>this._listeners.delete(e))}_emit(e){this._listeners.forEach(t=>t(e))}_getVisibilityMode(){const e=this.config?.launcher?.visibility;return typeof e=="string"?e:"auth-gated"}}class xr{constructor({widget:e,visibilityService:t,modalAdapter:s,embeddingResolver:i,embedPermissionsResolver:r,documentRef:a=null,logger:n=console}={}){this.widget=e,this.visibilityService=t,this.modalAdapter=s,this.embeddingResolver=i,this.embedPermissionsResolver=r,this.documentRef=a||(typeof document<"u"?document:null),this.logger=n||console,this._iframe=null,this._visibleUnsub=null}async boot(){this._isLauncherMode()&&(this.widget.render(),this.widget.onOpen(()=>this.open()),this.visibilityService?.boot?.(),this._visibleUnsub=this.visibilityService?.onChange?.(e=>{this._applyStatus(e)}),this._applyStatus(this.visibilityService?.getStatus?.()))}dispose(){this._visibleUnsub?.(),this._visibleUnsub=null,this.visibilityService?.dispose?.(),this.widget?.dispose?.()}open(){if(!this.visibilityService?.isAuthenticated?.()){this.logger?.info?.("[InterDead][Launcher] Open blocked until site auth.");return}const e=this._ensureIframe();e&&this.modalAdapter?.open?.(e)}_isLauncherMode(){return this.embeddingResolver?.resolve?.()?.mode==="launcher"}_applyStatus(e={}){const t=e?.visible??this.visibilityService?.isVisible?.()??!0,s=e?.authenticated??this.visibilityService?.isAuthenticated?.()??!0;this.widget.setVisible(t),this.widget.setEnabled(s),this.widget.setLabelKey(s?"open_messenger":"launcher_auth_required")}_ensureIframe(){if(!this.documentRef)return null;if(this._iframe)return this._iframe;const e=this.documentRef.createElement("iframe");e.className="interdead-launcher-modal__iframe",e.src=this._resolveAppSrc();const t=this.embedPermissionsResolver?.resolveAllowAttribute?.();return t&&(e.allow=t),this._iframe=e,e}_resolveAppSrc(){const e="/InterDeadProto/index.html";if(!this.documentRef)return e;const t=this.documentRef.querySelector("[data-interdead-embed], [data-interdead-launcher]"),s=t?.getAttribute("data-interdead-src")||t?.dataset?.interdeadSrc;return s&&s.trim()?s.trim():e}}class Pr{constructor({detectionService:e,authVisibilityAdapter:t,eventBus:s,stateService:i,logger:r,config:a={}}={}){this.detectionService=e,this.authVisibilityAdapter=t,this.bus=s,this.stateService=i,this.logger=r||console,this.config=a,this._started=!1,this._unsubscribeAuth=null,this._handler=n=>this._handleEvent(n)}boot(){this._started||(this.bus&&this.bus.subscribe(this._handler),this.authVisibilityAdapter?.boot?.(),this._unsubscribeAuth=this.authVisibilityAdapter?.onChange?.(()=>{this._maybeWarmup()}),this._maybeWarmup(),this._started=!0)}dispose(){this.bus?.unsubscribe?.(this._handler),this._unsubscribeAuth?.(),this._unsubscribeAuth=null,this.authVisibilityAdapter?.dispose?.()}_handleEvent(e){e&&e.type===pt&&this._retryWarmup()}_retryWarmup(){this.detectionService?.retry&&this.detectionService.retry().catch(e=>this.logger?.warn?.(`[AI] Retry failed: ${e?.message||e}`))}_maybeWarmup(){this.config?.ai?.warmupEnabled&&this._isWarmupAllowed()&&this.detectionService?.boot&&this.detectionService.boot({warmup:!0}).catch(e=>this.logger?.warn?.(`[AI] Warmup failed: ${e?.message||e}`))}_isWarmupAllowed(){return!(this.config?.ai?.warmupAfterAuth!==!1)||!this.authVisibilityAdapter?.hasPort?.()?!0:this.authVisibilityAdapter?.isAuthenticated?.()===!0}}class Nr{constructor(e){this.context=e}register(){const{container:e,config:t,spiritConfigs:s}=this.context;e.register("DualityConfigService",()=>new Di(e.resolve("IConfigLoader"),"src/config/spirits"),{priority:36}),e.register("ProfileRegistrationService",()=>new Oi(e.resolve("DatabaseService"),e.resolve("IEncryption"),e.resolve("Logger"),e.resolve("IEventBus")),{priority:80}),e.register("AuthLoginResolver",()=>new Mr(e.resolve("AuthVisibilityAdapter"),e.resolve("Logger")),{priority:79}),e.register("LoginPrefillService",()=>new Dr({authLoginResolver:e.resolve("AuthLoginResolver"),profileRegistrationService:e.resolve("ProfileRegistrationService"),persistence:e.resolve("IPersistence"),embeddingResolver:e.resolve("EmbeddingModeResolver"),logger:e.resolve("Logger")}),{priority:80,deps:["AuthLoginResolver","ProfileRegistrationService"]}),e.register("ChatLauncherVisibilityService",()=>new Or(e.resolve("AuthVisibilityAdapter"),e.resolve("Logger"),t),{priority:81}),e.register("ChatLauncherService",()=>new xr({widget:e.resolve("ChatLauncherWidget"),visibilityService:e.resolve("ChatLauncherVisibilityService"),modalAdapter:e.resolve("HostModalAdapter"),embeddingResolver:e.resolve("EmbeddingModeResolver"),embedPermissionsResolver:e.resolve("EmbedPermissionsResolver"),documentRef:typeof document<"u"?document:null,logger:e.resolve("Logger")}),{priority:82}),e.register("AiWarmupService",()=>new Pr({detectionService:e.resolve("DetectionService"),authVisibilityAdapter:e.resolve("AuthVisibilityAdapter"),eventBus:e.resolve("IEventBus"),stateService:e.resolve("StateService"),logger:e.resolve("Logger"),config:t}),{priority:84}),e.register("GhostService",()=>new xi(e.resolve("IPersistence"),t),{priority:55}),e.register("GhostSwitchService",()=>new Pi(e.resolve("IPersistence"),e.resolve("IEventBus")),{priority:55,deps:["GhostService"]}),e.register("DialogRepository",()=>{const i=new Ni(e.resolve("DatabaseService"));return i.ensureSchema(),i},{priority:55}),e.register("DialogHistoryService",()=>new qi(e.resolve("DialogRepository")),{priority:56}),e.register("ScreenService",()=>new Fi(e.resolve("IEventBus")),{priority:56}),e.register("ButtonStateService",()=>new Gi(e.resolve("IEventBus"),e.resolve("IPersistence"),e.resolve("ScreenService"),e.resolve("Logging")),{priority:57}),e.register("ButtonVisibilityService",()=>new Hi(e.resolve("IEventBus"),e.resolve("IPersistence"),e.resolve("Logging")),{priority:58}),e.register("ModalService",()=>new $i(e.resolve("IEventBus")),{priority:59}),e.register("PostsService",()=>new Vi(e.resolve("DatabaseService"),e.resolve("GhostService")),{priority:56}),e.register("AvatarService",()=>new Wi(e.resolve("DatabaseService"),e.resolve("Logger")),{priority:56}),e.register("ButtonService",()=>new zi(e.resolve("TemplateService"),e.resolve("LanguageService"),e.resolve("ProfileRegistrationService"),e.resolve("IEventBus"),e.resolve("IPersistence")),{priority:60}),e.register("StateService",()=>{const i=new Yi(e.resolve("ProfileRegistrationService"),e.resolve("GeoService"),e.resolve("GhostService"),e.resolve("IEventBus"),e.resolve("Logger"),e.resolve("ScreenService"));return e.resolve("ProfileRegistrationService").stateService=i,i},{priority:50}),e.register("ItemOverlayService",()=>new lr(e.resolve("ICanvasFactory")),{priority:111}),e.register("ImageComposerService",()=>new cr(e.resolve("ICanvasFactory")),{priority:111}),e.register("MediaRepository",()=>new hr,{priority:111}),e.register("CameraSectionManager",()=>new or(e.resolve("CameraService"),e.resolve("DetectionService"),e.resolve("Logger"),e.resolve("StateService"),e.resolve("DualityManager"),e.resolve("DialogManager"),e.resolve("IEventBus"),e.resolve("ButtonStateService"),e.resolve("ButtonVisibilityService"),e.resolve("ItemOverlayService"),e.resolve("AvatarService"),e.resolve("DialogInputGateService"),e.resolve("ImageComposerService"),e.resolve("MediaRepository"),e.resolve("ICanvasFactory")),{priority:112}),e.register("DrumLayoutService",()=>new ur(e.resolve("IPersistence"),e.resolve("IEventBus")),{priority:119}),e.register("ReactionMappingService",()=>new gr(e.resolve("GhostService"),e.resolve("DualityManager"),s,e.resolve("Logger")),{priority:145,deps:["DualityManager","GhostService"]}),e.register("DialogHistoryBuffer",()=>new Wt,{priority:141}),e.register("GhostRebootCheckpointService",()=>new Tr(e.resolve("IPersistence")),{priority:142}),e.register("ReactionPersistenceService",()=>new pr(e.resolve("DialogManager"),e.resolve("DialogHistoryService"),e.resolve("DialogHistoryBuffer"),e.resolve("GhostService"),e.resolve("IEventBus"),e.resolve("Logger")),{priority:146,deps:["DialogManager","DialogHistoryService","DialogHistoryBuffer","GhostService"]}),e.register("ReactionFinaleService",()=>new fr(e.resolve("IEventBus"),e.resolve("DualityManager"),e.resolve("GhostService"),s,void 0,e.resolve("Logger")),{priority:147,deps:["DualityManager","GhostService"]}),e.register("DialogOrchestratorService",()=>new yr(e.resolve("DualityManager"),e.resolve("DialogManager"),e.resolve("GhostService"),e.resolve("ButtonStateService"),e.resolve("ButtonVisibilityService"),e.resolve("DialogHistoryService"),e.resolve("AvatarService"),e.resolve("GhostSwitchService"),s,e.resolve("DialogInputGateService"),e.resolve("IEventBus"),e.resolve("Logging"),e.resolve("DialogHistoryBuffer"),void 0,void 0,e.resolve("GhostRebootCheckpointService")),{priority:129,deps:["DialogManager","DualityManager","GhostService"]}),e.register("ChatScrollService",()=>new vr('[data-js="messenger-container"]',e.resolve("IEventBus")),{priority:143}),e.register("DialogHistoryObserverService",()=>new Sr(e.resolve("DialogManager"),e.resolve("DialogHistoryService"),e.resolve("GhostService"),e.resolve("IEventBus")),{priority:145,deps:["DialogManager","DialogHistoryService","GhostService"]}),e.register("ResetService",()=>new wr(t,e.resolve("DatabaseService"),e.resolve("IPersistence"),e.resolve("IEventBus"),e.resolve("Logger")),{priority:128}),e.register("ProfileTransferService",()=>new Er(e.resolve("ProfileRegistrationService"),e.resolve("PostsService"),e.resolve("DialogHistoryService"),e.resolve("GhostService"),e.resolve("IEventBus"),e.resolve("Logger")),{priority:127}),e.register("SoundService",()=>new Ir(e.resolve("IEventBus"),e.resolve("GhostService"),s,e.resolve("Logger")),{priority:128,deps:["GhostService"]}),e.register("EffectsManager",()=>new Rr(e.resolve("IEventBus"),e.resolve("IPersistence"),e.resolve("GhostService"),e.resolve("DualityManager"),void 0,e.resolve("Logger"),s),{priority:150,deps:["DualityManager"]}),e.register("DialogInputGateService",()=>new Lr(e.resolve("DialogManager"),e.resolve("DualityManager"),e.resolve("IEventBus")),{priority:142}),e.register("ViewService",()=>new Cr(e.resolve("TemplateService"),e.resolve("PanelService"),e.resolve("LanguageService"),e.resolve("ProfileRegistrationService"),e.resolve("GeoService"),e.resolve("DatabaseService"),e.resolve("PostsService"),e.resolve("DetectionService"),e.resolve("CameraService"),e.resolve("CameraSectionManager"),e.resolve("NotificationManager"),e.resolve("Logger"),e.resolve("IPersistence"),e.resolve("ButtonStateService"),e.resolve("DualityManager"),e.resolve("IEventBus"),e.resolve("GhostService"),e.resolve("DialogHistoryService"),e.resolve("DialogHistoryBuffer"),e.resolve("MediaRepository"),e.resolve("LoginPrefillService")),{priority:130})}}const Br={emit:()=>{},subscribe:()=>{},unsubscribe:()=>{}};class kr{constructor(e,t,s=Br){this.logger=e,this.storage=t,this.bus=s,this.timeout=5e3,this.heartbeatInterval=1e3,this.channel=new BroadcastChannel("app-loading"),this.tabId=this._getOrCreateTabId(),this.bootState="idle",this.heartbeat=null,this.bcHeartbeat=null,this.isLeader=!1,this.unloadHandlerRegistered=!1,this.bootHandler=null,this.storageOk=this._probePersistence(),this.channel.addEventListener("message",i=>{const r=i?.data;if(r==="start"){this.storageOk&&!this._isMyTabActive()&&this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"});return}if(r==="done"){this.storageOk&&!this._isMyTabActive()&&this.bus.emit({type:"OVERLAY_HIDE"});return}if(!(!r||typeof r!="object")&&!(r.tabId&&r.tabId===this.tabId)){if(r.type==="LEADER_PING"){(this.isLeader||this.storageOk&&this._isMyTabActive())&&this.channel.postMessage({type:"LEADER_ACK",tabId:this.tabId});return}if(r.type!=="LEADER_ACK"){if(r.type==="BOOT_START"){this._isMyTabActive()||this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"});return}r.type==="BOOT_DONE"&&(this._isMyTabActive()||this.bus.emit({type:"OVERLAY_HIDE"}))}}}),window.addEventListener("storage",i=>{if(this.storageOk){if(i.key==="activeTab"){this._handleStorageOverlayUpdate(i.newValue);return}if(i.key==="appLoading"){if(!i.newValue){this.bus.emit({type:"OVERLAY_HIDE"});return}const r=this._parseState(i.newValue);if(!this._isStateFresh(r)){this._clearLoadingState(),this.bus.emit({type:"OVERLAY_HIDE"});return}this._isMyTabActive()||this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"})}}})}async load(e){if(!(this.bootState==="booting"||this.bootState==="booted")){this.bootState="booting";try{if(this.storageOk){const s=this._getActiveTabState(),i=this._getLoadingState();if(s&&s.value!==this.tabId||i){this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"}),this.bootState="idle";return}this._startStorageHeartbeat()}else{if(await this._detectForeignLeader()){this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"}),this.bootState="idle";return}this._startBroadcastHeartbeat()}this._registerUnloadHandler(),this._markLoadingInProgress(),this.channel.postMessage("start"),this.channel.postMessage({type:"BOOT_START",tabId:this.tabId}),this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"loading"});const t=s=>{s.type==="BOOT_COMPLETE"&&(this.bus.unsubscribe(t),this.bootHandler===t&&(this.bootHandler=null),this.bus.emit({type:"OVERLAY_HIDE"}),this._clearLoadingState(),this.channel.postMessage("done"),this.channel.postMessage({type:"BOOT_DONE",tabId:this.tabId}),this.bootState="booted")};return this.bootHandler=t,this.bus.subscribe(t),e?await e():void 0}catch(t){this._handleBootFailure(t),this.bootState="idle";return}}}_probePersistence(){try{if(!this.storage?.save||!this.storage?.load||!this.storage?.remove)return!1;const e="__interdead_probe__",t={value:"ok",timestamp:Date.now()};this.storage.save(e,t);const s=this.storage.load(e);return this.storage.remove(e),!!s&&typeof s=="object"&&s.value==="ok"}catch{return!1}}async _detectForeignLeader(){return new Promise(e=>{let t=!1;const s=r=>{t||(t=!0,this.channel.removeEventListener("message",i),e(r))},i=r=>{const a=r?.data;!a||typeof a!="object"||a.tabId&&a.tabId===this.tabId||a.type==="LEADER_ACK"&&s(!0)};this.channel.addEventListener("message",i),this.channel.postMessage({type:"LEADER_PING",tabId:this.tabId}),setTimeout(()=>s(!1),250)})}_startBroadcastHeartbeat(){this.isLeader=!0,this.bcHeartbeat=setInterval(()=>{this.channel.postMessage({type:"LEADER_HEARTBEAT",tabId:this.tabId})},this.heartbeatInterval)}_stopBroadcastHeartbeat(){this.bcHeartbeat&&clearInterval(this.bcHeartbeat),this.bcHeartbeat=null,this.isLeader=!1}_getActiveTabState(){return this._readFreshState("activeTab")}_isMyTabActive(){if(!this.storageOk)return!1;const e=this._getActiveTabState();return!!e&&e.value===this.tabId}_startStorageHeartbeat(){this._refreshActiveTab(),this.heartbeat=setInterval(()=>this._refreshActiveTab(),this.heartbeatInterval)}_stopStorageHeartbeat(){this.heartbeat&&clearInterval(this.heartbeat),this.heartbeat=null}_getLoadingState(){return this._readFreshState("appLoading")}_refreshActiveTab(){this._writeState("activeTab",this.tabId)}_markLoadingInProgress(){this._writeState("appLoading",`boot:${this.tabId}`)}_clearLoadingState(){this.storage?.remove("appLoading")}_clearActiveTab(){this.storage?.remove("activeTab")}_readFreshState(e){if(!this.storageOk)return null;const t=this.storage?.load(e);return this._isStateFresh(t)?t:(t&&this.storage?.remove(e),null)}_writeState(e,t){this.storageOk&&this.storage?.save(e,{value:t,timestamp:Date.now()})}_isStateFresh(e){return!e||typeof e!="object"||!("timestamp"in e)?!1:Date.now()-e.timestamp<=this.timeout}_parseState(e){if(!e)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return e}_handleStorageOverlayUpdate(e){if(!e){this.bus.emit({type:"OVERLAY_HIDE"});return}const t=this._parseState(e);if(this._isStateFresh(t)){this._isMyTabActive()||this.bus.emit({type:"OVERLAY_SHOW",i18nKey:"app_already_open"});return}this.storage?.remove("activeTab"),this.bus.emit({type:"OVERLAY_HIDE"})}_registerUnloadHandler(){if(this.unloadHandlerRegistered)return;this.unloadHandlerRegistered=!0;const e=()=>{this._stopStorageHeartbeat(),this._stopBroadcastHeartbeat(),this._clearLoadingState(),this.storageOk&&this._clearActiveTab(),this.channel.postMessage("done"),this.channel.postMessage({type:"BOOT_DONE",tabId:this.tabId})};window.addEventListener("pagehide",e),window.addEventListener("beforeunload",e)}_handleBootFailure(e){const t=e?.message?`Boot failed, clearing loading state: ${e.message}`:"Boot failed, clearing loading state.";this.logger?.error?.(t),this._stopStorageHeartbeat(),this._stopBroadcastHeartbeat(),this._clearLoadingState(),this.storageOk&&this._clearActiveTab(),this.bootHandler&&(this.bus.unsubscribe(this.bootHandler),this.bootHandler=null),this.bus.emit({type:"OVERLAY_HIDE"}),this.channel.postMessage("done"),this.channel.postMessage({type:"BOOT_DONE",tabId:this.tabId})}_getOrCreateTabId(){const e="interdead_tab_id";try{if(typeof sessionStorage<"u"){const t=sessionStorage.getItem(e);if(t)return t;const s=this._createTabId();return sessionStorage.setItem(e,s),s}}catch{}return this._createTabId()}_createTabId(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}}const Ye={IDLE:"ai_loading_status",LOADING_RUNTIME:"ai_loading_status",LOADING_MODEL:"ai_loading_status",WARMUP:"ai_loading_status",READY:"ai_ready_status",FAILED:"ai_failed_status"};class Ur{constructor(e,t=null){this.bus=e,this.languageManager=t,this.overlay=this._createOverlay(),this._handler=s=>this._handle(s),this._retryHandler=()=>this.bus.emit({type:pt}),this.aiState="IDLE",this._contactAnimating=!1}boot(){this.bus.subscribe(this._handler),this._bindActions(),this._render()}dispose(){this.bus.unsubscribe(this._handler),this._unbindActions()}_createOverlay(){const e=document.createElement("div");return e.className="app__loader app__loader--ai",e.innerHTML=`
      <div class="app__loader-content">
        <div class="app__loader-contact" data-js="ai-contact"></div>
        <div class="app__loader-status" data-js="ai-status" data-i18n="ai_loading_status"></div>
        <div class="app__loader-actions">
          <button class="app__loader-button app__loader-button--retry app__loader-button--hidden" type="button" data-js="ai-retry" data-i18n="ai_retry"></button>
        </div>
      </div>
    `,(document.querySelector('[data-js="global-content"]')||document.body).appendChild(e),this.languageManager?.applyLanguage(e),e}_bindActions(){this.overlay.querySelector('[data-js="ai-retry"]')?.addEventListener("click",this._retryHandler)}_unbindActions(){this.overlay.querySelector('[data-js="ai-retry"]')?.removeEventListener("click",this._retryHandler)}_handle(e){if(!(!e||typeof e.type!="string")&&e.type===de){e.state&&(this.aiState=e.state,this._render());return}}_render(){const e=this.aiState!=="READY";this.overlay.classList.toggle("app__loader--visible",e),this._renderStatus(),this._renderRetry(),e&&this._animateContact()}_renderStatus(){const e=this.overlay.querySelector('[data-js="ai-status"]');if(!e)return;const t=Ye[this.aiState]||Ye.IDLE;e.setAttribute("data-i18n",t),this.languageManager?.applyLanguage(e)}_renderRetry(){const e=this.overlay.querySelector('[data-js="ai-retry"]');if(!e)return;const t=this.aiState==="FAILED";e.classList.toggle("app__loader-button--hidden",!t),this.languageManager?.applyLanguage(e)}async _animateContact(){if(this._contactAnimating)return;const e=this.overlay.querySelector('[data-js="ai-contact"]');if(!e)return;this._contactAnimating=!0;const s=await this.languageManager?.translate?.("ai_contact_line","ui")||"CONTACT ...";e.textContent=s,this._contactAnimating=!1}}class qr{constructor(e=null,t=new v){this.selector=e,this.bus=t,this.container=null,this._handler=s=>this._handle(s)}boot(){this.container=this._ensureContainer(),this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler)}_ensureContainer(){if(this.selector){const t=typeof this.selector=="string"?document.querySelector(this.selector):this.selector;if(t)return t}let e=document.querySelector('[data-js="status-display"]');return e||(e=document.createElement("div"),e.setAttribute("data-js","status-display"),(document.querySelector('[data-js="global-content"]')||document.body).appendChild(e)),e}_handle(e){!e||e.type!==Ce||(this.container=this.container||this._ensureContainer(),this.container.textContent=e.message||"",this.bus.emit({type:"log",level:"info",message:`StatusWidget: rendering message ${e.message||""}`}))}}class Fr{constructor(e,t){this.bus=e,this.languageManager=t,this.bus.subscribe(s=>{s.type==="BUTTONS_RENDER"&&this.render(s.container,s.html)})}render(e,t){e&&(e.innerHTML=t,this.languageManager.applyLanguage(e),this.attach(e))}attach(e){e.querySelectorAll("[data-action]").forEach(t=>{const s=t.getAttribute("data-action");let i="click";s==="change-language"&&t.tagName==="SELECT"?i="change":t.tagName==="INPUT"&&(i="input"),t.addEventListener(i,()=>{const r=t.value||t.getAttribute("data-lang");this.bus.emit({type:"BUTTON_ACTION",action:s,value:r})})})}}class Gr{boot(){throw new Error("Method boot must be implemented by panel adapters.")}async load(e){throw new Error("Method load must be implemented by panel adapters.")}async update(e,t){throw new Error("Method update must be implemented by panel adapters.")}}class P extends Gr{static HIDDEN_CLASS="panel--hidden";constructor(e,t,s,i,r,a,n,l,c,h,d,p,u,g=null,m=new v,f='[data-js="bottom-panel"]',y=null,b=!0){super(),this.templateService=e,this.buttonService=t,this.languageManager=s,this.controls=i,this.screenMap=r,this.profileRegService=a,this.stateService=n,this.buttonStateService=l,this.buttonVisibilityService=c,this.ghostService=h,this.ghostSwitchService=d,this.spiritConfigs=p||{},this.dualityManager=u,this.modalService=g,this.eventBus=m,this.containerSelector=f,this.drumLayoutService=y,this.panelContainer=null,this.currentScreen=null,this.showEmojiDrum=b}boot(){this.eventBus.subscribe(async e=>{if(!(!e||!this.panelContainer)){if(e.type==="BUTTON_STATE_UPDATED"&&e.screen===this.currentScreen){await this.update(this.panelContainer,{screen:e.screen});return}if(e.type===mt&&e.screen===this.currentScreen){await this.update(this.panelContainer,{screen:e.screen});return}if(e.type===de){await this.update(this.panelContainer,{screen:this.currentScreen});return}if(e.type==="GHOST_CHANGE"){await this.update(this.panelContainer,{screen:this.currentScreen});return}if(e.type===Dt){const t=Array.isArray(e.layout)?e.layout:this.drumLayoutService?.getLayout?.();this._applyDrumLayout(this.panelContainer,t);return}if(e.type==="QUEST_STARTED"){const t=this.dualityManager?.getRequirement?.();t&&(t.type==="object"||t.type==="presence")&&this.panelContainer.querySelector('[data-js="toggle-camera"]')?.classList.add("active");return}if(e.type==="QUEST_COMPLETED"){this.panelContainer.querySelector('[data-js="toggle-camera"]')?.classList.remove("active");return}if(e.type===ri){await this.update(this.panelContainer,{screen:this.currentScreen});const t=this.panelContainer.querySelector('[data-js="ghost-switcher-buttons"]');t?.classList.add("ghost-switcher--highlight"),setTimeout(()=>t?.classList.remove("ghost-switcher--highlight"),1e3)}}})}async load(e={}){try{const t=await this.templateService.render("panel"),s=typeof this.containerSelector=="string"?document.querySelector(this.containerSelector):this.containerSelector;if(s){s.innerHTML=t;const i=s.querySelector('[data-js="panel-controls"]');i&&(this.panelContainer=i,this.currentScreen=e.screen,await this.update(i,e),this._applyDrumLayout(i),this.languageManager.applyLanguage(s))}}catch(t){this.templateService.logger?.error(t.message)}}async update(e,t={}){if(!e)return;t.screen&&(this.currentScreen=t.screen);const s=e.querySelector(".panel__mask"),i=this.showEmojiDrum&&this.currentScreen==="messenger";s?.classList.toggle(P.HIDDEN_CLASS,!i),(typeof document<"u"?document.documentElement:null)?.style.setProperty("--chat-panel-height",i?"var(--panel-height)":"var(--panel-height-collapsed)"),this._applyDrumLayout(e);const a=Object.keys(this.controls);for(const u of a){const g=e.querySelector(`[data-js="${u}"]`);g&&g.classList.add(P.HIDDEN_CLASS)}const n=this.screenMap?.[t.screen]||[];for(const u of n){const g=e.querySelector(`[data-js="${u}"]`);if(g){g.classList.remove(P.HIDDEN_CLASS);const m=this.controls[u];m?.length&&(await this.buttonService.init(g,m),this.languageManager.applyLanguage(g))}}const l=e.querySelector('[data-js="language-selector"]');l&&(l.value=this.languageManager.current);let c=[];const h=this.ghostService.getCurrentGhost().name;if(t.screen==="messenger"){const u=e.querySelector('[data-js="ghost-switcher-buttons"]'),g=u?.querySelector('[data-js="ghost-select"]');if(g){g.innerHTML="",c=this.ghostSwitchService.getAvailable(this.spiritConfigs,h),this.ghostSwitchService.getUnlocked(this.spiritConfigs);for(const m of c){const y=(this.spiritConfigs?.[m]||{}).displayName||m,b=document.createElement("option");b.value=m,b.textContent=y,g.appendChild(b)}this.languageManager.applyLanguage(g),g.value=h,g.disabled=c.length<=1,g.onchange=m=>{const f=m.target.value;this._handleGhostSelection(f,g)},u?.classList.remove(P.HIDDEN_CLASS)}}this.languageManager.applyLanguage(e);const d=this.buttonVisibilityService?.getVisibilityForScreen(this.currentScreen)||{},p={post:"post-btn","capture-btn":"capture-btn"};for(const[u,g]of Object.entries(d)){const m=p[u]||u;e.querySelector(`[data-js="${m}"]`)?.classList.toggle(P.HIDDEN_CLASS,!g)}e.querySelectorAll("[data-action]").forEach(u=>{const g=u.getAttribute("data-action");let f=!(this.stateService.isButtonEnabled(this.currentScreen,g)&&this.buttonStateService.isActive(g,this.currentScreen));g==="switch-ghost"&&(f=f||c.length<=1),u.disabled=f,u.classList.toggle("button--disabled",f)}),this._applyAiCameraState(e)}_handleGhostSelection(e,t){const s=this.ghostService.getCurrentGhost().name;if(!(!e||e===s)){if(this._shouldConfirmGuideExit(s,e)&&(t&&(t.value=s),this.modalService)){this._showGuideSwitchModal(e,s,t);return}this._performGhostSwitch(e)}}_shouldConfirmGuideExit(e,t){return e!=="guide"||t==="guide"?!1:!this.ghostSwitchService?.isCompleted?.("guide")}_showGuideSwitchModal(e,t,s){const i=document.createElement("div");i.className="ghost-switch-modal";const r=document.createElement("h2");r.className="ghost-switch-modal__title",r.setAttribute("data-i18n","ghost_switch.title"),i.appendChild(r);const a=document.createElement("p");a.className="ghost-switch-modal__message",a.setAttribute("data-i18n","ghost_switch.message"),i.appendChild(a);const n=document.createElement("div");n.className="ghost-switch-modal__actions";const l=document.createElement("button");l.type="button",l.className="ghost-switch-modal__button ghost-switch-modal__button--confirm",l.setAttribute("data-i18n","ghost_switch.confirm"),l.onclick=()=>{this.modalService?.hide?.(),this._performGhostSwitch(e)};const c=document.createElement("button");c.type="button",c.className="ghost-switch-modal__button ghost-switch-modal__button--cancel",c.setAttribute("data-i18n","ghost_switch.cancel"),c.onclick=()=>{this.modalService?.hide?.(),s&&(s.value=t)},n.appendChild(l),n.appendChild(c),i.appendChild(n),this.modalService?.show?.(i)}_performGhostSwitch(e){this.ghostService.setCurrentGhost(e),this.eventBus.emit({type:"GHOST_CHANGE",payload:{name:e}})}_applyDrumLayout(e,t=null){if(!e||!this.drumLayoutService)return;const s=e.querySelector(".panel__mask");if(!s)return;const i=Array.isArray(t)?t:this.drumLayoutService.getLayout();s.querySelectorAll(".panel__sector-emoji").forEach((a,n)=>{const l=i[n]??"‚¨ú";a.textContent=l,a.removeAttribute?.("data-filled")})}_applyAiCameraState(e){if(!e||!this.stateService)return;const t=e.querySelector('[data-action="toggle-camera"]');if(!t)return;const s=this.stateService.getAiState?.()||"IDLE",i=this.stateService.isAiReady?.()===!0;this.stateService.isAiLoading?.(),t.classList.toggle("control-button--ai-loading",!1);const a=t.querySelector('[data-js="control-badge"]');if(a&&(a.removeAttribute("data-i18n"),a.textContent=""),i)t.setAttribute("data-i18n-title","open_camera");else{const n=s==="FAILED"?"ai_failed_camera":"ai_loading_camera";t.setAttribute("data-i18n-title",n)}this.languageManager.applyLanguage(t)}}const Hr=6e3,jr=1e3,$r=90;class Vr{constructor({panelSelector:e='[data-js="panel-controls"]',dialogSelector:t='[data-js="dialog-list"]',circleSelector:s=".panel__circle",badgeSelector:i='[data-js="reaction-badge"]',emojiSelector:r=".panel__sector-emoji",countdownSelector:a=".panel__selection-badge-countdown",overlayClass:n="reaction-overlay",countdownMs:l=Hr,resumeDelayMs:c=jr,rotationSpeed:h=$r,bus:d=new v,documentRef:p=typeof document<"u"?document:null,windowRef:u=typeof window<"u"?window:null}={}){this.bus=d,this.document=p,this.window=u,this.config={panelSelector:e,dialogSelector:t,circleSelector:s,badgeSelector:i,emojiSelector:r,countdownSelector:a,overlayClass:n,overlayVisibleClass:`${n}--visible`,countdownMs:l,resumeDelayMs:c,rotationSpeed:h},this._panel=null,this._circle=null,this._badge=null,this._countdownNode=null,this._overlayNode=null,this._messageNode=null,this._activeEmoji=null,this._state={active:!1,request:null,deadline:0,resumeAt:0,animationDuration:40,committed:!1,locked:!1,targetReaction:null,origin:null,auto:!1},this._currentAngle=0,this._lastTick=null,this._raf=null,this._isDragging=!1,this._dragPointerId=null,this._dragOffset=0,this._badgeBound=!1,this._handler=this._handleEvent.bind(this),this._onBadgeClick=this._handleBadgeClick.bind(this),this._onPointerDown=this._handlePointerDown.bind(this),this._onPointerMove=this._handlePointerMove.bind(this),this._onPointerUp=this._handlePointerUp.bind(this),this._tickRef=this._tick.bind(this)}boot(){this.bus?.subscribe(this._handler)}dispose(){this.bus?.unsubscribe(this._handler),this._teardownOverlay()}_handleEvent(e){if(e){if(e.type===Te){this._state.active&&this._teardownOverlay(),this._ensureElements()&&this._activateOverlay(e);return}if(e.type===X){this._state.active&&this._matchesRequest(e)&&this._teardownOverlay();return}e.type===U&&this._teardownOverlay()}}_ensureElements(){if(!this.document)return!1;const e=this.document.querySelector(this.config.panelSelector);return e?(e!==this._panel&&(this._panel=e,this._circle=e.querySelector(this.config.circleSelector),this._badge=e.querySelector(this.config.badgeSelector),this._countdownNode=this._badge?.querySelector(this.config.countdownSelector)||null,this._badgeBound=!1),!!(this._panel&&this._circle&&this._badge)):!1}_activateOverlay(e){const t=e?.locked===!0,s=typeof e?.reaction=="string"&&e.reaction.trim()!==""?e.reaction:null;this._state={active:!0,request:{...e},deadline:this._now()+this.config.countdownMs,resumeAt:this._now(),animationDuration:this._readRotationDuration(),committed:!1,locked:t,targetReaction:s,origin:e?.origin||null,auto:e?.auto===!0||t},this._currentAngle=this._extractCurrentAngle(),this._lastTick=null,this._isDragging=!1,this._dragPointerId=null,this._dragOffset=0,this._highlightMessage(e),this._showOverlay(),this._prepareCircle(),this._showBadge(),t||(this._bindBadge(),this._bindCircle()),this._updateActiveSlice(),this._updateCountdown(this._now()),this._startAnimationLoop()}_teardownOverlay(){if(!this._state.active){this._cleanupVisuals();return}this._state.active=!1,this._state.request=null,this._stopAnimationLoop(),this._cleanupVisuals()}_cleanupVisuals(){this._unbindCircle(),this._unbindBadge(),this._hideBadge(),this._restoreCircle(),this._removeOverlay(),this._clearMessage(),this._activeEmoji?.classList.remove("panel__sector-emoji--active"),this._activeEmoji=null}_highlightMessage(e){if(!this.document)return;const t=this.document.querySelector(this.config.dialogSelector);if(!t)return;const r=Array.from(t.querySelectorAll(".dialog__reaction-trigger")).find(a=>{if(!a)return!1;if(e.fingerprint&&a.dataset.fingerprint===e.fingerprint)return!0;if(e.messageId!=null){const n=Number(a.dataset.messageId);if(!Number.isNaN(n)&&Number(e.messageId)===n)return!0}return!1})?.closest(".dialog__message");r&&(r.classList.add("dialog__message--reaction-active"),e?.locked&&r.classList.add("dialog__message--reaction-locked"),r.scrollIntoView?.({behavior:"smooth",block:"center"})),this._messageNode=r||null}_clearMessage(){this._messageNode&&(this._messageNode.classList.remove("dialog__message--reaction-active"),this._messageNode=null)}_showOverlay(){if(!this.document||this._overlayNode)return;const e=this.document.createElement("div");e.className=this.config.overlayClass,this.document.body.appendChild(e),this._overlayNode=e,(this.window?.requestAnimationFrame?.bind(this.window)??(s=>setTimeout(s,0)))(()=>{this._overlayNode?.classList.add(this.config.overlayVisibleClass)})}_removeOverlay(){if(!this._overlayNode)return;this._overlayNode.classList.remove(this.config.overlayVisibleClass);const e=this._overlayNode;this._overlayNode=null,(this.window?.setTimeout?.bind(this.window)??setTimeout)(()=>e.remove(),200)}_prepareCircle(){!this._panel||!this._circle||(this._panel.classList.add("panel--reaction-active"),this._circle.classList.add("panel__circle--manual"),this._circle.style.transform=`rotate(${this._currentAngle}deg)`)}_restoreCircle(){if(!this._panel||!this._circle)return;const e=this._state.animationDuration,t=this._normalizeAngle(this._currentAngle);if(this._circle.classList.remove("panel__circle--manual"),this._circle.style.transform="",Number.isFinite(e)&&e>0){const s=-(t/360)*e;this._circle.style.animationDelay=`${s}s`}this._panel.classList.remove("panel--reaction-active")}_showBadge(){this._badge&&(this._badge.classList.remove("panel__selection-badge--hidden"),this._badge.disabled=this._state.locked===!0)}_hideBadge(){this._badge&&(this._badge.classList.add("panel__selection-badge--hidden"),this._badge.disabled=!0,this._countdownNode&&(this._countdownNode.textContent=""))}_bindBadge(){!this._badge||this._badgeBound||(this._badge.addEventListener("click",this._onBadgeClick),this._badgeBound=!0)}_unbindBadge(){!this._badge||!this._badgeBound||(this._badge.removeEventListener("click",this._onBadgeClick),this._badgeBound=!1)}_bindCircle(){this._circle&&this._circle.addEventListener("pointerdown",this._onPointerDown)}_unbindCircle(){this._circle&&(this._circle.removeEventListener("pointerdown",this._onPointerDown),this._unregisterPointerListeners())}_handleBadgeClick(){this._confirmSelection(!1)}_handlePointerDown(e){if(!this._state.active||this._isDragging||this._state.locked)return;e.preventDefault(),this._isDragging=!0,this._dragPointerId=e.pointerId;const t=this._getPointerAngle(e);this._dragOffset=this._currentAngle-t,this._state.resumeAt=this._now()+this.config.resumeDelayMs,this._registerPointerListeners(),this._circle?.setPointerCapture?.(e.pointerId)}_handlePointerMove(e){if(!this._isDragging||e.pointerId!==this._dragPointerId)return;const t=this._getPointerAngle(e);this._currentAngle=t+this._dragOffset,this._applyAngle(),this._updateActiveSlice()}_handlePointerUp(e){e.pointerId===this._dragPointerId&&(this._circle?.releasePointerCapture?.(e.pointerId),this._isDragging=!1,this._dragPointerId=null,this._state.resumeAt=this._now()+this.config.resumeDelayMs,this._unregisterPointerListeners())}_registerPointerListeners(){this.document&&(this.document.addEventListener("pointermove",this._onPointerMove),this.document.addEventListener("pointerup",this._onPointerUp),this.document.addEventListener("pointercancel",this._onPointerUp))}_unregisterPointerListeners(){this.document&&(this.document.removeEventListener("pointermove",this._onPointerMove),this.document.removeEventListener("pointerup",this._onPointerUp),this.document.removeEventListener("pointercancel",this._onPointerUp))}_startAnimationLoop(){this._stopAnimationLoop(),this._raf=this.window?.requestAnimationFrame?.(this._tickRef)}_stopAnimationLoop(){this._raf&&this.window?.cancelAnimationFrame&&this.window.cancelAnimationFrame(this._raf),this._raf=null,this._lastTick=null}_tick(e){if(!this._state.active)return;this._lastTick===null&&(this._lastTick=e);const t=e-this._lastTick;if(this._lastTick=e,!this._isDragging&&e>=this._state.resumeAt&&(this._currentAngle+=this.config.rotationSpeed*t/1e3),this._applyAngle(),this._updateActiveSlice(),this._updateCountdown(e),!this._state.committed&&e>=this._state.deadline){this._state.committed=!0,this._confirmSelection(!0);return}this._raf=this.window?.requestAnimationFrame?.(this._tickRef)}_applyAngle(){this._circle&&(this._circle.style.transform=`rotate(${this._currentAngle}deg)`)}_updateActiveSlice(){if(!this._panel||!this._circle)return;const e=Array.from(this._panel.querySelectorAll(this.config.emojiSelector));if(!e.length)return;const t=this._getSectorAngle(e.length);if(!Number.isFinite(t)||t<=0)return;const s=this._getBaseIndex(e.length),i=Math.round(this._currentAngle/t),r=this._wrapIndex(s-i,e.length),a=e[r];a&&a!==this._activeEmoji&&(this._activeEmoji?.classList.remove("panel__sector-emoji--active"),a.classList.add("panel__sector-emoji--active"),this._activeEmoji=a)}_updateCountdown(e){if(!this._countdownNode||!this._state.active)return;const t=Math.max(0,this._state.deadline-e),s=Math.ceil(t/1e3);this._countdownNode.textContent=String(s)}_confirmSelection(e){if(!this._state.active||this._state.committed&&!e)return;const t=this._state.locked?this._state.targetReaction||this._activeEmoji?.textContent?.trim():this._activeEmoji?.textContent?.trim();if(!t){this._state.committed=!1;return}this._state.committed=!0;const s={type:X,reaction:t,messageId:this._state.request?.messageId??null,fingerprint:this._state.request?.fingerprint??null,stageId:this._state.request?.stageId??null,revision:this._state.request?.revision===!0,auto:e===!0||this._state.auto===!0,origin:this._state.origin||null};this.bus?.emit(s),this._teardownOverlay()}_matchesRequest(e){const t=this._state.request;return!(!t||t.messageId!=null&&e.messageId!=null&&Number(t.messageId)!==Number(e.messageId)||t.fingerprint&&e.fingerprint&&t.fingerprint!==e.fingerprint||t.stageId&&e.stageId&&t.stageId!==e.stageId)}_extractCurrentAngle(){if(!this._circle||!this.window?.getComputedStyle)return 0;const e=this.window.getComputedStyle(this._circle),t=e.transform||e.webkitTransform;if(!t||t==="none")return 0;const s=t.match(/matrix\(([^)]+)\)/);if(s){const r=s[1].split(",").map(a=>parseFloat(a.trim()));if(r.length>=2){const a=Math.atan2(r[1],r[0])*(180/Math.PI);return Number.isFinite(a)?a:0}}const i=t.match(/matrix3d\(([^)]+)\)/);if(i){const r=i[1].split(",").map(a=>parseFloat(a.trim()));if(r.length>=4){const a=Math.atan2(r[1],r[0])*(180/Math.PI);return Number.isFinite(a)?a:0}}return 0}_readRotationDuration(){if(!this._circle||!this.window?.getComputedStyle)return 40;const e=this.window.getComputedStyle(this._circle),t=e.getPropertyValue("--rotation-duration");if(t){const i=parseFloat(t);if(Number.isFinite(i)&&i>0)return i}const s=e.animationDuration||"";if(s){const i=s.split(",")[0],r=parseFloat(i);if(Number.isFinite(r)&&r>0)return r}return 40}_normalizeAngle(e){let t=e%360;return t<0&&(t+=360),t}_getSectorAngle(e){if(!e)return 0;const t=this.window?.getComputedStyle?.(this._circle);if(t){const s=t.getPropertyValue("--sector-angle"),i=parseFloat(s);if(Number.isFinite(i)&&i>0)return i}return 360/e}_getBaseIndex(e){return e?Math.floor(e/2):0}_wrapIndex(e,t){if(!t)return 0;let s=e%t;return s<0&&(s+=t),s}_getPointerAngle(e){if(!this._circle)return 0;const t=this._circle.getBoundingClientRect(),s=t.left+t.width/2,i=t.top+t.height/2,r=e.clientX-s,a=e.clientY-i,n=Math.atan2(a,r)*(180/Math.PI);return Number.isFinite(n)?n:0}_now(){return this.window?.performance?.now?.()??Date.now()}}const Wr="SCREEN_CHANGE",pe="dialog__reaction-trigger-icon--ghost-hidden",me="dialog__reaction-trigger--ghost-replay",Ke="panel__circle--ghost-replay",fe="panel__sector-emoji--ghost-target",k="panel__sector-emoji--ghost-scan",zr=1350,Qe=1450,Yr=180,Kr=500,Qr=1200,Xr=240,Xe={en:"Spirit is choosing an emoji",ru:"–î—É—Ö –≤—ã–±–∏—Ä–∞–µ—Ç —ç–º–æ—Ü–∏—é"};class Jr{constructor({bus:e=new v,documentRef:t=typeof document<"u"?document:null,windowRef:s=typeof window<"u"?window:null,panelSelector:i='[data-js="panel-controls"]',dialogSelector:r='[data-js="dialog-list"]',screenService:a=null}={}){this.bus=e,this.document=t,this.window=s,this.panelSelector=i,this.dialogSelector=r,this.screenService=a,this._currentScreen=null,this._lastSystemReaction=null,this._pendingTimer=null,this._revealTimer=null,this._scanTimer=null,this._scanStopTimer=null,this._overlayTimer=null,this._activeIcon=null,this._activeTrigger=null,this._activeSector=null,this._overlayLabel=null,this._circleAnimationBackup=null,this._handler=this._handleEvent.bind(this)}boot(){this.bus?.subscribe(this._handler),this._currentScreen=this._resolveInitialScreen(),this._currentScreen==="messenger"&&this._scheduleReplay()}dispose(){this.bus?.unsubscribe(this._handler),this._clearTimers(),this._teardownVisuals()}_handleEvent(e){if(e){if(e.type===C){this._rememberSystemReaction(e);return}if(e.type===Wr){this._currentScreen=e.screen||null,e.screen==="messenger"?this._scheduleReplay():this._teardownVisuals();return}e.type===oe&&this._currentScreen==="messenger"&&this._scheduleReplay()}}_resolveInitialScreen(){const e=this.screenService?.getActive?.();return e||(this._isMessengerRendered()?"messenger":null)}_isMessengerRendered(){if(!this.document)return!1;const e=this.document.querySelector(this.dialogSelector),t=this.document.querySelector(this.panelSelector);return!!(e&&t)}_rememberSystemReaction(e){const t=this._normalizeReaction(e),s=e.origin||e.reactionOrigin||null,i=e.locked===!0||e.reactionLocked===!0||s==="system";if(!t||!i)return;const r=e.fingerprint||e.message?.fingerprint||null,a=this._normalizeId(e.messageId??e.id??null);this._lastSystemReaction={reaction:t,fingerprint:r,messageId:a}}_normalizeReaction(e){const s=(typeof e.reaction=="string"?e.reaction:typeof e.emoji=="string"?e.emoji:"").trim();return s.length?s:""}_normalizeId(e){if(typeof e=="number"&&!Number.isNaN(e))return e;const t=Number(e);return Number.isNaN(t)?null:t}_scheduleReplay(){this._clearTimers();const e=typeof this.window?.setTimeout=="function"?this.window.setTimeout:setTimeout;this._pendingTimer=e(()=>this._runReplay(),200)}_runReplay(){if(this._pendingTimer=null,this._currentScreen!=="messenger")return;const e=this.document?.querySelector(this.dialogSelector),t=this.document?.querySelector(this.panelSelector);if(!e||!t)return;const s=this._findTargetTrigger(e);if(!s)return;const i=s.querySelector(".dialog__reaction-trigger-icon"),r=i?.textContent?.trim();if(!i||!r)return;this._teardownVisuals(),this._activeTrigger=s,this._activeIcon=i,this._showOverlay(),s.classList.add(me),i.classList.add(pe),this._highlightDrum(t,r);const a=typeof this.window?.setTimeout=="function"?this.window.setTimeout:setTimeout;this._revealTimer=a(()=>this._reveal(t),Qe)}_findTargetTrigger(e){const t=Array.from(e.querySelectorAll('.dialog__reaction-trigger[data-has-reaction="true"]'));if(!t.length)return null;if(this._lastSystemReaction){const s=t.find(i=>{const r=i.dataset.fingerprint||null,a=this._normalizeId(i.dataset.messageId);return this._lastSystemReaction.fingerprint&&r===this._lastSystemReaction.fingerprint||this._lastSystemReaction.messageId!==null&&a===this._lastSystemReaction.messageId});if(s)return s}return t[t.length-1]}_highlightDrum(e,t){const s=e.querySelector(".panel__circle");if(!s)return;this._circleAnimationBackup={manual:s.classList.contains("panel__circle--manual"),animation:s.style.animation,playState:s.style.animationPlayState},s.classList.remove("panel__circle--manual"),s.style.animationPlayState="running",s.style.animation=`ghost-replay-spin ${zr}ms linear 1`,s.offsetWidth,s.classList.add(Ke);const i=Array.from(e.querySelectorAll(".panel__sector-emoji")),r=i.find(a=>a.textContent.trim()===t)||i[0]||null;this._startSectorScan(i,r)}_reveal(e){this._revealTimer=null,this._activeIcon?.classList.remove(pe),this._activeTrigger?.classList.remove(me),this._clearDrum(e),this._activeIcon=null,this._activeTrigger=null,this._hideOverlay()}_clearDrum(e){const t=e||this.document?.querySelector(this.panelSelector);if(!t)return;this._stopSectorScan(t);const s=t.querySelector(".panel__circle");s&&(s.classList.remove(Ke),this._circleAnimationBackup?.manual&&s.classList.add("panel__circle--manual"),s.style.animation=this._circleAnimationBackup?.animation||"",s.style.animationPlayState=this._circleAnimationBackup?.playState||"paused"),t.querySelectorAll(`.${fe}`).forEach(i=>i.classList.remove(fe)),t.querySelectorAll(`.${k}`).forEach(i=>i.classList.remove(k)),this._circleAnimationBackup=null,this._activeSector=null}_clearTimers(){this._clearOverlayTimer(),this._stopSectorScan(),this._pendingTimer&&(clearTimeout(this._pendingTimer),this._pendingTimer=null),this._revealTimer&&(clearTimeout(this._revealTimer),this._revealTimer=null)}_teardownVisuals(){this._clearTimers(),this._activeIcon?.classList.remove(pe),this._activeTrigger?.classList.remove(me),this._activeIcon=null,this._activeTrigger=null,this._hideOverlay(!0),this._clearDrum()}_startSectorScan(e,t){if(!e.length)return;this._stopSectorScan();let s=0;this._scanTimer=setInterval(()=>{const a=e[s%e.length];e.forEach(n=>n.classList.remove(k)),a?.classList.add(k),s+=1},Yr);const i=Math.min(Math.max(Kr,Qe-250),Qr),r=typeof this.window?.setTimeout=="function"?this.window.setTimeout:setTimeout;this._scanStopTimer=r(()=>{this._stopSectorScan(),this._applyTargetHighlight(t)},i)}_applyTargetHighlight(e){e&&(e.classList.add(fe),this._activeSector=e)}_stopSectorScan(e=this.document?.querySelector(this.panelSelector)){this._scanTimer&&(clearInterval(this._scanTimer),this._scanTimer=null),this._scanStopTimer&&(clearTimeout(this._scanStopTimer),this._scanStopTimer=null),e&&e.querySelectorAll(`.${k}`).forEach(t=>t.classList.remove(k))}_showOverlay(e=this._getOverlayMessage()){if(!this.document)return;const t=this.document.querySelector(this.panelSelector);if(!t)return;this._hideOverlay(!0);const s=this.document.createElement("div");s.className="panel__ghost-overlay",s.textContent=e,t.appendChild(s),this._overlayLabel=s;const i=()=>s.classList.add("panel__ghost-overlay--visible");typeof this.window?.requestAnimationFrame=="function"?this.window.requestAnimationFrame(i):this._overlayTimer=setTimeout(i,0)}_hideOverlay(e=!1){if(this._clearOverlayTimer(),!this._overlayLabel)return;const t=this._overlayLabel;if(e){t.remove(),this._overlayLabel=null;return}t.classList.remove("panel__ghost-overlay--visible");const s=typeof this.window?.setTimeout=="function"?this.window.setTimeout:setTimeout;this._overlayTimer=s(()=>{t.remove(),this._overlayLabel=null,this._overlayTimer=null},Xr)}_clearOverlayTimer(){this._overlayTimer&&(clearTimeout(this._overlayTimer),this._overlayTimer=null)}_getOverlayMessage(){const t=(this.document?.documentElement?.lang?.toLowerCase()||this.window?.navigator?.language?.toLowerCase()||"en").slice(0,2);return Xe[t]||Xe.en}}class Zr{constructor(e,t,s=new NullEventBus){this.mediaRepository=e,this.modalService=t,this.bus=s,this._handler=async i=>{i.type===Nt&&await this._open(i.mediaId,i.src)}}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler),this.mediaRepository?.revokeAll()}async _open(e,t){if(!this.modalService)return;let s=!1;if(this.mediaRepository&&e)try{const i=await this.mediaRepository.get(e);if(i?.fullKey){const r=await this.mediaRepository.getObjectURL(i.fullKey);r?.url&&(this.modalService.showFromDataURL(r.url,r.revoke),s=!0)}}catch(i){this.bus.emit?.({type:"log",level:"warn",message:`MediaLightbox: failed to open media ${e}: ${i?.message||i}`})}!s&&typeof t=="string"&&t.trim()!==""&&this.modalService.showFromDataURL(t)}}class ea{constructor(e=document.body,t=new v,s=null){this.root=typeof e=="string"?document.querySelector(e):e,this.bus=t,this.language=s,this.modal=null,this._handler=i=>{i.type===Ie&&this.render(i.node),i.type===ce&&this.hide()}}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler),this.hide()}render(e){this.hide(),this.modal=document.createElement("div"),this.modal.className="modal";const t=document.createElement("div");t.className="modal__content",e&&t.appendChild(e),this.modal.appendChild(t),this.modal.addEventListener("click",s=>{s.target===this.modal&&this.bus.emit({type:ce})}),this.root.appendChild(this.modal),this.language?.applyLanguage(this.modal)}hide(){this.modal&&(this.modal.remove(),this.modal=null)}}class ta{constructor(){this._seen=new Set}register(e={}){const t=e.fingerprint,s=typeof e.id=="number"?e.id:void 0,i=I({ghost:e.ghost||"",stageId:e.stageId||e.stage_id||"",author:e.author||"",type:e.type||"",text:e.text||"",src:e.src||e.media&&(e.media.id||e.media.src)||""});return t&&this._seen.has(t)||s!==void 0&&this._seen.has(`id:${s}`)||i&&this._seen.has(`ck:${i}`)?!1:(t&&this._seen.add(t),s!==void 0&&this._seen.add(`id:${s}`),i&&this._seen.add(`ck:${i}`),!0)}clear(){this._seen.clear()}}class sa{constructor(e,t,s,i=new v,r=null){this.container=typeof e=="string"?document.querySelector(e):e,this.tpl=t,this.language=s,this.bus=i,this.mediaRepository=r;const a=this._resolveDisplayMode(J);this.displayMode=a.mode,this.batchSize=a.batchSize,this._isBatchMode=a.isBatchMode,this.messages=[],this.renderCount=0,this.lastRenderedIndex=0,this.scrollContainer=this.container,this._booted=!1,this._msgSeq=0,this._dedupe=new ta,this._renderLock=Promise.resolve(),this._pendingReactions=new Map,this._noteSelections=new Map,this._scrollListener=()=>{const{scrollTop:n}=this.scrollContainer;n<=0&&this.bus.emit({type:le})},this._handler=async n=>{if(n.type===U){this.container.innerHTML="",this.messages=[],this.renderCount=0,this.lastRenderedIndex=0,this._dedupe.clear(),this.mediaRepository?.revokeAll(),this._noteSelections.clear();return}if(n.type===X){this._applyReaction(n);return}if(n.type===ai){this._markReactionPending(n);return}if(n.type===ve){this._updateFinaleState(n);return}if(n.type===C){const{message:l,type:c,replay:h=!1,...d}=n,p=l??d,u={...p,timestamp:p.timestamp||Date.now(),id:typeof p.id=="number"?p.id:this._msgSeq++,replay:h,reaction:typeof p.reaction=="string"&&p.reaction.trim().length>0?p.reaction:"",reactionOrigin:typeof p.reactionOrigin=="string"&&p.reactionOrigin.trim()!==""?p.reactionOrigin.trim():null,reactionLocked:p.reactionLocked===!0,revisionAllowed:!!p.revisionAllowed,_reactionPending:!!p._reactionPending};if(!this._dedupe.register(u)){if(h){const f=this.messages.findIndex(y=>u.fingerprint&&y.fingerprint===u.fingerprint||y.id===u.id);if(f!==-1){this.messages[f]={...this.messages[f],...u};const y=this.container.children[f];if(y){const b=this._sanitizeUrl(u.avatar),w=b?`<img class="dialog__avatar" src="${b}" alt="avatar" />`:'<div class="dialog__avatar dialog__avatar--placeholder"></div>',x=y.querySelector(".dialog__avatar");x&&(x.outerHTML=w),this._refreshReactionNode(y,this.messages[f])}}}return}const m=this._getLocatorKey(u);!u._reactionPending&&m&&this._pendingReactions.has(m)&&(u._reactionPending=!0,this._pendingReactions.delete(m)),this.messages.push(u),this.messages.sort((f,y)=>(f.order??0)-(y.order??0)||(f.timestamp??0)-(y.timestamp??0)||(f.id??0)-(y.id??0)),await this.renderLatest(),this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight}n.type===le&&await this.renderOlder()}}boot(){this._booted||(this._booted=!0,this.bus.subscribe(this._handler),this.scrollContainer.addEventListener("scroll",this._scrollListener))}dispose(){this._booted&&(this.bus.unsubscribe(this._handler),this.scrollContainer.removeEventListener("scroll",this._scrollListener),this.mediaRepository?.revokeAll(),this.lastRenderedIndex=0,this._noteSelections.clear(),this._booted=!1)}_resolveDisplayMode(e){const t=(e?.chatDisplay?.mode||"").toLowerCase(),s=e?.chatDisplay?.batchSize??e?.chatMessageBatchSize??3,i=Number.isFinite(Number(s))?Number(s):3,r=i>0?i:3,a=t===z.BATCH;return{mode:a?z.BATCH:z.ALL,batchSize:r,isBatchMode:a}}async renderLatest(){return this._renderLock=this._renderLock.then(()=>this._renderLatest()),this._renderLock}async _renderLatest(){this.renderCount=this._isBatchMode?Math.min(this.batchSize,this.messages.length):this.messages.length;const e=this._isBatchMode?Math.max(this.lastRenderedIndex,this.messages.length-this.renderCount):this.lastRenderedIndex;for(let t=e;t<this.messages.length;t++){const s=this.messages[t],i=t>=this.lastRenderedIndex;if(this.bus.emit({type:"log",level:"info",message:`DialogWidget.renderLatest: rendering message ${s.id} (${i?"new":"re-rendered"})`}),!i)continue;const r=s.avatar&&s.avatar.trim()!==""?s.avatar:"placeholder avatar";this.bus.emit({type:"log",level:"info",message:`DialogWidget.renderLatest: avatar for message ${s.id}: ${r}`});const a=await this._toTemplateData(s),n=await this.tpl.render("widgets/dialog-message",a);this.container.insertAdjacentHTML("beforeend",n);const l=this.container.lastElementChild;if(this._initializeNoteBlock(l,s),s._revoke){const c=this.container.lastElementChild?.querySelector(".dialog__image");c&&this._handleImageRevoke(c,s)}await this._animateMessage(l,s,{isReplay:s.replay===!0,isNew:i})}if(this._isBatchMode)for(;this.container.children.length>this.renderCount;)this.container.removeChild(this.container.firstElementChild);this._attachImageListeners(this.container),this._attachYoutubeListeners(this.container),this._attachReactionListeners(this.container),this._attachNoteListeners(this.container),this._attachFinaleListeners(this.container),this.lastRenderedIndex=this.messages.length}async renderOlder(){if(!this._isBatchMode){this.renderCount=this.messages.length,this.lastRenderedIndex=this.messages.length;return}const e=Math.min(this.messages.length,this.renderCount+this.batchSize);if(e===this.renderCount)return;const t=this.messages.length-e,s=this.messages.length-this.renderCount,i=this.messages.slice(t,s),r=this.scrollContainer.scrollHeight;for(const n of[...i].reverse()){this.bus.emit({type:"log",level:"info",message:`DialogWidget.renderOlder: rendering message ${n.id}`});const l=await this._toTemplateData(n),c=await this.tpl.render("widgets/dialog-message",l);this.container.insertAdjacentHTML("afterbegin",c);const h=this.container.firstElementChild;if(this._initializeNoteBlock(h,n),n._revoke){const d=this.container.firstElementChild?.querySelector(".dialog__image");d&&this._handleImageRevoke(d,n)}await this._animateMessage(h,n,{isReplay:!0,isNew:!1})}this.renderCount=e,this._attachImageListeners(this.container),this._attachYoutubeListeners(this.container),this._attachReactionListeners(this.container),this._attachNoteListeners(this.container),this._attachFinaleListeners(this.container);const a=this.scrollContainer.scrollHeight-r;this.scrollContainer.scrollTop+=a,this.lastRenderedIndex=this.messages.length}async _animateMessage(e,t,s={}){e&&typeof this.language?.applyLanguage=="function"&&await this.language.applyLanguage(e)}async _toTemplateData(e){const t=this._sanitizeUrl(e.avatar),s=t?`<img class="dialog__avatar" src="${t}" alt="avatar" />`:'<div class="dialog__avatar dialog__avatar--placeholder"></div>';if(e.type==="image"){const i=await this._buildImageBlock(e);return{author:e.author||"user",messageModifiers:this._buildMessageModifiers(e),avatarBlock:s,imageBlock:i,content:"",reactionBlock:""}}return e.type==="youtube"?{author:e.author||"user",messageModifiers:this._buildMessageModifiers(e),avatarBlock:s,imageBlock:this._buildYoutubeBlock(e),content:this._buildContentBlock(e),reactionBlock:""}:{...e,messageModifiers:this._buildMessageModifiers(e),avatarBlock:s,imageBlock:"",content:this._buildContentBlock(e),reactionBlock:""}}async _buildImageBlock(e){let t=e.src||"";if(!t&&e.media?.id&&this.mediaRepository){const a=await this.mediaRepository.get(e.media.id);if(a?.fullKey||a?.thumbKey){const n=a.fullKey||a.thumbKey,l=await this.mediaRepository.getObjectURL(n);l&&(t=l.url,e._revoke=l.revoke)}else this.bus.emit({type:"log",level:"warn",message:`DialogWidget._toTemplateData: missing media record for id ${e.media.id}`})}if(!t)return"";const s=this._sanitizeUrl(t);if(!s)return"";const i=this._buildReactionBlock(e),r=e.media?.id?` data-media-id="${this._escapeAttr(e.media.id)}"`:"";return`
      <div class="dialog__analysis" data-js="dialog-analysis">
        <img class="dialog__image dialog__analysis-image" src="${s}" alt=""${r} />
        ${i}
      </div>
    `}_buildYoutubeBlock(e){const t=Ut(e.youtubeId,e.videoId,e.youtubeUrl,e.youtube?.id,e.youtube?.src),s=e.youtubeThumb||(t?`https://img.youtube.com/vi/${encodeURIComponent(t)}/hqdefault.jpg`:""),i=e.youtubeAlt||"YouTube thumbnail";if(!t||!s)return"";const r=this._escapeAttr(t),a=this._sanitizeUrl(s);if(!a)return"";const n=this._escapeAttr(i);return`
      <div class="dialog__youtube" data-js="dialog-youtube" data-video-id="${r}">
        <button class="dialog__youtube-thumb" type="button" data-js="dialog-youtube-thumb" data-video-id="${r}">
          <img class="dialog__youtube-image" src="${a}" alt="${n}" />
          <span class="dialog__youtube-play" aria-hidden="true">‚ñ∂</span>
          <span class="sr-only">Play video</span>
        </button>
      </div>
    `}_buildContentBlock(e){if(this._isFinaleMessage(e))return this._buildFinaleBlock(e);const t=typeof e.text=="string"&&e.text.trim()!=="",s=this._buildNoteBlock(e);if(!t&&!s)return"";const i=this._resolveNoteLayout(e,s!==""),r=["dialog__message-content"];i==="inline"&&r.push("dialog__message-content--inline");const a=["dialog__message-text"];i==="inline"&&t&&a.push("dialog__message-text--emoji");const n=t?`<p class="${a.join(" ")}" data-i18n="${e.text}" data-emoji-protocol="true" data-allow-links="true"></p>`:"";return`<div class="${r.join(" ")}">${n}${s}</div>`}_resolveNoteLayout(e,t=!1){return t&&(typeof e.noteLayout=="string"?e.noteLayout.toLowerCase():"")==="inline"?"inline":"stacked"}_buildNoteBlock(e){const t=Array.isArray(e.notes)?e.notes.filter(c=>typeof c=="string"&&c.trim()!==""):[];if(!t.length)return"";const s=this._resolveNoteLayout(e,!0),i=["dialog__message-note"];i.push(s==="inline"?"dialog__message-note--inline":"dialog__message-note--stacked");const r=this._getLocatorKey(e)||"",a=this._escapeAttr(r),n=t.map((c,h)=>`<p class="dialog__message-note-text" data-js="dialog-note-text" data-note-index="${h}" data-i18n="${c}" data-allow-links="true"></p>`).join(""),l=t.length>1?'<button class="dialog__message-note-toggle" type="button" data-js="dialog-note-toggle"><span class="dialog__message-note-toggle-icon" aria-hidden="true">‚Üª</span><span class="sr-only" data-i18n="note_next"></span></button>':"";return`
      <div class="${i.join(" ")}" data-js="dialog-note" data-note-count="${t.length}" data-message-key="${a}">
        <div class="dialog__message-note-body">
          ${n}
        </div>
        ${l}
      </div>
    `}_isFinaleMessage(e){if(!e||typeof e!="object")return!1;const t=e.effects;return!t||typeof t!="object"?!1:t.reactionFinale===!0?!0:typeof t.reactionFinale=="object"}_buildFinaleBlock(e){const t=this._getLocatorKey(e)||"",s=e.stageId||"",i=t?` data-fingerprint="${this._escapeAttr(t)}"`:"",r=s?` data-stage-id="${this._escapeAttr(s)}"`:"",n=typeof e.text=="string"&&e.text.trim()!==""?`<p class="dialog__finale-text" data-i18n="${e.text}" data-allow-links="true"></p>`:"";return`
      <div class="dialog__finale" data-js="dialog-finale"${i}${r}>
        <div class="dialog__finale-body" data-js="dialog-finale-body">
          ${n}
        </div>
      </div>
    `}async _updateFinaleState(e){const t=this._findFinaleNode(e);if(!t)return;const s=t.querySelector('[data-js="dialog-finale-body"]');if(s&&(e.status==="complete"?(s.dataset.state="complete",s.innerHTML=this._renderFinaleComplete(e)):(s.dataset.state="pending",s.innerHTML=this._renderFinalePending(e)),this._attachFinaleListeners(s),typeof this.language?.applyLanguage=="function"))try{await this.language.applyLanguage(s)}catch(i){this.bus.emit({type:"log",level:"warn",message:`DialogWidget._updateFinaleState translation failed: ${i?.message||i}`})}}_findFinaleNode(e){const t=Array.from(this.container.querySelectorAll('[data-js="dialog-finale"]'));if(!t.length)return null;const s=e?.fingerprint||null,i=e?.stageId||null;return t.find(r=>!!(s&&r.dataset.fingerprint===s||!s&&i&&r.dataset.stageId===i))||null}_renderFinalePending(e){const t=e?.promptKey||"",s=e?.buttonKey||"",i=e?.ghostId?` data-ghost-id="${this._escapeAttr(e.ghostId)}"`:"",r=e?.fingerprint?` data-fingerprint="${this._escapeAttr(e.fingerprint)}"`:"",a=t?`<p class="dialog__finale-text" data-i18n="${t}"></p>`:"",n=s?`<span class="dialog__finale-button-label" data-i18n="${s}"></span>`:"";return`
      ${a}
      <button class="dialog__finale-button" type="button" data-js="dialog-finale-recalculate"${i}${r}>
        ${n}
      </button>
    `}_renderFinaleComplete(e){const t=[];if(e?.titleKey&&t.push(`<h3 class="dialog__finale-title" data-i18n="${e.titleKey}"></h3>`),e?.messageKey&&t.push(`<p class="dialog__finale-text" data-i18n="${e.messageKey}"></p>`),e?.imageUrl){const s=this._escapeAttr(e.imageUrl);t.push(`<img class="dialog__finale-image" src="${s}" alt="" />`),e?.imageAltKey&&t.push(`<p class="dialog__finale-image-caption" data-i18n="${e.imageAltKey}"></p>`)}return!t.length&&e?.promptKey&&t.push(`<p class="dialog__finale-text" data-i18n="${e.promptKey}"></p>`),t.join("")}_attachFinaleListeners(e){if(!e)return;e.querySelectorAll('[data-js="dialog-finale-recalculate"]').forEach(s=>{s.dataset.bound!=="true"&&(s.dataset.bound="true",s.addEventListener("click",()=>{const i=s.closest('[data-js="dialog-finale"]'),r=i?.dataset.fingerprint||s.dataset.fingerprint||null,a=i?.dataset.stageId||null,n=s.dataset.ghostId||null;this.bus.emit({type:Ot,ghostId:n,fingerprint:r,stageId:a})}))})}_escapeAttr(e){return e?String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;"):""}_sanitizeUrl(e){if(typeof e!="string")return"";const t=e.trim();if(!t)return"";if(t.startsWith("blob:"))return this._escapeAttr(t);try{const s=new URL(t,typeof window<"u"?window.location.origin:void 0),i=s.protocol.toLowerCase();return i==="http:"||i==="https:"?this._escapeAttr(s.toString()):i==="data:"&&/^data:image\//i.test(t)?this._escapeAttr(t):""}catch{return""}}_initializeNoteBlock(e,t){if(!e)return;const s=e.querySelector('[data-js="dialog-note"]');if(!s)return;const i=Array.from(s.querySelectorAll('[data-js="dialog-note-text"]'));if(!i.length)return;if(!s.dataset.messageKey){const c=this._getLocatorKey(t)||"";c&&(s.dataset.messageKey=c)}const r=s.dataset.messageKey||"",a=r&&this._noteSelections.has(r)?this._noteSelections.get(r):0,n=Number.isInteger(a)&&a>=0&&a<i.length?a:0;this._applyNoteVisibility(s,n);const l=s.querySelector('[data-js="dialog-note-toggle"]');l&&(l.hidden=i.length<=1,typeof this.language?.applyLanguage=="function"&&this.language.applyLanguage(l))}_applyNoteVisibility(e,t){Array.from(e.querySelectorAll('[data-js="dialog-note-text"]')).forEach((i,r)=>{i.hidden=r!==t}),e.dataset.activeIndex=String(t)}_attachNoteListeners(e){e.querySelectorAll('[data-js="dialog-note-toggle"]').forEach(t=>{t.dataset.bound!=="true"&&(t.dataset.bound="true",t.addEventListener("click",()=>{const s=t.closest('[data-js="dialog-note"]');s&&this._cycleNote(s)}))})}_cycleNote(e){const t=Array.from(e.querySelectorAll('[data-js="dialog-note-text"]'));if(t.length<=1)return;const s=Number.parseInt(e.dataset.activeIndex||"0",10),i=Number.isNaN(s)?0:(s+1)%t.length;this._applyNoteVisibility(e,i);const r=e.dataset.messageKey;r&&this._noteSelections.set(r,i)}_handleImageRevoke(e,t){const s=t._revoke,i=a=>typeof globalThis.requestAnimationFrame=="function"?globalThis.requestAnimationFrame(a):setTimeout(a,0),r=()=>{i(()=>{s(),delete t._revoke})};e.addEventListener("load",r,{once:!0}),e.complete&&r()}_attachImageListeners(e){e.querySelectorAll(".dialog__image").forEach(t=>{t.dataset.bound!=="true"&&(t.dataset.bound="true",t.addEventListener("click",()=>{const s=t.dataset.mediaId,i=Number(s),r=t.getAttribute("src")||"";if(!Number.isNaN(i)&&s!==""){this.bus.emit({type:Nt,mediaId:i,src:r});return}if(r){this.bus.emit({type:he,src:r});return}this.bus.emit({type:"log",level:"warn",message:"DialogWidget: unable to open image, missing media source"})}))})}_attachYoutubeListeners(e){e.querySelectorAll('[data-js="dialog-youtube-thumb"]').forEach(t=>{t.dataset.bound!=="true"&&(t.dataset.bound="true",t.addEventListener("click",()=>{const s=t.dataset.videoId||t.closest('[data-js="dialog-youtube"]')?.dataset.videoId;this._openYoutubeModal(s)}))})}_openYoutubeModal(e){if(!e)return;const t=document.createElement("iframe");t.className="dialog__youtube-frame",t.src=`https://www.youtube.com/embed/${encodeURIComponent(e)}?autoplay=1`,t.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",t.allowFullscreen=!0;const s=document.createElement("div");s.className="modal__media modal__media--video",s.appendChild(t);const i=document.createElement("div");i.className="modal__viewer modal__viewer--video",i.appendChild(s),this.bus.emit({type:he,node:i})}_attachReactionListeners(e){e.querySelectorAll(".dialog__reaction-trigger").forEach(t=>{t.dataset.bound!=="true"&&t.dataset.locked!=="true"&&(t.dataset.bound="true",t.addEventListener("click",()=>{if(t.disabled)return;const s=this._getReactionPayload(t),i=t.dataset.hasReaction==="true",r=t.dataset.revisionEnabled==="true";i&&!r||(i&&r&&(s.revision=!0),this.bus.emit({type:Te,...s}))}))})}_buildReactionBlock(e){const t=typeof e.id=="number"?e.id:"",s=e.fingerprint||"",i=e.stageId||"",r=["dialog__reaction-trigger"];e._reactionPending&&r.push("dialog__reaction-trigger--pending");const a=e.reactionLocked===!0||e.reactionOrigin==="system";a&&r.push("dialog__reaction-trigger--locked");const n=typeof e.reaction=="string"&&e.reaction.trim().length>0?e.reaction:"",l=n!=="";l&&r.push("dialog__reaction-trigger--filled");const c=e.revisionAllowed===!0,h=c&&l,d=`data-message-id="${t}"${s?` data-fingerprint="${s}"`:""}${i?` data-stage-id="${i}"`:""}`,p=a?"reaction_locked":l?"reaction_change":"reaction_add",u=a||l&&!c?"disabled":"";return`
      <div class="dialog__reaction" data-js="dialog-reaction" ${d}>
        <button class="${r.join(" ")}" type="button" ${d} data-has-reaction="${l}" data-revision-enabled="${h}" data-allow-revision="${c}" data-locked="${a}" ${u}>
          <span class="sr-only dialog__reaction-trigger-label" data-i18n="${p}"></span>
          <span class="dialog__reaction-trigger-icon" aria-hidden="true">${n||"+"}</span>
        </button>
      </div>
    `}_buildMessageModifiers(e){const t=[];return e.type==="youtube"&&t.push("dialog__message--youtube"),(e.reactionLocked===!0||e.reactionOrigin==="system")&&t.push("dialog__message--reaction-locked"),t.length?` ${t.join(" ")}`:""}_getReactionPayload(e){const t=Number(e.dataset.messageId);return{messageId:Number.isNaN(t)?null:t,fingerprint:e.dataset.fingerprint||null,stageId:e.dataset.stageId||null}}_getLocatorKey(e){const t=e.fingerprint||null;if(t)return`fp:${t}`;const s=typeof e.messageId=="number"&&!Number.isNaN(e.messageId)?e.messageId:typeof e.id=="number"&&!Number.isNaN(e.id)?e.id:null;return s!==null?`id:${s}`:null}_findMessageIndex({messageId:e,fingerprint:t}){return this.messages.findIndex(s=>t&&s.fingerprint?s.fingerprint===t:typeof e=="number"&&!Number.isNaN(e)&&typeof s.id=="number"?s.id===e:!1)}_markReactionPending(e){const s={messageId:typeof e.messageId=="number"?e.messageId:Number(e.messageId),fingerprint:e.fingerprint||null},i=this._findMessageIndex(s);if(i===-1){const r=this._getLocatorKey(s);r&&this._pendingReactions.set(r,!0);return}this._setReactionPending(i,!0)}_applyReaction(e){const s={messageId:typeof e.messageId=="number"?e.messageId:Number(e.messageId),fingerprint:e.fingerprint||null},i=this._findMessageIndex(s);if(i===-1)return;const r=typeof e.emoji=="string"?e.emoji:typeof e.reaction=="string"?e.reaction:"";this.messages[i].reaction=r,this.messages[i].revisionAllowed=e.allowRevision===!0;const a=typeof e.origin=="string"&&e.origin.trim()!==""?e.origin.trim():this.messages[i].reactionOrigin||null,n=e.locked===!0||a==="system"||this.messages[i].reactionLocked===!0;this.messages[i].reactionOrigin=a,this.messages[i].reactionLocked=n,this._setReactionPending(i,!1);const l=this._getLocatorKey({messageId:this.messages[i].id,fingerprint:this.messages[i].fingerprint||null});l&&this._pendingReactions.delete(l)}_setReactionPending(e,t){this.messages[e]&&(this.messages[e]._reactionPending=t,this._updateReactionNode(e))}_updateReactionNode(e){if(!this.container||!this.container.children?.length)return;const t=Math.max(0,this.messages.length-this.container.children.length),s=e-t;if(s<0||s>=this.container.children.length)return;const i=this.container.children[s];i&&this._refreshReactionNode(i,this.messages[e])}_refreshReactionNode(e,t){if(!e)return;const s=e.querySelector(".dialog__reaction-trigger");if(s){s.classList.toggle("dialog__reaction-trigger--pending",!!t._reactionPending);const i=typeof t.reaction=="string"&&t.reaction.trim()!=="",r=t.reactionLocked===!0||t.reactionOrigin==="system";s.classList.toggle("dialog__reaction-trigger--filled",i),s.classList.toggle("dialog__reaction-trigger--locked",r);const a=t.revisionAllowed===!0,n=a&&i;s.dataset.hasReaction=String(i),s.dataset.revisionEnabled=String(n),s.dataset.allowRevision=String(a),s.dataset.locked=String(r),s.disabled=r||i&&!a;const l=s.querySelector(".dialog__reaction-trigger-icon");l&&(l.textContent=i?t.reaction:"+");const c=s.querySelector(".dialog__reaction-trigger-label");if(c){const h=r?"reaction_locked":i?"reaction_change":"reaction_add";c.setAttribute("data-i18n",h),typeof this.language?.applyLanguage=="function"&&this.language.applyLanguage(s)}}}}class ia{constructor(e){this.container=e}render(){this.container&&(this.container.innerHTML=`
      <div data-js="selfie-content-container">
        <div data-js="selfie-content">
          <div data-js="camera-view"></div>
          <div data-js="record-indicator" class="record-indicator" hidden></div>
          <div data-js="detection-status" class="detection-status is-hidden"></div>
          <button data-js="retry-detection" class="retry-detection retry-detection--hidden">‚ñ∂</button>
          <img data-js="selfie-preview" class="selfie-preview" hidden>
          <img data-js="selfie-thumbnail" class="selfie-thumbnail" hidden>
        </div>
      </div>`)}}class ra extends ia{constructor(e,t,s=new v){super(e),this.language=t,this.bus=s,this._handler=async i=>{i.type===Q&&this._handleStatus("searching"),i.type==="CAMERA_STATUS"&&(this._handleStatus(i.status),i.status==="paused"&&this.bus.emit({type:N,screen:"camera"})),i.type===ne&&(await this._onDetected(i.target),this._handleStatus("paused"),this.bus.emit({type:N,screen:"camera"})),i.type===Le&&this._handleStatus("hidden")}}boot(){this.bus.subscribe(this._handler),this._attachRetryHandler()}dispose(){this.bus.unsubscribe(this._handler),this._detachRetryHandler()}_query(e){return this.container?.querySelector(e)}_handleStatus(e){const t=this._query('[data-js="detection-status"]');if(!t)return;if(e==="hidden"){t.classList.add("is-hidden");return}if(e==="checking"||e==="searching"||e==="not_found"){const i={checking:"checking",searching:"searching",not_found:"object_not_found"};t.setAttribute("data-i18n",i[e]||e),this.language?.applyLanguage(t),t.classList.remove("is-hidden")}const s=this._query('[data-js="retry-detection"]');e==="searching"&&s&&s.classList.add("retry-detection--hidden"),e==="paused"&&s&&s.classList.remove("retry-detection--hidden")}async _onDetected(e){const t=this.container?.querySelector("canvas")||document.querySelector("canvas");if(t){const i=document.createElement("canvas");i.width=i.height=100,i.getContext("2d").drawImage(t,0,0,100,100);const r=this._query('[data-js="selfie-thumbnail"]');r&&(r.src=i.toDataURL("image/jpeg"),r.classList.add("selfie-thumbnail--visible"))}const s=this._query('[data-js="detection-status"]');if(s){const i=await this.language?.translate?.(`${e}_detected`);s.textContent=i,s.classList.remove("is-hidden")}}_attachRetryHandler(){const e=this._query('[data-js="retry-detection"]');e&&(this._retryListener=()=>{e.classList.add("retry-detection--hidden"),this.bus.emit({type:"RETRY_DETECTION"})},e.addEventListener("click",this._retryListener))}_detachRetryHandler(){const e=this._query('[data-js="retry-detection"]');e&&this._retryListener&&e.removeEventListener("click",this._retryListener)}}class aa{constructor(e,t){this.container=e,this.languageManager=t}clear(){this.container&&this.container.replaceChildren()}async render(e=[]){if(this.container){this.container.replaceChildren();for(const t of e){const s=document.createElement("div");s.classList.add("messenger__post");const i=document.createElement("p");if(i.classList.add("messenger__post-content"),t?.content){i.setAttribute("data-i18n",t.content);const r=await this.languageManager.translate(t.content,"ui");i.textContent=r}s.appendChild(i),this.container.appendChild(s)}await this.languageManager.applyLanguage(this.container)}}}class na{constructor(e,t){this.container=e,this.languageManager=t}async showLocalMode(){if(!this.container)return;this.container.hidden=!1,this.container.classList.add("location-display--visible");const e="detect_location_local";this.container.setAttribute("data-i18n",e);const t=await this.languageManager.translate(e,"ui");this.container.textContent=t}async showCoordinates(e,t){if(!this.container)return;this.container.hidden=!1,this.container.classList.add("location-display--visible");const s="geo.latitude_label",i="geo.longitude_label",r=await this.languageManager.translate(s,"ui"),a=await this.languageManager.translate(i,"ui");this.container.textContent=`${r}: ${e.toFixed(4)}, ${a}: ${t.toFixed(4)}`,this.container.setAttribute("data-i18n","")}clear(){this.container&&(this.container.hidden=!0,this.container.classList.remove("location-display--visible"),this.container.textContent="",this.container.removeAttribute("data-i18n"))}}class oa{constructor(e,t,s,i=new v,r=null,a=console){this.templateService=e,this.panelService=t,this.languageManager=s,this.bus=i,this.mediaRepository=r,this.logger=a,this.currentScreen=null,this.dialogWidget=null,this.cameraUi=null,this.postsWidget=null,this.locationWidget=null,this._previewRevoke=null,this._registrationInput=null,this._modalNode=null,this._footerRendered=!1,this._handler=this._handleEvent.bind(this)}boot(){this.bus.subscribe(this._handler)}dispose(){this.bus.unsubscribe(this._handler),this._disposeDialog(),this._disposeCamera(),this._teardownRegistration(),this.postsWidget=null,this.locationWidget=null}async _handleEvent(e){switch(e?.type){case ft:await this._renderScreen(e);break;case _t:await this._renderCameraScreen(e);break;case be:await this._renderPosts(e);break;case bt:await this._renderGeo(e);break;case ie:await this._showPreview(e);break;case vt:this._clearPreview();break;case U:case C:case oe:case Pt:case"CAMERA_VIEW_CLOSED":case"SCREEN_CHANGE":this._handleDialogState(e);break;case q:this._handleReset(e);break;case At:this._handleProfileImportRequest();break;case Tt:this._handleProfileExportRequest();break;case It:this._handleProfileExportReady(e);break;case Mt:this._handleProfileTransferFailure(e);break;case Lt:this._handleProfileImportCompleted();break;case St:this._handleResetOptionsRequested();break}}async _renderScreen(e){const{screen:t,payload:s={},view:i={}}=e;if(!t)return;this.currentScreen&&this.currentScreen!==t&&(this.currentScreen==="messenger"&&(this._disposeDialog(),this.postsWidget=null),this.currentScreen==="registration"&&this._teardownRegistration(),this.currentScreen==="apartment-plan"&&t!=="apartment-plan"&&(this.locationWidget=null),(this.currentScreen==="camera"||this.currentScreen==="registration-camera")&&this._disposeCamera());const r=document.querySelector('[data-js="global-content"]');if(await this.templateService.renderSection(r,t,s),this.languageManager.applyLanguage(r),await this.panelService.load({screen:t}),await this._renderFooter(t),t==="messenger"){const a=r.querySelector('[data-js="posts-list"]');this.postsWidget=new aa(a,this.languageManager),await this._renderPosts({posts:i.posts||[]});const n=r.querySelector('[data-js="dialog-list"]');n&&(this._disposeDialog(),this.dialogWidget=new sa(n,this.templateService,this.languageManager,this.bus,this.mediaRepository),await this.dialogWidget.boot(),this._handleDialogState({type:"INIT"}),Promise.resolve().then(()=>this.bus.emit({type:oe})))}else if(t==="registration"){const a=r.querySelector('[data-js="input-name"]');a&&(this._registrationInput=a,a.addEventListener("input",this._handleRegistrationInput),i.registration?.name&&(this._registrationInput.value=i.registration.name));const n=r.querySelector('[data-js="registration-label"]');n&&this.languageManager.applyLanguage(n)}if(t==="apartment-plan"){const a=r.querySelector('[data-js="location-display"]');this.locationWidget=new na(a,this.languageManager)}this.currentScreen=t}async _renderCameraScreen(e){const{screen:t,camera:s={}}=e,{options:i={},panel:r={}}=s,a=document.querySelector('[data-js="global-content"]');await this.templateService.renderSection(a,t);const n=document.querySelector('[data-js="global-content"]'),l=n?.querySelector('[data-js="camera-widget"]');l&&(this._disposeCamera(),this.cameraUi=new ra(l,this.languageManager,this.bus),this.cameraUi.render(),this.cameraUi.boot()),this.languageManager.applyLanguage(n),await this.panelService.load({screen:t,...r}),await this._renderFooter(t);const c=n?.querySelector('[data-js="camera-view"]');c&&this.bus.emit({type:"CAMERA_VIEW_OPENED",container:c,options:i}),this.currentScreen=t}async _renderPosts({posts:e=[]}){this.postsWidget&&await this.postsWidget.render(e)}_teardownRegistration(){this._registrationInput&&(this._registrationInput.removeEventListener("input",this._handleRegistrationInput),this._registrationInput=null)}async _renderGeo({status:e,panel:t}){if(this.locationWidget){if(!e){this.locationWidget.clear();return}e.mode==="local"?await this.locationWidget.showLocalMode():e.mode==="coords"&&e.coords&&await this.locationWidget.showCoordinates(e.coords.lat,e.coords.lng),t&&await this.panelService.load(t)}}async _showPreview({blobUrl:e,avatarUrl:t}){const s=this.cameraUi?.container;if(!s)return;const i=s.querySelector('[data-js="selfie-preview"]'),r=s.querySelector('[data-js="camera-view"]');if(!i)return;let a=t||e;!a&&e===void 0||(this._previewRevoke&&(this._previewRevoke(),this._previewRevoke=null),i.src=a||"",i.hidden=!a,r&&a&&(r.hidden=!0),e&&(this._previewRevoke=()=>URL.revokeObjectURL(e)))}_clearPreview(e=this.cameraUi?.container){const t=e?.querySelector('[data-js="selfie-preview"]'),s=e?.querySelector('[data-js="camera-view"]');t&&(t.src="",t.hidden=!0),s&&(s.hidden=!1),this._previewRevoke&&(this._previewRevoke(),this._previewRevoke=null)}_handleDialogState(){}_handleReset(){this._disposeDialog(),this._disposeCamera(),this._clearPreview(),this.currentScreen=null,this._clearFooter()}async _renderFooter(e){const t=document.querySelector('[data-js="app-footer"]');if(!t)return;const s=!!e;if(t.hidden=!s,!s){this._clearFooter();return}const i=A("images/logo.png");await this.templateService.renderSection(t,"footer",{logoSrc:i}),this.languageManager.applyLanguage(t),this._footerRendered=!0}_clearFooter(){const e=document.querySelector('[data-js="app-footer"]');e&&(e.innerHTML="",e.hidden=!0),this._footerRendered=!1}_disposeDialog(){this.dialogWidget&&(this.dialogWidget.dispose?.(),this.dialogWidget=null)}_disposeCamera(){const e=this.cameraUi?.container||null;this.cameraUi&&(this.bus.emit({type:"CAMERA_VIEW_CLOSED"}),this.cameraUi.dispose?.(),this.cameraUi=null),this._clearPreview(e)}_handleProfileImportRequest(){const e=this._renderTransferModal("import");e&&this._showModal(e)}_handleResetOptionsRequested(){const e=this._renderResetModal();e&&this._showModal(e)}_renderResetModal(){if(typeof document>"u")return null;const e=document.createElement("div");e.className="reset-choice-modal";const t=document.createElement("h2");t.className="reset-choice-modal__title",t.setAttribute("data-i18n","reset_modal_title"),e.appendChild(t);const s=document.createElement("p");s.className="reset-choice-modal__message",s.setAttribute("data-i18n","reset_modal_message"),e.appendChild(s);const i=document.createElement("div");i.className="reset-choice-modal__actions";const r=document.createElement("button");r.type="button",r.className="reset-choice-modal__button reset-choice-modal__button--ghost",r.setAttribute("data-i18n","reset_modal_current");const a=document.createElement("button");a.type="button",a.className="reset-choice-modal__button reset-choice-modal__button--app",a.setAttribute("data-i18n","reset_modal_all");const n=document.createElement("button");n.type="button",n.className="reset-choice-modal__button reset-choice-modal__button--ghost",n.setAttribute("data-i18n","reset_modal_reboot");const l=document.createElement("button");return l.type="button",l.className="reset-choice-modal__button reset-choice-modal__button--cancel",l.setAttribute("data-i18n","reset_modal_cancel"),i.appendChild(r),i.appendChild(n),i.appendChild(a),i.appendChild(l),e.appendChild(i),r.addEventListener("click",()=>{this.bus.emit({type:wt,payload:{source:"modal"}}),this._hideModal()}),a.addEventListener("click",()=>{this.bus.emit({type:ue,payload:{source:"modal"}}),this._hideModal()}),n.addEventListener("click",()=>{this.bus.emit({type:Et,payload:{source:"modal"}}),this._hideModal()}),l.addEventListener("click",()=>{this._hideModal()}),this.languageManager.applyLanguage(e),e}_handleProfileExportRequest(){const e=this._renderTransferModal("export");e&&this._showModal(e)}_handleProfileExportReady(e){this._hideModal();const t=e?.payload?.blob;if(!t){this.logger?.warn?.("Profile export ready without blob payload");return}const i=(e?.payload?.meta||{}).currentGhost||"profile",r=new Date().toISOString().replace(/[:.]/g,"-"),a=t instanceof Blob?t:new Blob([t],{type:"application/octet-stream"}),n=URL.createObjectURL(a),l=document.createElement("a");l.href=n,l.download=`${i}-export-${r}.bin`,document.body.appendChild(l),l.click(),document.body.removeChild(l),setTimeout(()=>URL.revokeObjectURL(n),0),this._showStatus("profile_export_success")}_handleProfileTransferFailure(e){const{operation:t}=e?.payload||{};this.logger?.error?.(`Profile transfer failed: ${t||"unknown"}`),this._showStatus("profile_transfer_error"),this._hideModal()}_handleProfileImportCompleted(){this._showStatus("profile_import_success")}async _showStatus(e){if(this.languageManager?.translate)try{const t=await this.languageManager.translate(e);t&&this.bus.emit({type:Ce,message:t})}catch(t){this.logger?.warn?.(`Failed to translate status ${e}: ${t?.message||t}`)}}_renderTransferModal(e){if(typeof document>"u")return null;const t=document.createElement("div");t.className="profile-transfer";const s=document.createElement("h2");s.className="profile-transfer__title",s.setAttribute("data-i18n",e==="import"?"profile_import_title":"profile_export_title"),t.appendChild(s);const i=document.createElement("p");i.className="profile-transfer__description",i.setAttribute("data-i18n",e==="import"?"profile_import_description":"profile_export_description"),t.appendChild(i);let r=null;if(e==="import"){const g=document.createElement("label");g.className="profile-transfer__field";const m=document.createElement("span");m.setAttribute("data-i18n","profile_import_file_label"),g.appendChild(m),r=document.createElement("input"),r.type="file",r.accept=".bin,.json,.ghost,.profile,.enc",r.className="profile-transfer__input",g.appendChild(r),t.appendChild(g)}const a=document.createElement("label");a.className="profile-transfer__field";const n=document.createElement("span");n.setAttribute("data-i18n",e==="import"?"profile_import_password_label":"profile_export_password_label"),a.appendChild(n);const l=document.createElement("input");l.type="password",l.className="profile-transfer__input",a.appendChild(l),t.appendChild(a);const c=document.createElement("div");c.className="profile-transfer__error",t.appendChild(c);const h=document.createElement("div");h.className="profile-transfer__actions";const d=document.createElement("button");d.className="button",d.type="button",d.setAttribute("data-i18n",e==="import"?"profile_import_confirm":"profile_export_confirm");const p=document.createElement("button");p.className="button button--ghost",p.type="button",p.setAttribute("data-i18n","profile_transfer_cancel"),h.appendChild(d),h.appendChild(p),t.appendChild(h);const u=g=>{if(!g){c.textContent="";return}this.languageManager?.translate?.(g).then(m=>{c.textContent=m||""}).catch(()=>{c.textContent=g})};return d.addEventListener("click",async()=>{if(!d.disabled){if(u(""),e==="import"&&(!r||!r.files?.length)){u("profile_import_file_required");return}d.disabled=!0,d.classList.add("button--disabled");try{if(e==="import"){const g=r.files[0],m=await g.arrayBuffer();this.bus.emit({type:Rt,payload:{name:g.name,buffer:m,password:l.value||""}}),this._hideModal()}else this.bus.emit({type:Ct,payload:{password:l.value||""}})}catch(g){d.disabled=!1,d.classList.remove("button--disabled"),u("profile_transfer_error"),this.logger?.error?.(`Profile transfer dialog failed: ${g?.message||g}`)}}}),p.addEventListener("click",()=>{this._hideModal()}),this.languageManager.applyLanguage(t),t}_showModal(e){e&&(this._modalNode=e,this.bus.emit({type:Ie,node:e}))}_hideModal(){this._modalNode&&(this.bus.emit({type:ce}),this._modalNode=null)}_handleRegistrationInput=e=>{this.bus.emit({type:yt,payload:{value:e.target.value}})}}const Je=o=>o?.quest?.active?{awaits:!0,kind:"camera_capture",targetScreen:"camera"}:o?.dialog?.awaiting==="user"?{awaits:!0,kind:"user_text",targetScreen:"messenger"}:{awaits:!1,kind:null,targetScreen:null};class la{boot(){throw new Error("Method boot must be implemented by view adapters.")}dispose(){throw new Error("Method dispose must be implemented by view adapters.")}}class ca extends la{constructor(e=new v,t=null,s=null,i=ge){super(),this.bus=e,this.historyService=t,this.ghostService=s,this.store=i,this._booted=!1,this._awaiting=Je(this.store.getState()),this._origDispatch=null,this._nextButtonHandler=r=>{if(r.type!=="NEXT_BUTTON_ENABLE")return;const a=document.querySelector('[data-action="next"]');a&&(a.disabled=!r.enabled,a.classList.toggle("button--disabled",!r.enabled))},this._screenHandler=r=>{r.type==="SCREEN_CHANGE"&&r.screen!=="camera"&&this.bus.emit({type:"CAMERA_STATUS",status:"hidden"})}}boot(){this._booted||(this._booted=!0,this.bus.subscribe(this._nextButtonHandler),this.bus.subscribe(this._screenHandler),this._origDispatch=this.store.dispatch.bind(this.store),this.store.dispatch=e=>{const t=this._origDispatch(e);return this._evaluateAwaiting(),t},this._evaluateAwaiting())}dispose(){this._booted&&(this.bus.unsubscribe(this._nextButtonHandler),this.bus.unsubscribe(this._screenHandler),this._origDispatch&&(this.store.dispatch=this._origDispatch,this._origDispatch=null),this._booted=!1)}_evaluateAwaiting(){const e=Je(this.store.getState());if(e.awaits===this._awaiting.awaits&&e.kind===this._awaiting.kind&&e.targetScreen===this._awaiting.targetScreen)return;this._awaiting=e;const t=e.awaits&&e.kind==="user_text"&&e.targetScreen==="messenger",s=e.awaits&&e.kind==="camera_capture"&&e.targetScreen==="camera";this.bus.emit({type:N,button:"post",active:t,screen:"messenger"}),this.bus.emit({type:N,button:"capture-btn",active:s,screen:"camera"})}}class ha{constructor({documentRef:e=null,language:t=null,logger:s=console}={}){this.documentRef=e||(typeof document<"u"?document:null),this.language=t,this.logger=s||console,this.root=null,this.button=null,this._openHandler=null,this._labelKey="open_messenger"}render(){if(!this.documentRef||this.root)return;this._ensureStyles();const e=this.documentRef.createElement("div");e.className="interdead-launcher";const t=this.documentRef.createElement("button");t.type="button",t.className="interdead-launcher__button",t.setAttribute("data-i18n-title",this._labelKey),t.innerHTML=`
      <span class="interdead-launcher__orb" aria-hidden="true"></span>
      <span class="sr-only" data-i18n="${this._labelKey}"></span>
    `,e.appendChild(t),this.documentRef.body.appendChild(e),this.root=e,this.button=t,this.language?.applyLanguage?.(this.root),this._openHandler&&this.button.addEventListener("click",this._openHandler)}onOpen(e){this.button&&this._openHandler&&this.button.removeEventListener("click",this._openHandler),this._openHandler=e,this.button&&e&&this.button.addEventListener("click",e)}setVisible(e){this.root&&this.root.classList.toggle("interdead-launcher--hidden",!e)}setEnabled(e){this.button&&(this.button.disabled=!e,this.button.classList.toggle("interdead-launcher__button--disabled",!e))}setLabelKey(e){if(!e||(this._labelKey=e,!this.button))return;this.button.setAttribute("data-i18n-title",e);const t=this.button.querySelector(".sr-only");t&&t.setAttribute("data-i18n",e),this.language?.applyLanguage?.(this.button)}dispose(){this.button&&this._openHandler&&this.button.removeEventListener("click",this._openHandler),this.root?.remove?.(),this.root=null,this.button=null,this._openHandler=null}_ensureStyles(){if(!this.documentRef)return;const e="interdead-launcher-styles";if(this.documentRef.getElementById(e))return;const t=this.documentRef.createElement("style");t.id=e,t.textContent=`
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .interdead-launcher {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 2147483000;
        pointer-events: auto;
      }
      .interdead-launcher--hidden {
        display: none;
      }
      .interdead-launcher__button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 1px solid rgba(138, 229, 144, 0.8);
        background: radial-gradient(circle at 30% 30%, rgba(138, 229, 144, 0.45), rgba(0, 30, 10, 0.8));
        box-shadow: 0 0 18px rgba(138, 229, 144, 0.4);
        display: grid;
        place-items: center;
        cursor: pointer;
      }
      .interdead-launcher__button--disabled {
        cursor: not-allowed;
        opacity: 0.55;
        filter: grayscale(0.3);
      }
      .interdead-launcher__orb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid rgba(138, 229, 144, 0.9);
        animation: interdead-launcher-pulse 2.2s ease-in-out infinite;
        box-shadow: 0 0 12px rgba(138, 229, 144, 0.6);
      }
      @keyframes interdead-launcher-pulse {
        0%, 100% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.1); opacity: 1; }
      }
      .interdead-launcher-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2147482990;
      }
      .interdead-launcher-modal--visible {
        display: flex;
      }
      .interdead-launcher-modal__content {
        width: min(960px, 92vw);
        height: min(90vh, 720px);
        background: #0b140c;
        border: 1px solid rgba(138, 229, 144, 0.4);
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
        overflow: hidden;
        position: relative;
      }
      .interdead-launcher-modal__iframe {
        border: 0;
        width: 100%;
        height: 100%;
      }
    `,this.documentRef.head?.appendChild(t)}}const da=Object.freeze({showEmojiDrum:!!(J.controlPanel?.showEmojiDrum??!0)}),ua={"landing-buttons":[{template:"button",type:"is-link",action:"next",i18n:"continue",icon:"‚û°Ô∏è"},{template:"language-selector",action:"change-language"}],"registration-buttons":[{template:"import-button",action:"import-profile",i18n:"import",icon:"‚¨áÔ∏è"},{template:"button",type:"is-link",action:"next",disabled:!0,i18n:"next",icon:"‚û°Ô∏è"}],"registration-complete-buttons":[{template:"export-button",action:"export-profile",i18n:"export",icon:"‚¨ÜÔ∏è"},{template:"button",type:"warning",action:"reset-account",i18n:"resetAccount",icon:"‚ôªÔ∏è"},{template:"button",type:"is-success",action:"finish",disabled:!1,i18n:"finish",icon:"‚úÖ"}],"apartment-plan-buttons":[{template:"button",type:"is-link",action:"detect-geo",disabled:!1,i18n:"detect_location",icon:"üìç"},{template:"button",type:"is-link",action:"next",disabled:!0,i18n:"next",icon:"‚û°Ô∏è"}],"selfie-buttons":[{template:"button",action:"finish",disabled:!0,i18n:"finish",icon:"‚úÖ"}],"messenger-buttons":[{template:"button",type:"is-primary",action:"post",i18n:"post",icon:"‚úâÔ∏è"},{template:"button",action:"toggle-camera",i18n:"open_camera",icon:"üì∑"},{template:"button",type:"is-danger",action:"reset-data",i18n:"reset",icon:"‚ôªÔ∏è"}],"camera-buttons":[{template:"button",action:"capture-btn",i18n:"start_analysis",icon:"üîç"},{template:"button",action:"toggle-messenger",i18n:"open_messenger",icon:"üí¨"}],"ghost-switcher-buttons":[{template:"ghost-switcher",action:"switch-ghost",i18n:"select_ghost"}],"scroll-up":[],"scroll-down":[]},ga=()=>(J.chatDisplay?.mode||"").toLowerCase()===z.BATCH?["scroll-up","scroll-down"]:[],pa=()=>{const o=ga();return{welcome:["landing-buttons"],registration:["registration-buttons"],"apartment-plan":["apartment-plan-buttons"],"registration-camera":["selfie-buttons"],camera:["camera-buttons"],messenger:["messenger-buttons","ghost-switcher-buttons",...o],main:[...o]}},ma=pa();class fa{constructor(e){this.context=e}register(){const{container:e,spiritConfigs:t}=this.context;e.register("ChatLauncherWidget",()=>new ha({documentRef:typeof document<"u"?document:null,language:e.resolve("LanguageService"),logger:e.resolve("Logger")}),{priority:52}),e.register("AiLoaderView",()=>new Ur(e.resolve("IEventBus"),e.resolve("LanguageService")),{priority:26}),e.register("StatusWidget",()=>new qr(null,e.resolve("IEventBus")),{priority:27}),e.register("ButtonAdapter",()=>new Fr(e.resolve("IEventBus"),e.resolve("LanguageService")),{priority:59}),e.register("PanelService",()=>new P(e.resolve("TemplateService"),e.resolve("ButtonService"),e.resolve("LanguageService"),ua,ma,e.resolve("ProfileRegistrationService"),e.resolve("StateService"),e.resolve("ButtonStateService"),e.resolve("ButtonVisibilityService"),e.resolve("GhostService"),e.resolve("GhostSwitchService"),t,e.resolve("DualityManager"),e.resolve("ModalService"),e.resolve("IEventBus"),'[data-js="bottom-panel"]',e.resolve("DrumLayoutService"),da.showEmojiDrum),{priority:120,deps:["DrumLayoutService","ModalService"]}),e.register("ReactionOverlayWidget",()=>new Vr({bus:e.resolve("IEventBus"),documentRef:typeof document<"u"?document:null,windowRef:typeof window<"u"?window:null}),{priority:121,deps:["PanelService"]}),e.register("GhostReactionReplayWidget",()=>new Jr({bus:e.resolve("IEventBus"),documentRef:typeof document<"u"?document:null,windowRef:typeof window<"u"?window:null,screenService:e.resolve("ScreenService")}),{priority:122,deps:["PanelService"]}),e.register("ModalWidget",()=>new ea(document.body,e.resolve("IEventBus"),e.resolve("LanguageService")),{priority:146}),e.register("MediaLightbox",()=>{const s=new Zr(e.resolve("MediaRepository"),e.resolve("ModalService"),e.resolve("IEventBus"));return s.boot?.(),s},{priority:147,deps:["ModalWidget"]}),e.register("GlobalViewPresenter",()=>new oa(e.resolve("TemplateService"),e.resolve("PanelService"),e.resolve("LanguageService"),e.resolve("IEventBus"),e.resolve("MediaRepository"),e.resolve("Logger")),{priority:131}),e.register("ViewAdapter",()=>new ca(e.resolve("IEventBus"),e.resolve("DialogHistoryService"),e.resolve("GhostService")),{priority:132}),e.register("Loader",()=>new kr(e.resolve("Logger"),e.resolve("IPersistence"),e.resolve("IEventBus")),{priority:30})}}function _a(){const o=new Yt,e={container:o,config:J,spiritConfigs:it};new Ai(e).register(),new Mi(e).register(),new Nr(e).register(),new fa(e).register();const t=new Qt(o,o.resolve("IEventBus"),o.resolve("Logging"));return o.register("BootManager",()=>t,{priority:0}),{container:o,bootManager:t,eventBus:o.resolve("IEventBus")}}const{container:W}=_a(),ya=W.resolve("EmbeddingModeResolver"),ba=ya.resolve();ba.mode==="launcher"?W.resolve("LauncherBootstrapper").boot().catch(o=>W.resolve("Logger").error(`Launcher boot failed: ${o}`)):W.resolve("FullAppBootstrapper").boot().catch(o=>W.resolve("Logger").error(`Failed boot: ${o}`));

